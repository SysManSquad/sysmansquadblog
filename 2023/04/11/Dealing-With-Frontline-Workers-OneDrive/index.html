<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=keyword content="ConfigMgr Microsoft Intune Windows WinAdmins"><meta name=viewport content="width=device-width"><meta name=description content="A community blog and subsidiary of WinAdmins.io"><link rel="shortcut icon" href=/img/favicon.ico><title>Dealing With Frontline Workers and OneDrive-SysManSquad | Systems Management Squad</title>
<link rel=canonical href=/2023/04/11/Dealing-With-Frontline-Workers-OneDrive/><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://sysmansquad.com/css/custom.css><script src=https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js></script><script src=https://sysmansquad.com/js/jquery.slicknav.js></script><script src=https://sysmansquad.com/js/asd_SlickNav_Mobile.js></script><script src=https://sysmansquad.com/js/clipboard.js></script><script src=https://sysmansquad.com/js/custom.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZR1RSQYX"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XXZR1RSQYX",{anonymize_ip:!1})}</script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sysmansquad.com/83"><meta name=twitter:title content="Dealing With Frontline Workers and OneDrive"><meta name=twitter:description content="OneDrive is an amazing product. It allows you to separate what&rsquo;s important, the data, from the tools used to transform the data,the computer. Your CEOs laptop got dropped in a bathtub? No Problem. Hand them a laptop with Intune & Autopilot and they&rsquo;ll be back up and running within an hour or so WITH all of their files. Despite it&rsquo;s integral part to modern device management it has a few quirks that can make it a difficult product to administrate at times."></head><body class="home blog"><div id=asd-container><div id=top-bar><div class=container><div id=nav-wrapper><ul class=menu id=menu-top-menu><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/>Home</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/about/><span>About</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=https://github.com/SysManSquad><span>GitHub</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/jointhesquad/><span>Join the Squad</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/meetthesquad/><span>Meet the Squad</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=#><span>MORE></span></a><ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/contact/>Contact</a></li></ul></li></ul></div><div id=top-search><a href=# class=search><i class="fa fa-search"></i></a><div class=show-search><form role=search method=get action=https://www.google.com/search id=searchform><input type=search placeholder="Search and hit enter..." name=q id=q title="Search and hit enter...">
<input type=hidden name=sitesearch value=https://sysmansquad.com>
<button type=submit value=Search class=searchbutton></form></div></div><div class=menu id=menu-mobile></div></div></div><header id=header class=noslider><div class=container><div id=logo><h1><a href=https://sysmansquad.com><img src=/img/SysManSquad-HorizontalColor-Logo.png alt="Systems Management Squad"></a></h1></div></div></header><div class=container><div id=content><div id=main class=fullwidth><article class="post type-post status-publish format-standard has-post-thumbnail hentry"><div class=post-header><h1>Dealing With Frontline Workers and OneDrive</h1><p class=p-meta><span class=post-author><a href=/authors/alecw>Alec Weber</a> / </span><span class=post-date>April 11, 2023 </span><span class=post-categories>/ Endpoint Management</span></p></div><div class=post-entry><p><div class=image><figure><a href=Blue-OneDrive-Warning-Icon.png target=_blank><img src=Blue-OneDrive-Warning-Icon.png alt="A picture of the onedrive logo with a warning symbol"></a></figure></div>OneDrive is an amazing product. It allows you to separate what&rsquo;s important, the data, from the tools used to transform the data,the computer.
Your CEOs laptop got dropped in a bathtub? No Problem. Hand them a laptop with Intune & Autopilot and they&rsquo;ll be back up and running within an hour or so WITH all of their files. Despite it&rsquo;s integral part to modern device management it has a few quirks that can make it a difficult product to administrate at times. Today I will be talking about 1 of them.
  <br>  <br>  <br>  </p><h2 id=the-problem-defined>The Problem Defined</h2><ol><li>You have frontline workers who you want to use OneDrive to ease the pain of computer transfers, and perform pseudo backup functionality.</li><li>These frontline may have stretches of limited connectivity.</li><li>Organizationally or otherwise it&rsquo;s not possible to deal with the consequences of a user not having access to files in their desktop or documents folder.</li><li>You can&rsquo;t disable Files on Demand because they need to sync or create a shortcuts to internal Sharepoint sites. Without Files on Demand the whole Sharepoint library will be downloaded</li><li>Training users to pin (&ldquo;Always keep on this device&rdquo;) their files, while the best solution, is not good enough due to #3.</li></ol><p>  <br>  <br>  <br>  </p><h2 id=with-that-said-how-do-we-fix-that>With that Said how do we fix that?</h2><p>As a starting point I came across Florian Salzmann&rsquo;s solution which is to check the Pinned and Unpinned file attributes on all files using attrib.exe and set them if needed.
You can read more about his solution <a href=https://scloud.work/en/onedrive-desktop-offline>here</a>. While this is a perfectly fine solution I&rsquo;ve never been a big fan of wrapping binaries in regex for powershell scripts unless absolutely necessary.
Can we do this in native PowerShell?</p><h3 id=the-dive->The Dive 🤿</h3><p>⚠️ This section is going to be about the discovery process of working with extended attributes, and writing the Proactive Remediation. if all you want is the completed PR skip to the bottom.</p><p>I sought out more or less the same solution but to use native methods to achieve the needed functionality. If setting an attribute threw an error I wanted to be able to make a note of that without having to do additional text processing.
We know that OneDrive pinning is controlled by the Pinned and Unpinned attributes let&rsquo;s explore how to set attributes using PowerShell.
<a href=https://devblogs.microsoft.com/scripting/use-a-powershell-cmdlet-to-work-with-file-attributes/>A bit of background research</a> shows us that file attributes are simply a property on file(<a href="https://learn.microsoft.com/en-us/dotnet/api/system.io.fileinfo?view=netframework-4.8">FileInfo</a>)/Folder(<a href="https://learn.microsoft.com/en-us/dotnet/api/system.io.directoryinfo?view=netframework-4.8">DirectoryInfo</a>) objects that can be returned using <a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-item?view=powershell-5.1">Get-Item</a>.<div class=image><figure><a href=BasicFileAttributesExample.png target=_blank><img src=BasicFileAttributesExample.png alt="A basic example of getting attributes from Get-Item"></a></figure></div>Knowing that, let&rsquo;s create a test environment with a file that is pinned (always keep on this device), a file that is unpinned (free up space) and a file that is neither.<div class=image><figure><a href=ExampleFiles.png target=_blank><img src=ExampleFiles.png alt="picture of test files"></a></figure></div>Let&rsquo;s now try to get the attributes.<div class=image><figure><a href=ExamplePSbefore.png target=_blank><img src=ExamplePSbefore.png alt="Picture of the attributes being weird numbers"></a></figure></div>Well that&rsquo;s a bit unexpected.
Looking back at our <a href=https://devblogs.microsoft.com/scripting/use-a-powershell-cmdlet-to-work-with-file-attributes/>previous research</a> the file attributes are contained in the <a href="https://learn.microsoft.com/en-us/dotnet/api/system.io.fileattributes?view=netframework-4.8">FileAttributes Enum</a><div class=image><figure><a href=FileAttributesEnum.png target=_blank><img src=FileAttributesEnum.png alt="Picture of results of enum get values for system.io.fileattributes"></a></figure></div>There is No Pinned or Unpinned attribute defined. What&rsquo;s going on here?<br>Let&rsquo;s take a step back. What are file attributes anyway?
File attributes are essentially metadata flags that are represented in a bitmask format. You can think of a bitmask as a virtual DIP switch.<div class=image><figure><a href=DIP.png target=_blank><img src=DIP.png alt="picture of DIP Switch"></a></figure></div>Each switch is represented as a power of 2 (2,4,16) (AKA a binary BIT) and as such the entire state can be represented by a single number that is the addition of all switches.<div class=image><figure><a href=attribnum.png target=_blank><img src=attribnum.png alt=exampleofattribints></a></figure></div></p><p><div class=image><figure><a href=AttribTable.png target=_blank><img src=AttribTable.png alt="picture of File Attributes Table from ms learn"></a></figure></div></p><p><code>Archive (32) + ReparsePoint (1024) = 1056</code> or <code>000000000000000000010000100000</code>.
Yet the attributes Pinned or Unpinned are not defined in our FileAttributes Enum. Only some of our virtual DIP switch settings are defined in this class.
After way too much time spent googling, I found some documentation to help us reach our goal.</p><ul><li><a href=https://learn.microsoft.com/en-us/windows/win32/fileio/file-attribute-constants>Our extended attribute definitions</a></li><li><a href=https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/builtin-types/enum#enumeration-types-as-bit-flags>Enumeration types as bit flags</a></li><li><a href=https://ss64.com/ps/syntax-attrib.html>Some powershell examples of attribute manipulation from ss64</a></li></ul><p>Following the enum types documentation, we can create an enum with the [flags] argument.
Let&rsquo;s define our own enum containing all possible attributes and enter this into our PS console:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-25>25</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>[Flags()]
</span></span><span style=display:flex><span>enum FileAttributesEX {
</span></span><span style=display:flex><span>    ReadOnly = 0x00000001
</span></span><span style=display:flex><span>    Hidden = 0x00000002
</span></span><span style=display:flex><span>    System = 0x00000004
</span></span><span style=display:flex><span>    Directory = 0x00000010
</span></span><span style=display:flex><span>    Archive = 0x00000020
</span></span><span style=display:flex><span>    Device = 0x00000040
</span></span><span style=display:flex><span>    Normal = 0x00000080
</span></span><span style=display:flex><span>    Temporary = 0x00000100
</span></span><span style=display:flex><span>    SparseFile = 0x00000200
</span></span><span style=display:flex><span>    ReparsePoint = 0x00000400
</span></span><span style=display:flex><span>    Compressed = 0x00000800
</span></span><span style=display:flex><span>    Offline = 0x00001000
</span></span><span style=display:flex><span>    NotContentIndexed = 0x00002000
</span></span><span style=display:flex><span>    Encrypted = 0x00004000
</span></span><span style=display:flex><span>    IntegrityStream = 0x00008000
</span></span><span style=display:flex><span>    Virtual = 0x00010000
</span></span><span style=display:flex><span>    NoScrubData = 0x00020000
</span></span><span style=display:flex><span>    EA = 0x00040000
</span></span><span style=display:flex><span>    Pinned = 0x00080000
</span></span><span style=display:flex><span>    Unpinned = 0x00100000
</span></span><span style=display:flex><span>    RecallOnOpen = 0x00040000
</span></span><span style=display:flex><span>    RecallOnDataAccess = 0x00400000
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Now when we get our file attributes, let&rsquo;s recast them to our custom enum:<div class=image><figure><a href=FileAttributesEX.png target=_blank><img src=FileAttributesEX.png alt="A picture of attributes not being weird numbers"></a></figure></div>Great!, but why does the Unpinned file have so many attributes? Well to cut to the chase most of these other attributes are attributes OneDrive manages. Offline notates the file is off of disk, RecallOnDataAccess notates that there is a time penalty to opening this file&mldr; After OneDrive picks up on the Pinned/Unpinned it will set/unset these flags as it moves them on or off the disk. These details might be interesting to examine at another time but it&rsquo;s not what we are here for. We just need to set the Pinned and Unpinned attributes and the OneDrive client will take care of the rest.</p><p>How can we do that?</p><p>We can do that by manipulating the bitmask through bitwise operations.</p><ul><li>Bitwise AND or <code>-band</code>: Our comparison operator. By itself on a bitmask of powers of 2, comparison against a power of 2 will always be 0 ( is unset) or the same power ( is set).</li><li>Bitwise OR or <code>-bor</code>: Our on toggle. If an attribute isn&rsquo;t set this will set it. It won&rsquo;t turn an attribute off if it is on.</li><li>Bitwise XOR or <code>-bxor</code>: Our Flip flop operator. If an attribute is on this will turn it off and if it is off it will turn it on.</li><li>Bitwise NOT or <code>-band</code> : Invert our bits, combined with bitwise and this can be a off toggle.</li></ul><p>If your unfamiliar with bitwise operators and would like to learn <em>how</em> they work. I recommend checking out this <a href="https://www.youtube.com/watch?v=igIjGxF2J-w">video</a> by Alex Hyett,
Or watching Ben Eater&rsquo;s <a href="https://www.youtube.com/watch?v=HyznrdDSSGM&amp;list=PLowKtXNTBypGqImE405J2565dvjafglHU">Series</a> on building an 8-bit computer from scratch to learn more about low level programming in general.</p><p>You may be wondering <em>why</em> windows uses bitmasks for file system attributes and it&rsquo;s a matter of efficiency. Bitmask are very efficient in speed and size and this matters when this applies to every single file and folder on the system.</p><p>Let&rsquo;s look at some examples.
First let&rsquo;s explore unsetting the Unpinned attribute.</p><p><div class=image><figure><a href=FileAttributesEXbandbnot.png target=_blank><img src=FileAttributesEXbandbnot.png alt="powershell example of using band and bnot to unset Unpinned"></a></figure></div><div class=image><figure><a href=FileAttributesEXbandandbnot2.png target=_blank><img src=FileAttributesEXbandandbnot2.png alt="powershell example of using band and not again"></a></figure></div></p><p>As you can see from our examples <code>-band</code> and <code>-bnot</code> together <em>only</em> unset an attribute.</p><p>Now let&rsquo;s set the Pinned attribute.<div class=image><figure><a href=FileAttributeEXBor.png target=_blank><img src=FileAttributeEXBor.png alt="powershell example of using bor"></a></figure></div></p><p>As you can see from the example bitwise OR always sets an unset attribute and has no effect on a set attribute.
This is pretty convenient as <code>-band</code>,<code>-bnot</code> and <code>-band</code> are the only operators that we need. We can completely ignore the more troublesome <code>-bxor</code> which would toggle attributes expectantly if we were not careful to check the state ahead of time.</p><h2 id=writing-the-remediation>Writing the Remediation</h2><p>Let&rsquo;s first start with our detection script.</p><p><strong>Step 1:</strong><br>Get the location of the Desktop & Documents folder and make sure KFM is on. If KFM is not on then nothing to do, exit cleanly.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-14>14</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>    <span style=color:teal>$ErrorActionPreference</span> = <span style=color:#d14>&#39;Stop&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic># Get Folder Paths</span>
</span></span><span style=display:flex><span>    <span style=color:teal>$Desktop</span> = <span style=color:#0086b3>Get-Item</span> ([<span style=color:teal>System.Environment</span>]::GetFolderPath(<span style=color:#d14>&#39;Desktop&#39;</span>))
</span></span><span style=display:flex><span>    <span style=color:teal>$Documents</span> = <span style=color:#0086b3>Get-Item</span> ([<span style=color:teal>System.Environment</span>]::GetFolderPath(<span style=color:#d14>&#39;MyDocuments&#39;</span>))
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>if</span> (($null <span style=color:#000;font-weight:700>-eq</span> <span style=color:teal>$Desktop</span>) <span style=color:#000;font-weight:700>-OR</span> ($null <span style=color:#000;font-weight:700>-eq</span> <span style=color:teal>$Documents</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#0086b3>Write-Error</span> <span style=color:#d14>&#34;Could Not Find Desktop Or Documents Folder&#34;</span>
</span></span><span style=display:flex><span>        exit <span style=color:#099>99</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># Verify KFM is On</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># If Documents or Desktop are not in OneDrive then we don&#39;t need to pin them</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>if</span> ((<span style=color:teal>$Desktop</span>.FullName <span style=color:#000;font-weight:700>-notmatch</span> <span style=color:#d14>&#34;OneDrive&#34;</span>) <span style=color:#000;font-weight:700>-OR</span> (<span style=color:teal>$Documents</span>.FullName <span style=color:#000;font-weight:700>-notmatch</span> <span style=color:#d14>&#34;Onedrive&#34;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#0086b3>Write-Output</span> <span style=color:#d14>&#34;NOKFM&#34;</span>
</span></span><span style=display:flex><span>    exit <span style=color:#099>0</span>
</span></span><span style=display:flex><span>} 
</span></span></code></pre></td></tr></table></div></div><p><strong>Step 2:</strong><br>The preconditions have been met so let&rsquo;s define our attribute Enum.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-25>25</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>[Flags()]
</span></span><span style=display:flex><span> enum FileAttributesEX {
</span></span><span style=display:flex><span>     ReadOnly                  = 0x00000001
</span></span><span style=display:flex><span>     Hidden                    = 0x00000002
</span></span><span style=display:flex><span>     System                    = 0x00000004
</span></span><span style=display:flex><span>     Directory                 = 0x00000010
</span></span><span style=display:flex><span>     Archive                   = 0x00000020
</span></span><span style=display:flex><span>     Device                    = 0x00000040
</span></span><span style=display:flex><span>     Normal                    = 0x00000080
</span></span><span style=display:flex><span>     Temporary                 = 0x00000100
</span></span><span style=display:flex><span>     SparseFile                = 0x00000200
</span></span><span style=display:flex><span>     ReparsePoint              = 0x00000400
</span></span><span style=display:flex><span>     Compressed                = 0x00000800
</span></span><span style=display:flex><span>     Offline                   = 0x00001000
</span></span><span style=display:flex><span>     NotContentIndexed         = 0x00002000
</span></span><span style=display:flex><span>     Encrypted                 = 0x00004000
</span></span><span style=display:flex><span>     IntegrityStream           = 0x00008000
</span></span><span style=display:flex><span>     Virtual                   = 0x00010000
</span></span><span style=display:flex><span>     NoScrubData               = 0x00020000
</span></span><span style=display:flex><span>     EA                        = 0x00040000
</span></span><span style=display:flex><span>     Pinned                    = 0x00080000
</span></span><span style=display:flex><span>     Unpinned                  = 0x00100000
</span></span><span style=display:flex><span>     RecallOnOpen              = 0x00040000
</span></span><span style=display:flex><span>     RecallOnDataAccess        = 0x00400000
</span></span><span style=display:flex><span> }
</span></span></code></pre></td></tr></table></div></div><p><strong>Step 3:</strong><br>Let&rsquo;s check if Desktop & Documents are unpinned.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-4>4</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:teal>$DesktopIsPinned</span> = (<span style=color:teal>$Desktop</span>.Attributes <span style=color:#000;font-weight:700>-band</span> [<span style=color:teal>FileAttributesEX</span>]::Pinned) <span style=color:#000;font-weight:700>-eq</span> [<span style=color:teal>FileAttributesEX</span>]::Pinned.Value__
</span></span><span style=display:flex><span><span style=color:teal>$DesktopIsUnPinned</span> = (<span style=color:teal>$Desktop</span>.Attributes <span style=color:#000;font-weight:700>-band</span> [<span style=color:teal>FileAttributesEX</span>]::Unpinned) <span style=color:#000;font-weight:700>-eq</span> [<span style=color:teal>FileAttributesEX</span>]::Unpinned.Value__
</span></span><span style=display:flex><span><span style=color:teal>$DocumentsIsPinned</span> = (<span style=color:teal>$Documents</span>.Attributes <span style=color:#000;font-weight:700>-band</span> [<span style=color:teal>FileAttributesEX</span>]::Pinned) <span style=color:#000;font-weight:700>-eq</span> [<span style=color:teal>FileAttributesEX</span>]::Pinned.Value__
</span></span><span style=display:flex><span><span style=color:teal>$DocumentsUnIsPinned</span> = (<span style=color:teal>$Documents</span>.Attributes <span style=color:#000;font-weight:700>-band</span> [<span style=color:teal>FileAttributesEX</span>]::Unpinned) <span style=color:#000;font-weight:700>-eq</span> [<span style=color:teal>FileAttributesEX</span>]::Unpinned.Value__
</span></span></code></pre></td></tr></table></div></div><p><strong>Step 4:</strong><br>If Desktop and Documents are not pinned/unpinned exit for remediation.
else check for each subfolder/file. If there are any folders/files not pinned/unpinned, exit for remediation.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-20>20</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>if</span> (<span style=color:teal>$DesktopIsPinned</span> <span style=color:#000;font-weight:700>-and</span> <span style=color:teal>$DocumentsIsPinned</span> <span style=color:#000;font-weight:700>-and</span> (<span style=color:#000;font-weight:700>-not</span> (<span style=color:teal>$DesktopIsUnPinned</span> <span style=color:#000;font-weight:700>-or</span> <span style=color:teal>$DocumentsUnIsPinned</span>))) {
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic>#Desktop and Documents are pinned check if Desktop subfolders and files are</span>
</span></span><span style=display:flex><span>    <span style=color:#0086b3>Get-ChildItem</span> <span style=color:teal>$Desktop</span>,<span style=color:teal>$Documents</span> -Recurse | <span style=color:#0086b3>ForEach-Object</span> {
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic># Check if the item is Pinned and/or Unpinned</span>
</span></span><span style=display:flex><span>        <span style=color:teal>$isPinned</span> = [<span style=color:teal>bool</span>]((<span style=color:teal>$_</span>.Attributes <span style=color:#000;font-weight:700>-band</span> [<span style=color:teal>FileAttributesEX</span>]::Pinned) <span style=color:#000;font-weight:700>-eq</span> [<span style=color:teal>FileAttributesEX</span>]::Pinned.Value__)
</span></span><span style=display:flex><span>        <span style=color:teal>$isUnpinned</span> = [<span style=color:teal>bool</span>]((<span style=color:teal>$_</span>.Attributes <span style=color:#000;font-weight:700>-band</span> [<span style=color:teal>FileAttributesEX</span>]::Unpinned) <span style=color:#000;font-weight:700>-eq</span> [<span style=color:teal>FileAttributesEX</span>]::Unpinned.Value__)
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>if</span> ((<span style=color:#000;font-weight:700>-not</span> <span style=color:teal>$isPinned</span>) <span style=color:#000;font-weight:700>-or</span> (<span style=color:teal>$isUnpinned</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#0086b3>Write-Output</span> <span style=color:#d14>&#34;SubFoldersUnpinned&#34;</span>
</span></span><span style=display:flex><span>            exit <span style=color:#099>1</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>            <span style=color:#998;font-style:italic># Got through the gauntlet everything is pinned</span>
</span></span><span style=display:flex><span>            <span style=color:#0086b3>Write-Output</span> <span style=color:#d14>&#34;FoldersPinned&#34;</span>
</span></span><span style=display:flex><span>            exit <span style=color:#099>0</span> 
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#0086b3>Write-Output</span>  <span style=color:#d14>&#34;FoldersUnpinned&#34;</span>
</span></span><span style=display:flex><span>    exit <span style=color:#099>1</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p> <br> <br>Now our Remediation Script:<br> <br> <br><strong>Step 1:</strong><br>So like in our detection script, we will check for KFM and set our attributes.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-29>29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-30>30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-31>31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-32>32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-33>33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-34>34</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:teal>$ErrorActionPreference</span> = <span style=color:#d14>&#39;Stop&#39;</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># Get Folder Paths</span>
</span></span><span style=display:flex><span><span style=color:teal>$Desktop</span> = <span style=color:#0086b3>Get-Item</span> ([<span style=color:teal>System.Environment</span>]::GetFolderPath(<span style=color:#d14>&#39;Desktop&#39;</span>))
</span></span><span style=display:flex><span><span style=color:teal>$Documents</span> = <span style=color:#0086b3>Get-Item</span> ([<span style=color:teal>System.Environment</span>]::GetFolderPath(<span style=color:#d14>&#39;MyDocuments&#39;</span>))
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>if</span> (($null <span style=color:#000;font-weight:700>-eq</span> <span style=color:teal>$Desktop</span>) <span style=color:#000;font-weight:700>-OR</span> ($null <span style=color:#000;font-weight:700>-eq</span> <span style=color:teal>$Documents</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#0086b3>Write-Error</span> <span style=color:#d14>&#34;Could Not Find Desktop Or Documents Folder&#34;</span>
</span></span><span style=display:flex><span>    exit <span style=color:#099>99</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>#Define Attributes</span>
</span></span><span style=display:flex><span>[Flags()]
</span></span><span style=display:flex><span>enum FileAttributesEX {
</span></span><span style=display:flex><span>    ReadOnly = 0x00000001
</span></span><span style=display:flex><span>    Hidden = 0x00000002
</span></span><span style=display:flex><span>    System = 0x00000004
</span></span><span style=display:flex><span>    Directory = 0x00000010
</span></span><span style=display:flex><span>    Archive = 0x00000020
</span></span><span style=display:flex><span>    Device = 0x00000040
</span></span><span style=display:flex><span>    Normal = 0x00000080
</span></span><span style=display:flex><span>    Temporary = 0x00000100
</span></span><span style=display:flex><span>    SparseFile = 0x00000200
</span></span><span style=display:flex><span>    ReparsePoint = 0x00000400
</span></span><span style=display:flex><span>    Compressed = 0x00000800
</span></span><span style=display:flex><span>    Offline = 0x00001000
</span></span><span style=display:flex><span>    NotContentIndexed = 0x00002000
</span></span><span style=display:flex><span>    Encrypted = 0x00004000
</span></span><span style=display:flex><span>    IntegrityStream = 0x00008000
</span></span><span style=display:flex><span>    Virtual = 0x00010000
</span></span><span style=display:flex><span>    NoScrubData = 0x00020000
</span></span><span style=display:flex><span>    EA = 0x00040000
</span></span><span style=display:flex><span>    Pinned = 0x00080000
</span></span><span style=display:flex><span>    Unpinned = 0x00100000
</span></span><span style=display:flex><span>    RecallOnOpen = 0x00040000
</span></span><span style=display:flex><span>    RecallOnDataAccess = 0x00400000
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p> <br><strong>Step 2:</strong><br>Then for each folder: Desktop, Documents. We hold the current folder object in a temporary variable. This is so if we throw an exception we can act on it. The <code>$psitem</code> or <code>$_</code> pipe variable gets overwritten by the exception in a try/catch statement.
We then unset the Unpinned attribute, then set the Pinned attribute.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-12>12</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#998;font-style:italic># Set the Pinned attribute on the Desktop and Documents folders. Unpin if unpinned. Pinned if not Pinned</span>
</span></span><span style=display:flex><span><span style=color:teal>$Desktop</span>, <span style=color:teal>$Documents</span> | <span style=color:#0086b3>ForEach-Object</span> {
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic>#When an exception occurs the Current Pipe Gets overwritten. We need details of the error in our report.</span>
</span></span><span style=display:flex><span>        <span style=color:teal>$CurrentItem</span> = <span style=color:teal>$_</span> 
</span></span><span style=display:flex><span>        <span style=color:teal>$CurrentItem</span>.Attributes = (<span style=color:teal>$CurrentItem</span>.Attributes <span style=color:#000;font-weight:700>-band</span> (<span style=color:#000;font-weight:700>-bnot</span> [<span style=color:teal>FileAttributesEX</span>]::Unpinned)) <span style=color:#000;font-weight:700>-bor</span> [<span style=color:teal>FileAttributesEX</span>]::Pinned
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>Catch</span> {
</span></span><span style=display:flex><span>        <span style=color:#0086b3>Write-Error</span> <span style=color:#d14>&#34;Could Not pin </span>$(<span style=color:teal>$CurrentItem</span>.Name)<span style=color:#d14> root...</span><span style=color:#d14>`n</span><span style=color:teal>$_</span><span style=color:#d14>&#34;</span>
</span></span><span style=display:flex><span>        exit <span style=color:#099>99</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>  <br><strong>Step 3:</strong><br>Since existing subfiles and folders won&rsquo;t inherit the attributes, although new files/folders will, we will need to iterate through each subfolder/file and set them individually.
We want to continue on an error, but throw an error on each file we couldn&rsquo;t process at the end.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-22>22</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span> <span style=color:#998;font-style:italic># Iterate through all items in the Desktop &amp; Documents folder and its subfolders. Files created before the Root folder is pinned will not inherit the PINNED attribute. Hence the need.</span>
</span></span><span style=display:flex><span><span style=color:teal>$ErrorFiles</span> = <span style=color:#0086b3>New-Object</span> System.Collections.ArrayList
</span></span><span style=display:flex><span><span style=color:#0086b3>Get-ChildItem</span> <span style=color:teal>$Desktop</span>.FullName, <span style=color:teal>$Documents</span>.FullName -Recurse | <span style=color:#0086b3>ForEach-Object</span> {
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>try</span> {
</span></span><span style=display:flex><span>        <span style=color:teal>$CurrentItem</span> = <span style=color:teal>$_</span> 
</span></span><span style=display:flex><span>        <span style=color:teal>$CurrentItem</span>.Attributes = (<span style=color:teal>$CurrentItem</span>.Attributes <span style=color:#000;font-weight:700>-band</span> (<span style=color:#000;font-weight:700>-bnot</span> [<span style=color:teal>FileAttributesEX</span>]::Unpinned)) <span style=color:#000;font-weight:700>-bor</span> [<span style=color:teal>FileAttributesEX</span>]::Pinned
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>catch</span> {
</span></span><span style=display:flex><span>        <span style=color:teal>$ErrorFiles</span>.add(<span style=color:teal>$CurrentItem</span>.FullName)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>if</span> (<span style=color:teal>$ErrorFiles</span>.Count <span style=color:#000;font-weight:700>-ne</span> <span style=color:#099>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:teal>$ErrorString</span> = <span style=color:#000;font-weight:700>foreach</span> (<span style=color:teal>$File</span> <span style=color:#000;font-weight:700>in</span> <span style=color:teal>$ErrorFiles</span>) {
</span></span><span style=display:flex><span>        <span style=color:#d14>&#34;</span>$(<span style=color:teal>$File</span>.substring((<span style=color:teal>$env:OneDrive</span>).Length))<span style=color:#d14>`n</span><span style=color:#d14>&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#0086b3>Write-Error</span> <span style=color:#d14>&#34;These files could not be Processed: </span><span style=color:teal>$ErrorString</span><span style=color:#d14>)&#34;</span>  
</span></span><span style=display:flex><span>    exit <span style=color:#099>98</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#0086b3>Write-Output</span> <span style=color:#d14>&#34;Files Pinned Successfully&#34;</span>
</span></span><span style=display:flex><span>    exit <span style=color:#099>0</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>  <br>  </p><h2 id=setting-up-the-pr>Setting up the PR</h2><p>You can get the completed PR from my github <a href=https://github.com/awebie/Intune/tree/main/Proactive%20Remediations/OnedriveDDPinning>here</a>
Let&rsquo;s set it up shall we?<br><strong>Step 1:</strong><br>In the Intune Admin Center navigate to Reports > Endpoint Analytics > Proactive Remediations.<div class=image><figure><a href=EA1.png target=_blank><img src=EA1.png alt="A Picture of the Intune Portal"></a></figure></div><strong>Step 2:</strong><br>Name your PR.<div class=image><figure><a href=EA2.png target=_blank><img src=EA2.png alt="A Picture of the Intune Portal"></a></figure></div><strong>Step 3:</strong><br>Upload the detection and remediation scripts. Be sure to set &ldquo;Run this script using the logged-on credentials&rdquo;.<div class=image><figure><a href=EA3.png target=_blank><img src=EA3.png alt="A Picture of the Intune Portal"></a></figure></div></p><p><strong>Step 4:</strong><br>Setup your assignments. When your setting up your assignments you have a few choices. You could apply this to all users or just your frontline workers, you could apply the PR only once as a gentle suggestion or you can set it hourly and force it.<div class=image><figure><a href=EA4.png target=_blank><img src=EA4.png alt="A Picture of the Intune Portal"></a></figure></div></p><p>That&rsquo;s It! 🙂</p><img src=/authors/alecw/avatar.png alt="Photo of Alec Weber"><br><strong>Alec Weber</strong>
<em>Contributor</em><div><a href=https://www.linkedin.com/in/alec-weber-43a967185><img src=/img/social/linkedin.png></a></div><p>Alec is an Intune engineer with a focus on Azure and automation</p><hr></div><div class=post-share><div class="post-share-box share-comments"></div></div><comments id=comments><script src=https://utteranc.es/client.js repo=SysManSquad/sysmansquadblog issue-term=title label="blog comment" theme=github-light crossorigin=anonymous async></script></comments></article></div></div></div><footer id=footer><div class=container><div id=footer-copyright><p class=copyright>&copy; 2023 WinAdmins - https://sysmansquad.com - Systems Management Squad</a></p></div></div></footer></div></body></html>