<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=keyword content="ConfigMgr Microsoft Intune Windows WinAdmins"><meta name=viewport content="width=device-width"><meta name=description content="A community blog and subsidiary of WinAdmins.io"><link rel="shortcut icon" href=/img/favicon.ico><title>Using PowerShell and Graph to update Azure AD user photos in bulk-SysManSquad | Systems Management Squad</title><link rel=canonical href=/2021/12/03/2021-12-03-using-powershell-and-graph-to-update-azure-ad-user-photos-in-bulk/><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://sysmansquad.com/css/custom.css><script src=https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js></script>
<script src=https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js></script>
<script src=https://sysmansquad.com/js/jquery.slicknav.js></script>
<script src=https://sysmansquad.com/js/asd_SlickNav_Mobile.js></script>
<script src=https://sysmansquad.com/js/custom.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZR1RSQYX"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XXZR1RSQYX",{anonymize_ip:!1})}</script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sysmansquad.com/83"><meta name=twitter:title content="Using PowerShell and Graph to update Azure AD user photos in bulk"><meta name=twitter:description content="Introduction In this post, I’ll give you some background information and show you how to utilize the Microsoft Graph API to bulk update Azure AD user photos. If you’d like to skip the background information and get straight to the nitty-gritty, click here.
Background I work at a private K-12 school in the United States. Like many schools out there, we have scheduled portraits once a year for students and staff."></head><body class="home blog"><div id=asd-container><div id=top-bar><div class=container><div id=nav-wrapper><ul class=menu id=menu-top-menu><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/>Home</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/about/><span>About</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=https://github.com/SysManSquad><span>GitHub</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/jointhesquad/><span>Join the Squad</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/meetthesquad/><span>Meet the Squad</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=#><span>MORE></span></a><ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/contact/>Contact</a></li></ul></li></ul></div><div id=top-search><a href=# class=search><i class="fa fa-search"></i></a><div class=show-search><form role=search method=get action=https://www.google.com/search id=searchform><input type=search placeholder="Search and hit enter..." name=q id=q title="Search and hit enter...">
<input type=hidden name=sitesearch value=https://sysmansquad.com>
<button type=submit value=Search class=searchbutton></form></div></div><div class=menu id=menu-mobile></div></div></div><header id=header class=noslider><div class=container><div id=logo><h1><a href=https://sysmansquad.com><img src=/img/SysManSquad-HorizontalColor-Logo.png alt="Systems Management Squad"></a></h1></div></div></header><div class=container><div id=content><div id=main class=fullwidth><article class="post type-post status-publish format-standard has-post-thumbnail hentry"><div class=post-header><h1>Using PowerShell and Graph to update Azure AD user photos in bulk</h1><p class=p-meta><span class=post-author><a href=/authors/andrew-blackburn>Andrew Blackburn</a> /</span>
<span class=post-date>December 3, 2021</span>
<span class=post-categories>/ Azure</span>
<span class=post-categories>/ Graph</span>
<span class=post-categories>/ Powershell</span>
<span class=post-categories>/ Scripting</span></p></div><div class=post-entry><h2 id=introduction>Introduction</h2><p>In this post, I’ll give you some background information and show you how to utilize the Microsoft Graph API to bulk update Azure AD user photos. If you’d like to skip the background information and get straight to the nitty-gritty, click here.</p><h2 id=background>Background</h2><p>I work at a private K-12 school in the United States. Like many schools out there, we have scheduled portraits once a year for students and staff. Once my department receives the final set of photos from our photographers, we bulk update in a few places.</p><h2 id=where-we-update-our-users-photos>Where we update our user’s photos</h2><ul><li>Azure AD<ul><li>I will be covering the bulk update process for Azure AD in this post</li></ul></li><li>Google Workspace<ul><li>I will cover the bulk update process for Google in another post</li></ul></li><li>Our school information system<ul><li>I am not planning on covering this because there are so many different SIS’s (refer to their documentation, that’s what I did!)</li></ul></li></ul><p>I suspect that this post may not be as useful for organizations who deal with profile photos in one-off scenarios or let their users update their own photos.</p><h2 id=why-not-use-microsofts-own-tools>Why not use Microsoft’s own tools?</h2><p>In our experience, using Set-UserPhoto (Exchange Online cmdlet) to update photos in bulk is really slow… Like painfully slow. Although, these cmdlets are great for one-off changes.</p><h2 id=what-about-third-party-tools>What about third-party tools?</h2><p>I’ve seen some good options that can accomplish this. They usually have a cost associated with them or are part of a larger set of management tools. PowerShell is built into Windows at no additional cost plus you get to feel like Hacker Man.</p><h2 id=what-about-hybrid>What about hybrid?</h2><p><strong>Can’t we just update the jpegPhoto and thumbnailPhoto attributes in AD?</strong></p><p>We’re hybrid and previously used third party tools to update those attributes in bulk. Azure AD Connect does a good job of syncing that data into Azure. However, we’ve noticed the quality is much lower using this method (especially noticeable on high-DPI displays).</p><h2 id=what-about-the-user-account-picture-in-windows>What about the user account picture in Windows?</h2><p><div class=image><figure><a href=Screen-Shot-2021-12-02-at-1.49.35-PM.png target=_blank><img src=Screen-Shot-2021-12-02-at-1.49.35-PM.png alt=Screenshot></a></figure></div></p><p>If you are on Windows 10 (version 1703+) and your devices are AADJ or HAADJ+, user account pictures will pull directly from Azure AD.</p><p>For my use-case, I no longer need to have jpegPhoto or thumbnailPhoto populated on-prem. (I imagine that stopping use of those two attributes may not be feasible for organizations that still use on-prem. SharePoint or Exchange servers and want user photos to show up.)</p><h2 id=recommendations>Recommendations</h2><ul><li>Use photos that are cropped to a 1:1 ratio (ideally 640×640 px)</li><li>If you are in education, lock down your end user’s ability to change their photos (we have some horror stories before we learned that lesson…)<ul><li>CodeTwo has a great article on this <a href=https://www.codetwo.com/admins-blog/prevent-users-from-changing-profile-photos-microsoft-365/>here</a></li><li>In our experience, users may also be able to update their Azure AD photo using the Settings app in Windows<ul><li>We use a Settings Catalog configuration policy in Intune to hide the ‘yourinfo’ page from our students (this is also available via GPO)</li></ul></li></ul></li></ul><h2 id=the-workflow>The workflow</h2><p>Generally, I like to use the following workflow when preparing to upload the photos to Azure AD</p><ol><li>Map all staff and students to their photo in a CSV file<ol><li>The script only needs two columns<ol><li>path – the full path to the photo</li><li>mail – the matching user’s email address</li></ol></li></ol></li><li>Crop photos to 1:1 (640 x 640 px)</li><li>Use the map file with our PowerShell script to upload the photos to Azure AD
The actual script</li></ol><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-15>15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-16>16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-17>17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-18>18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-19>19</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-20>20</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-21>21</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-22>22</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-23>23</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-24>24</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-25>25</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-26>26</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-27>27</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-28>28</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-29>29</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-30>30</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:teal>$TenantId</span> = <span style=color:#d14>&#34;&lt;tenant-id-here&gt;&#34;</span>
</span></span><span style=display:flex><span><span style=color:teal>$ClientId</span> = <span style=color:#d14>&#34;&lt;client-id-here&gt;&#34;</span>
</span></span><span style=display:flex><span><span style=color:teal>$ClientSecret</span> = <span style=color:#d14>&#34;&lt;client-secret-here&gt;&#34;</span>
</span></span><span style=display:flex><span><span style=color:teal>$CsvPath</span> = <span style=color:#d14>&#34;&lt;path-to-csv-here&gt;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:teal>$Body</span> = @{
</span></span><span style=display:flex><span>    <span style=color:#d14>&#39;tenant&#39;</span> = <span style=color:teal>$TenantId</span>
</span></span><span style=display:flex><span>    <span style=color:#d14>&#39;client_id&#39;</span> = <span style=color:teal>$ClientId</span>
</span></span><span style=display:flex><span>    <span style=color:#d14>&#39;scope&#39;</span> = <span style=color:#d14>&#39;https://graph.microsoft.com/.default&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#d14>&#39;client_secret&#39;</span> = <span style=color:teal>$ClientSecret</span>
</span></span><span style=display:flex><span>    <span style=color:#d14>&#39;grant_type&#39;</span> = <span style=color:#d14>&#39;client_credentials&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:teal>$Params</span> = @{
</span></span><span style=display:flex><span>    <span style=color:#d14>&#39;Uri&#39;</span> = <span style=color:#d14>&#34;https://login.microsoftonline.com/$TenantId/oauth2/v2.0/token&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#d14>&#39;Method&#39;</span> = <span style=color:#d14>&#39;Post&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#d14>&#39;Body&#39;</span> = <span style=color:teal>$Body</span>
</span></span><span style=display:flex><span>    <span style=color:#d14>&#39;ContentType&#39;</span> = <span style=color:#d14>&#39;application/x-www-form-urlencoded&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:teal>$AuthResponse</span> = <span style=color:#0086b3>Invoke-RestMethod</span> <span style=color:teal>@Params</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:teal>$Headers</span> = @{
</span></span><span style=display:flex><span>    <span style=color:#d14>&#39;Authorization&#39;</span> = <span style=color:#d14>&#34;Bearer </span>$(<span style=color:teal>$AuthResponse</span>.access_token)<span style=color:#d14>&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0086b3>Import-Csv</span> -Path <span style=color:teal>$CsvPath</span> | <span style=color:#0086b3>ForEach-Object</span> {
</span></span><span style=display:flex><span><span style=color:#0086b3>Invoke-RestMethod</span> -Method Put -Uri <span style=color:#d14>&#34;https://graph.microsoft.com/v1.0/users/</span>$(<span style=color:teal>$_</span>.mail)<span style=color:#d14>/photo/</span><span style=color:#d14>`$</span><span style=color:#d14>value&#34;</span> -Headers <span style=color:teal>$Headers</span> -ContentType <span style=color:#d14>&#34;image/jpeg&#34;</span> -InFile <span style=color:teal>$_</span>.path
</span></span><span style=display:flex><span><span style=color:#0086b3>Write-Host</span> <span style=color:#d14>&#34;Done interacting with Graph API (</span>$(<span style=color:teal>$_</span>.mail)<span style=color:#d14>)&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Here is a play-by-play of the script:</p><ol><li>Connects to MS Graph using an Azure app registration<ol><li>The Azure app registration needs the ‘User.ReadWrite.All’ API permission</li><li>You might be able to re-work the beginning of the script to perform an interactive login</li></ol></li><li>Imports the CSV file we prepared</li><li>The MS Graph API is invoked for each object in the CSV file<ol><li>Authorization is performed</li><li>The photo is Put in the respective user’s Graph endpoint</li></ol></li></ol><h2 id=performing-a-test-run>Performing a test run</h2><p><div class=image><figure><a href=example-run-1024x446.png target=_blank><img src=example-run-1024x446.png alt=Screenshot></a></figure></div></p><p>The script is on the left, the CSV file on the right, and the run window at the bottom. After the script ran, I went to <a href=https://developer.microsoft.com/en-us/graph/graph-explorer>Graph Explorer</a>, an amazing tool from Microsoft, and checked to see if those photos were uploaded to our test user accounts. As you can see below, it worked great!</p><p>Our test middle school student account:</p><p><div class=image><figure><a href=test-ms-student-1024x703.png target=_blank><img src=test-ms-student-1024x703.png alt=Screenshot></a></figure></div></p><p>Our test high school student account:</p><p><div class=image><figure><a href=test-hs-student-1024x693.png target=_blank><img src=test-hs-student-1024x693.png alt=Screenshot></a></figure></div></p><p>Our test staff account:</p><p><div class=image><figure><a href=test-staff-1024x703.png target=_blank><img src=test-staff-1024x703.png alt=Screenshot></a></figure></div></p><p>So, three working test uploads! After some time, we should see those same photos attached to their respective user’s across all of Azure and Microsoft 365. In my experience, the changes propagate to services like Exchange Online in roughly 24-hours.</p><h2 id=closing-thoughts>Closing thoughts</h2><p>It took me several tries to nail the workflow/script down and I would expect this on your end too. Having some test accounts (or even better, a <a href="https://www.youtube.com/watch?v=4x7NDxdEo94">test tenant</a>) and time to play around were the biggest help for me.</p><p>I hope this gets you to a decent starting point when you are bulk uploading photos to Azure AD.</p><img src=/authors/andrew-blackburn/avatar.png alt="Photo of Andrew Blackburn"><br><strong>Andrew Blackburn</strong>
<em>Contributor</em><div><a href=https://twitter.com/blurn><img src=/img/social/twitter.png></a>
<a href=https://www.linkedin.com/in/andrewjblackburn><img src=/img/social/linkedin.png></a></div><p>Andrew is a K-12 technology director from the Atlanta area, focusing on Windows/iOS/macOS endpoint management.</p><hr></div><comments id=comments><script src=https://utteranc.es/client.js repo=SysManSquad/sysmansquadblog issue-term=title label="blog comment" theme=github-light crossorigin=anonymous async></script></comments></article></div></div></div><footer id=footer><div class=container><div id=footer-copyright><p class=copyright>&copy; 2022 WinAdmins - https://sysmansquad.com - Systems Management Squad</a></p></div></div></footer></div></body></html>