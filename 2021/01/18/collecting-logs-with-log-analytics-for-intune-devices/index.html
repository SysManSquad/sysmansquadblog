<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=keyword content="ConfigMgr Microsoft Intune Windows WinAdmins">
<meta name=viewport content="width=device-width">
<meta name=description content="A community blog and subsidiary of WinAdmins.io">
<link rel="shortcut icon" href=/img/favicon.ico>
<title>Collecting Logs with Log Analytics for Intune devices-SysManSquad | Systems Management Squad</title>
<link rel=canonical href=/2021/01/18/collecting-logs-with-log-analytics-for-intune-devices/>
<link rel=stylesheet href=/css/style.css>
<link rel=stylesheet href=https://blog.sysmansquad.com/css/custom.css>
<script src=https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js></script>
<script src=https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js></script>
<script src=https://blog.sysmansquad.com/js/jquery.slicknav.js></script>
<script src=https://blog.sysmansquad.com/js/asd_SlickNav_Mobile.js></script>
<script src=https://blog.sysmansquad.com/js/custom.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZR1RSQYX"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-XXZR1RSQYX',{anonymize_ip:!1})}</script>
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://blog.sysmansquad.com/83">
<meta name=twitter:title content="Collecting Logs with Log Analytics for Intune devices">
<meta name=twitter:description content="Why do I need logs? The purpose of this guide is to configure the collection of Logs in an Intune environment. By default the log analytics you enable in Intune does not give you much information beyond auditing basic things. With this approach we can record any desired log for all of our machines. There is a companion video for this setup https://youtu.be/Uw3GjMnSXbI.
Enabling Log Analytics  Navigate to endpoint.microsoft.com Select Reports Select Diagnostic Settings Select Add Diagnostic setting Select all options under Log Select Send to Log Analytics workspace Select a Log Analytics workspace  You can archive to a storage account to keep data longer    Now that we have the log analytics workspace configured we can configure the Microsoft Monitoring Agent (MMA)">
</head>
<body class="home blog">
<div id=asd-container>
<div id=top-bar>
<div class=container>
<div id=nav-wrapper>
<ul class=menu id=menu-top-menu>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/>Home</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/about/>
<span>About</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=https://github.com/SysManSquad>
<span>GitHub</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/jointhesquad/>
<span>Join the Squad</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/meetthesquad/>
<span>Meet the Squad</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=#>
<span>MORE></span>
</a>
<ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/contact/>Contact</a>
</li>
</ul>
</li>
</ul>
</div>
<div id=top-search>
<a href=# class=search><i class="fa fa-search"></i></a>
<div class=show-search>
<form role=search method=get action=https://www.google.com/search id=searchform>
<input type=search placeholder="Search and hit enter..." name=q id=q title="Search and hit enter...">
<input type=hidden name=sitesearch value=https://blog.sysmansquad.com>
<button type=submit value=Search>
</form>
</div>
</div>
<div class=menu id=menu-mobile></div>
</div>
</div>
<header id=header class=noslider>
<div class=container>
<div id=logo>
<h1><a href=https://blog.sysmansquad.com><img src=/img/SysManSquad-HorizontalColor-Logo.png alt="Systems Management Squad"></a></h1>
</div>
</div>
</header>
<div class=container>
<div id=content>
<div id=main class=fullwidth>
<article class="post type-post status-publish format-standard has-post-thumbnail hentry">
<div class=post-header>
<h1>Collecting Logs with Log Analytics for Intune devices</h1>
<p class=p-meta>
<span class=post-date>January 18, 2021 / </span>
<span class=post-categories>Azure / </span>
<span class=post-categories>Documentation / </span>
<span class=post-categories>Endpoint Management / </span>
<span class=post-categories>General / </span>
<span class=post-categories>How-To / </span>
<span class=post-categories>Intune / </span>
<span class=post-categories>MECM/MEMCM/SCCM / </span>
<span class=post-categories>Microsoft / </span>
<span class=post-categories>Windows / </span>
</p>
</div>
<div class=post-entry>
<h2 id=why-do-i-need-logs>Why do I need logs?</h2>
<p>The purpose of this guide is to configure the collection of Logs in an Intune environment. By default the log analytics you enable in Intune does not give you much information beyond auditing basic things. With this approach we can record any desired log for all of our machines. There is a companion video for this setup <a href=https://youtu.be/Uw3GjMnSXbI>https://youtu.be/Uw3GjMnSXbI</a>.</p>
<h2 id=enabling-log-analytics>Enabling Log Analytics</h2>
<ol>
<li>Navigate to <a href=https://endpoint.microsoft.com/#home>endpoint.microsoft.com</a></li>
<li>Select <strong>Reports</strong></li>
<li>Select <strong>Diagnostic Settings</strong></li>
<li>Select <strong>Add Diagnostic setting</strong></li>
<li>Select all options under <strong>Log</strong></li>
<li>Select <strong>Send to Log Analytics workspace</strong></li>
<li>Select a Log Analytics workspace
<ol>
<li>You can archive to a storage account to keep data longer</li>
</ol>
</li>
</ol>
<p>Now that we have the log analytics workspace configured we can configure the Microsoft Monitoring Agent (MMA)</p>
<h2 id=configuring-the-microsoft-monitoring-agent>Configuring the Microsoft Monitoring Agent</h2>
<ol>
<li>Navigate to <a href=https://portal.azure.com/>portal.azure.com</a></li>
<li>Navigate to your log analytics workspace</li>
<li>Select <strong>Advanced Settings</strong></li>
<li>Select <strong>Data</strong><br>
You can now add any event log you wish to collect. Begin typing a log you wish to collect and it should auto populate. If the log you wish to use does not appear you can type in the full log path and it will be added. I&rsquo;ve included an example of a few logs below, please bare in mind that if the log is not enabled by default you will still need to enable that log separately. </li>
</ol>
<p><div class=image>
<figure>
<a href=image.png target=_blank>
<img src=image.png alt>
</a>
</figure>
</div> </p>
<ol>
<li>Navigate back to your log analytics workspace</li>
<li>Select <strong>Agents management</strong></li>
<li>Copy down the <strong>Workspace ID</strong> and <strong>Primary Key</strong></li>
<li>Select <strong>Download Windows Agent (64bit)</strong></li>
<li>Create a folder and put the <strong>MMA-Setup-AMD64.exe</strong> inside of it</li>
<li>Open command prompt and run <strong>MMA-Setup-AMD64.exe /C</strong> in the directory your install exists<div class=image>
<figure>
<a href=Discord_KkLVtr1Ip4.png target=_blank>
<img src=Discord_KkLVtr1Ip4.png alt>
</a>
</figure>
</div></li>
<li>Extract the contents to your desired folder</li>
<li>Download the repo located <a href=https://github.com/Microsoft/Microsoft-Win32-Content-Prep-Tool>Github-IntuneContentPrep</a></li>
<li>Extract and run the <strong>IntuneWinAppUtil.exe</strong></li>
<li>Specify the <strong>source folder</strong></li>
<li>Specify the <strong>setup file</strong> (Setup.exe)</li>
<li>Specify an <strong>output folder</strong><div class=image>
<figure>
<a href=SQQldCGPu6.png target=_blank>
<img src=SQQldCGPu6.png alt>
</a>
</figure>
</div></li>
</ol>
<h2 id=creating-the-mma-app-deployment>Creating the MMA app deployment</h2>
<ol>
<li>Navigate to <a href=https://endpoint.microsoft.com/#home>endpoint.microsoft.com</a></li>
<li>Select <strong>Apps</strong></li>
<li>Select <strong>Windows</strong></li>
<li>Select <strong>Add</strong></li>
<li>Select <strong>Windows app (Win32)</strong></li>
<li>Select the app package from the output folder you created in the previous steps</li>
<li>Change the following
<ol>
<li>Name : Microsoft Monitoring Agent</li>
<li>Publisher: Microsoft</li>
<li>Logo: Add any logo you&rsquo;d like</li>
</ol>
</li>
<li>Select <strong>Next</strong></li>
<li>Set the install command to: <code>setup.exe /qn NOAPM=0 ADD_OPINSIGHTS_WORKSPACE=1 OPINSIGHTS_WORKSPACE_AZURE_CLOUD_TYPE=0 OPINSIGHTS_WORKSPACE_ID="WORKSPACEID" OPINSIGHTS_WORKSPACE_KEY="KEYSAVED" AcceptEndUserLicenseAgreement=1"</code></li>
<li>Change the <strong>WorkspaceID</strong> and <strong>WorkspaceKey</strong> to the ones you recorded earlier</li>
<li>Paste the same for the uninstall command</li>
<li>Select <strong>Next</strong></li>
<li>Add your Requirements</li>
<li>Select <strong>Next</strong></li>
<li>Manually configure a detection rule</li>
<li>Select <strong>Add</strong></li>
<li>Select <strong>Registry</strong></li>
<li>Key path: <code>Computer\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\HealthService\Parameters\Management Groups\AOI-#YOURWORKSPACEID</code></li>
<li>Change the <strong>#YourWorkspaceID</strong> section to what you recorded earlier</li>
<li>Select <strong>Ok</strong></li>
<li>Select <strong>Next</strong></li>
<li>Select <strong>Next</strong></li>
<li>Add <strong>Assignments</strong></li>
<li>Select <strong>Next</strong></li>
<li>Select <strong>Create</strong></li>
</ol>
<h2 id=checking-the-logs>Checking the logs</h2>
<p>Once the clients receive the agent you should be able to check for a heartbeat immediately in log analytics. I&rsquo;ll show two quick queries we can run as an example.</p>
<ol>
<li>Navigate to <a href=https://portal.azure.com/>portal.azure.com</a></li>
<li>Navigate to your log analytics workspace</li>
<li>Select Logs</li>
<li>In the query section type the following and select <strong>Run</strong>:</li>
</ol>
<p><code>Event&lt;br>| where TimeGenerated > ago(24h)&lt;br>| limit 10</code></p>
<p>This will bring up the last 10 log events that were registered in log analytics, we limit to 10 for testing purposes. Next we will look at querying a specific log and showing a specific set of columns we are interested in.</p>
<p><code>Event</code><br>
<code>| where EventLog == "System"</code><br>
<code>| project TimeGenerated, EventLog, EventLevelName, EventID, RenderedDescription, Computer</code></p>
<p>At this point you have everything configured and are only limited to your querying knowledge!</p>
</div>
<comments id=comments>
<script src=https://utteranc.es/client.js repo=SysManSquad/sysmansquadblog issue-term=title label="blog comment" theme=github-light crossorigin=anonymous async></script>
</comments>
</article>
</div>
</div>
</div>
<footer id=footer>
<div class=container>
<div id=footer-copyright>
<p class=copyright>&copy; 2021 WinAdmins - https://blog.sysmansquad.com - Systems Management Squad</a></p>
</div>
</div>
</footer>
</div>
</body>
</html>