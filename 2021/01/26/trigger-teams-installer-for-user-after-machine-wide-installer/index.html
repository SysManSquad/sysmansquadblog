<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=keyword content="ConfigMgr Microsoft Intune Windows WinAdmins">
<meta name=viewport content="width=device-width">
<meta name=description content="A community blog and subsidiary of WinAdmins.io">
<link rel="shortcut icon" href=/img/favicon.ico>
<title>Trigger Teams Installer for User After Machine Wide Installer-SysManSquad | Systems Management Squad</title>
<link rel=canonical href=/2021/01/26/trigger-teams-installer-for-user-after-machine-wide-installer/>
<link rel=stylesheet href=/css/style.css>
<link rel=stylesheet href=https://blog.sysmansquad.com/css/custom.css>
<script src=https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js></script>
<script src=https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js></script>
<script src=https://blog.sysmansquad.com/js/jquery.slicknav.js></script>
<script src=https://blog.sysmansquad.com/js/asd_SlickNav_Mobile.js></script>
<script src=https://blog.sysmansquad.com/js/custom.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZR1RSQYX"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-XXZR1RSQYX',{anonymize_ip:!1})}</script>
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://blog.sysmansquad.com/83">
<meta name=twitter:title content="Trigger Teams Installer for User After Machine Wide Installer">
<meta name=twitter:description content="Outline  The Problem: Teams Machine Wide Installer finishes… Then… Nothing? What&rsquo;s Going On Here? The Solution: Improve the User Experience Just Give Me The Script - I&rsquo;ll Figure Out the Rest  The Problem: Teams Machine Wide Installer finishes&mldr; Then&mldr; Nothing? Have you or a loved one ever deployed Microsoft Teams in an enterprise environment? Did the users complain? Did project management complain? Management? You?
I&rsquo;m sure someone was not happy about the overall user experience.">
</head>
<body class="home blog">
<div id=asd-container>
<div id=top-bar>
<div class=container>
<div id=nav-wrapper>
<ul class=menu id=menu-top-menu>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/>Home</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/about/>
<span>About</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=https://github.com/SysManSquad>
<span>GitHub</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/jointhesquad/>
<span>Join the Squad</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/meetthesquad/>
<span>Meet the Squad</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=#>
<span>MORE></span>
</a>
<ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/contact/>Contact</a>
</li>
</ul>
</li>
</ul>
</div>
<div id=top-search>
<a href=# class=search><i class="fa fa-search"></i></a>
<div class=show-search>
<form role=search method=get action=https://www.google.com/search id=searchform>
<input type=search placeholder="Search and hit enter..." name=q id=q title="Search and hit enter...">
<input type=hidden name=sitesearch value=https://blog.sysmansquad.com>
<button type=submit value=Search>
</form>
</div>
</div>
<div class=menu id=menu-mobile></div>
</div>
</div>
<header id=header class=noslider>
<div class=container>
<div id=logo>
<h1><a href=https://blog.sysmansquad.com><img src=/img/SysManSquad-HorizontalColor-Logo.png alt="Systems Management Squad"></a></h1>
</div>
</div>
</header>
<div class=container>
<div id=content>
<div id=main class=fullwidth>
<article class="post type-post status-publish format-standard has-post-thumbnail hentry">
<div class=post-header>
<h1>Trigger Teams Installer for User After Machine Wide Installer</h1>
<span class=post-date>January 26, 2021</span>
</div>
<div class=post-entry>
<h3 id=outline>Outline</h3>
<ul>
<li><a href=#The-Problem>The Problem: Teams Machine Wide Installer finishes… Then… Nothing?</a></li>
<li><a href=#Whats-Up>What&rsquo;s Going On Here?</a></li>
<li><a href=#The-Solution>The Solution: Improve the User Experience</a></li>
<li><a href=#The-Script>Just Give Me The Script - I&rsquo;ll Figure Out the Rest</a></li>
</ul>
<h3 id=The-Problem>The Problem: Teams Machine Wide Installer finishes&mldr; Then&mldr; Nothing?</h3>
<p>Have you or a loved one ever deployed Microsoft Teams in an enterprise environment? Did the users complain? Did project management complain? Management? You?</p>
<p>I&rsquo;m sure <strong>someone</strong> was not happy about the overall user experience. In particular when the <a href=https://docs.microsoft.com/en-us/microsoftteams/msi-deployment>Teams Machine Wide installer</a> is finished, and detected by your application management tool of choice <strong>it does&mldr; nothing</strong>. The user is left with a message claiming Teams is &lsquo;<strong>Installed</strong>&rsquo; when clearly it is not.</p>
<p>To solve this we will dig in to&mldr;</p>
<h3 id=Whats-Up>What&rsquo;s Going On Here?</h3>
<p>The Teams Machine Wide installer is not what the user will &lsquo;run&rsquo; on a day-to-day basis. Instead, it stages the binaries in the &lsquo;Program Files (x86)&rsquo; directory, depending on OS Architecture, where each user will call the installer at a later time. By default, every user will have Teams installed in their own user profile the next time they log in once the machine-wide installer is in place. This is pretty well noted by various people on the internet and Microsoft makes a note of it in their docs <a href=https://docs.microsoft.com/en-us/microsoftteams/msi-deployment#pc-installation>here</a>. For some reason, Microsoft states it a bit strangely, &lsquo;Whenever a user signs into a new Windows User Profile&mldr;&rsquo; But really it does not have to be a new user profile. Existing user profiles will receive Teams on their next login as well.</p>
<p>Microsoft is leveraging a <a href=https://docs.microsoft.com/en-us/windows/win32/setupapi/run-and-runonce-registry-keys>Run Key</a> in order to execute a command line every time a user logs in. This key can be seen below.</p>
<p><div class=image>
<figure>
<a href=TeamsRunOnce.png target=_blank>
<img src=TeamsRunOnce.png alt="TeamsMachineWideInstaller registry key under HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run">
</a>
</figure>
</div> %ProgramFiles%\Teams Installer\Teams.exe -checkInstall -source=default</p>
<p>The command which is executed is &lsquo;<strong>%ProgramFiles%\Teams Installer\Teams.exe -checkInstall -source=default</strong>&rsquo;</p>
<p>Keep in mind this falls under the WOW6432Node section of the registry on a 64-Bit operating system. This causes the %ProgramFiles% environment variable to resolve to &lsquo;C:\Program Files (x86)&rsquo; for example. This would change on a 32-Bit operating system accordingly with the registry key falling under HKLM\Software, and the Teams.exe being found under the C:\Program Files' directory.</p>
<p>An interesting note here is a <strong>Run key runs EVERY time a user logs in</strong>. The command found in the registry has a <strong>-checkInstall</strong> parameter. If you run this binary without the -checkInstall parameter you can see it will perform a Teams installation every time, instead of only when not found.</p>
<p>Alright alright, this is <strong>boring</strong>. How do we improve the user experience where Microsoft has failed?</p>
<h3 id=The-Solution>Solution: Improve the User Experience</h3>
<p>As much as I would enjoy writing an essay about how frustrating it is to see many norms of software installation be violated by Microsoft that is not what we are here for! <strong>We care about the users</strong>.</p>
<p>What the user expects is to click &lsquo;<strong>Install</strong>&rsquo; in the software distribution platform of choice, such as Software Center, or the Company Portal and once the installation is complete the software should be available for use on the device. This behavior is implied by the feedback of &lsquo;<strong>Installed</strong>&rsquo; that is presented in the UI.</p>
<h5 id=current-behavior>Current Behavior</h5>
<p>The Teams Machine Wide installer will finish, and the detection of the software will show &lsquo;<strong>Installed</strong>&rsquo; based on the MSI having been found. Unfortunately this is <em>not</em> the software which the user cares about. </p>
<p><div class=image>
<figure>
<a href=Teams-NotFound.png target=_blank>
<img src=Teams-NotFound.png alt>
</a>
</figure>
</div> </p>
<h5 id=the-new-and-improved-experience>The New and Improved Experience!</h5>
<p>&mldr; can be seen below in an excessively long GIF!</p>
<p><div class=image>
<figure>
<a href=0TCMvCmzxY.gif target=_blank>
<img src=0TCMvCmzxY.gif alt>
</a>
</figure>
</div> </p>
<p>This result is achieved by using a <strong>Windows Scheduled Task</strong>. The PowerShell script that generates this task is found below at the <a href=#The-Script>end of the article</a>, and also on <a href=https://github.com/CodyMathis123/CM-Ramblings/blob/master/New-PostTeamsMachineWideInstallScheduledTask.ps1>GitHub</a>.</p>
<p>A scheduled task can be found in Task Scheduler after the script runs as shown below.</p>
<p><div class=image>
<figure>
<a href=Teams-TaskRunning-1.png target=_blank>
<img src=Teams-TaskRunning-1.png alt>
</a>
</figure>
</div> </p>
<p>At a high level the improved experience shown is achieved via the following workflow:</p>
<ul>
<li>Microsoft Teams Machine Wide Installer is executed</li>
<li>Provided <a href=#The-Script>script</a> is executed immediately after the Teams installer which creates the <strong>scheduled task</strong> which is set to execute as &lsquo;<strong>Users</strong>&rsquo;
<ul>
<li>User is currently logged on:
<ul>
<li>The scheduled task will execute as the logged-on user</li>
<li>Teams.exe installer will be launched according to the parameters in the Run key discussed</li>
<li>User will see the Teams installer start and receive the login prompt</li>
<li>The scheduled task will expire and auto-delete itself after 10 minutes</li>
</ul>
</li>
<li>No user is currently logged on:
<ul>
<li>The scheduled task will have no user to execute as and will not trigger</li>
<li>The scheduled task will expire and auto-delete itself after 10 minutes</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This is <strong>not meant to be used as a standalone script</strong> as it is only useful if ran immediately after a Teams Machine Wide Installer executes.</p>
<p>You are welcome to package the script alongside the Teams MSI and run them back to back using any mechanism you&rsquo;d like, whether that be your own cmd file, VB script, PowerShell, PSADT, or any other convoluted mechanism! The end goal is the MSI installs first, and the script runs second.</p>
<h3 id=The-Script>Just Give Me The Script - I&rsquo;ll Figure Out the Rest</h3>
<pre><code>    }
    $false {
        [string]$TeamsMachineInstaller = Get-ItemPropertyValue -Path registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\ -Name TeamsMachineInstaller -ErrorAction Stop
        [string]$Exe = $TeamsMachineInstaller.Substring(0, $TeamsMachineInstaller.IndexOf('.exe') + 4).Trim()
    }
}
[string]$InstallerArgs = $TeamsMachineInstaller.Substring($Exe.Length, $TeamsMachineInstaller.Length - $exe.Length).Trim()
$newScheduledTaskSplat = @{
    Action      = New-ScheduledTaskAction -Execute $Exe -Argument $InstallerArgs
    Description = 'Start the Teams installer for the currently logged on user after a Teams Machine Wide install'
    Settings    = New-ScheduledTaskSettingsSet -Compatibility Vista -AllowStartIfOnBatteries -MultipleInstances IgnoreNew -ExecutionTimeLimit (New-TimeSpan -Hours 1)
    Trigger     = New-ScheduledTaskTrigger -At ($Start = (Get-Date).AddSeconds(5)) -Once
    Principal   = New-ScheduledTaskPrincipal -GroupId 'S-1-5-32-545' -RunLevel Limited
}

$ScheduledTask = New-ScheduledTask @newScheduledTaskSplat
$ScheduledTask.Settings.DeleteExpiredTaskAfter = &quot;PT0S&quot;
$ScheduledTask.Triggers[0].StartBoundary = $Start.ToString(&quot;yyyy-MM-dd'T'HH:mm:ss&quot;)
$ScheduledTask.Triggers[0].EndBoundary = $Start.AddMinutes(10).ToString('s')

Register-ScheduledTask -InputObject $ScheduledTask -TaskName 'Teams User Install - Post Machine Wide Install'
</code></pre>
<p>}</p>
<p><a href=https://twitter.com/CodyMathis123>@CodyMathis123</a></p>
</div>
<comments id=comments>
<script src=https://utteranc.es/client.js repo=SysManSquad/sysmansquadblog issue-term=title label="blog comment" theme=github-light crossorigin=anonymous async></script>
</comments>
</article>
</div>
</div>
</div>
<footer id=footer>
<div class=container>
<div id=footer-copyright>
<p class=copyright>&copy; 2021 WinAdmins - https://blog.sysmansquad.com - Systems Management Squad</a></p>
</div>
</div>
</footer>
</div>
</body>
</html>