<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=keyword content="ConfigMgr Microsoft Intune Windows WinAdmins"><meta name=viewport content="width=device-width"><meta name=description content="A community blog and subsidiary of WinAdmins.io"><link rel="shortcut icon" href=/img/favicon.ico><title>Microsoft Teams Cache, a burden to us all-SysManSquad | Systems Management Squad</title><link rel=canonical href=/2021/11/11/microsoft-teams-cache-a-burden-to-us-all/><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://sysmansquad.com/css/custom.css><script src=https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js></script>
<script src=https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js></script>
<script src=https://sysmansquad.com/js/jquery.slicknav.js></script>
<script src=https://sysmansquad.com/js/asd_SlickNav_Mobile.js></script>
<script src=https://sysmansquad.com/js/clipboard.js></script>
<script src=https://sysmansquad.com/js/custom.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZR1RSQYX"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XXZR1RSQYX",{anonymize_ip:!1})}</script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sysmansquad.com/2021/11/11/microsoft-teams-cache-a-burden-to-us-all/ClearTeamsCache.png"><meta name=twitter:title content="Microsoft Teams Cache, a burden to us all"><meta name=twitter:description content="Microsoft Teams Cache, we&rsquo;ve all been there in the last year and a half. Microsoft Teams is working fine, then it&rsquo;s not. What happened? I restarted Teams and it&rsquo;s still acting weird.
Well, Teams is an interesting app when it comes to its cache. It relies heavily on it. I personally do not know all the ins and outs of the Teams cache, but I too know all too well that it is a pain in the butt when it goes awry."></head><body class="home blog"><div id=asd-container><div id=top-bar><div class=container><div id=nav-wrapper><ul class=menu id=menu-top-menu><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/>Home</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/about/><span>About</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=https://github.com/SysManSquad><span>GitHub</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/jointhesquad/><span>Join the Squad</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/meetthesquad/><span>Meet the Squad</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=#><span>MORE></span></a><ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/contact/>Contact</a></li></ul></li></ul></div><div id=top-search><a href=# class=search><i class="fa fa-search"></i></a><div class=show-search><form role=search method=get action=https://www.google.com/search id=searchform><input type=search placeholder="Search and hit enter..." name=q id=q title="Search and hit enter...">
<input type=hidden name=sitesearch value=https://sysmansquad.com>
<button type=submit value=Search class=searchbutton></form></div></div><div class=menu id=menu-mobile></div></div></div><header id=header class=noslider><div class=container><div id=logo><h1><a href=https://sysmansquad.com><img src=/img/SysManSquad-HorizontalColor-Logo.png alt="Systems Management Squad"></a></h1></div></div></header><div class=container><div id=content><div id=main class=fullwidth><article class="post type-post status-publish format-standard has-post-thumbnail hentry"><div class=post-header><h1>Microsoft Teams Cache, a burden to us all</h1><p class=p-meta><span class=post-author><a href=/authors/beholden-cypress>Beholden Cypress</a> /</span>
<span class=post-date>November 12, 2021</span>
<span class=post-categories>/ Endpoint Management</span></p></div><div class=post-entry><p>Microsoft Teams Cache, we&rsquo;ve all been there in the last year and a half. Microsoft Teams is working fine, then it&rsquo;s not. What happened? I restarted Teams and it&rsquo;s still acting weird.</p><p>Well, Teams is an interesting app when it comes to its cache. It relies heavily on it. I personally do not know all the ins and outs of the Teams cache, but I too know all too well that it is a pain in the butt when it goes awry.</p><p>This leads me to the bread and butter of this blog post. The following is a small script that at the end can be deployed through ConfigMan as a normal application in Software Center, that when run, will clear the Microsoft Teams Cache on a user&rsquo;s computer.</p><h2 id=microsoft-teams-cache-clearing-script>Microsoft Teams Cache Clearing Script</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-14>14</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#998;font-style:italic>#ClearTeamsCache.ps1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0086b3>Write-Output</span> <span style=color:#d14>&#34;Killing Microsoft Teams process&#34;</span>
</span></span><span style=display:flex><span><span style=color:#0086b3>Stop-Process</span> -Name Teams -Force -erroraction <span style=color:#d14>&#39;silentlycontinue&#39;</span>
</span></span><span style=display:flex><span><span style=color:#0086b3>Start-Sleep</span> -seconds <span style=color:#099>5</span>
</span></span><span style=display:flex><span><span style=color:#0086b3>Write-Output</span> <span style=color:#d14>&#34;Killing Microsoft Outlook process&#34;</span>
</span></span><span style=display:flex><span><span style=color:#0086b3>Stop-Process</span> -Name Outlook -Force -erroraction <span style=color:#d14>&#39;silentlycontinue&#39;</span>
</span></span><span style=display:flex><span><span style=color:#0086b3>Start-Sleep</span> -seconds <span style=color:#099>5</span>
</span></span><span style=display:flex><span><span style=color:#0086b3>Write-Output</span> <span style=color:#d14>&#34;Clearing Microsoft Teams Cache&#34;</span>
</span></span><span style=display:flex><span><span style=color:#0086b3>Remove-Item</span> -Path <span style=color:#d14>&#34;</span>$(<span style=color:teal>$env:USERPROFILE</span>)<span style=color:#d14>\Appdata\Roaming\Microsoft\Teams&#34;</span> -Recurse -Force
</span></span><span style=display:flex><span><span style=color:#0086b3>Start-Sleep</span> -seconds <span style=color:#099>5</span>  <span style=color:#998;font-style:italic>#Probably not required, just makes sure all files are deleted before relaunching Teams and Outlook.</span>
</span></span><span style=display:flex><span><span style=color:#0086b3>Write-Output</span> <span style=color:#d14>&#34;Restarting Microsoft Teams and Microsoft Outlook&#34;</span>
</span></span><span style=display:flex><span><span style=color:#0086b3>Start-Process</span> -FilePath <span style=color:#d14>&#34;</span>$(<span style=color:teal>$env:LOCALAPPDATA</span>)<span style=color:#d14>\Microsoft\Teams\Update.exe&#34;</span> -ArgumentList <span style=color:#d14>&#34;--processStart Teams.exe&#34;</span>
</span></span><span style=display:flex><span><span style=color:#0086b3>Start-Process</span> Outlook
</span></span></code></pre></td></tr></table></div></div><p>If you are reading this blog post, then you are probably at least somewhat familiar with PowerShell, but nevertheless, let&rsquo;s just go through this cute little PowerShell script right quick</p><p>Since this is a script where the output will be presented to the user (at least in the way I did it, you can choose to forgo that part if you wish), I have used the <code>Write-Output</code> so the user knows what is happening.</p><p>So this script kills the Teams Process and kills the Outlook process (because Outlook has a Teams plugin). There is a <code>Start-Sleep</code> between them because I have seen weird things where even when you kill the Teams process, it likes to hold on to files for a couple of seconds after the process has ended. All the Start-Sleeps are for is to give a couple of seconds for all the hooks on the files to be closed.</p><p>Once Teams and Outlook are closed, the entire Teams folder located at <code>$($env:USERPROFILE)\Appdata\Roaming\Microsoft\Teams"</code> gets removed from the system. This is not the &ldquo;official&rdquo; way to clear the cache in teams, but this is the most effective way, or what I like to call the &ldquo;big hammer method&rdquo; way.</p><p>It then does another Start-Sleep just to make sure there are no pending hooks in the file system, then it relaunches the Teams process and the Outlook Process.</p><p>Notice the <code>-ArgumentList "--processStart Teams.exe"</code> on the Teams command line. This is extremely important. Without this, Teams will not launch. Also, make sure the p in Process is lower case. Ask me how I know.</p><h2 id=creating-the-executable>Creating the Executable</h2><p>That takes care of the script portion of this blog post. Next, we need to encapsulate this PowerShell script in an EXE. For this, I used a module in PSGallery called <a href=https://www.powershellgallery.com/packages/ps2exe/1.0.4>PS2EXE</a>. This module is so simple to use, it&rsquo;s almost criminal.</p><p>It is literally a simple as:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>PS2EXE <span style=color:#d14>&#34;ClearTeamsCache.ps1&#34;</span> <span style=color:#d14>&#34;ClearTeamsCache.exe&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>That is the simplest form you can do. There are a bunch of other switches you can do to add other information like Company Name, Version, Author, etc.</p><h3 id=caveats>Caveats</h3><p>One caveat to this is that the EXE and the PS1 file <strong>must</strong> remain in the same directory with each other. Think of the EXE as basically a shortcut for the PS1 file, but still functions as a normal EXE.</p><p>The other caveat to keep in mind is that some AV solutions will falsely identify your newly created EXE as malicious since a lot of malware use this same method. From what I have seen, Defender does not detect this as malicious (in my environment at least). I don&rsquo;t know how you could get around this other than add the install location as an exclusion in your AV.</p><h3 id=packaging>Packaging</h3><p>Alright. Once you have your PS1 and your EXE created, now all you need to do is package it up to install it on a computer. You can do this in whichever way you are comfortable, and whichever way ConfigMan or InTune will accept. I am lucky to have access to InstallShield, so I went that way. But you can just as easily use a PowerShell script or a Batch script to install this program and use the EXE version number as your detection method (if you go this way, I highly recommend using the version switch in PS2EXE when creating your EXE).</p><p>Whichever way you decide to package up your EXE and PS1 for install, just make sure it works through ConfigMan and InTune (if you go that route, you can also just stick this in a folder somewhere and create a shortcut for the EXE on your desktop).</p><h2 id=conclusion>Conclusion</h2><p>If you implement this as I have described, when a user runs this, they will be presented with a PowerShell window that says:</p><p><div class=image><figure><a href=ClearTeamsCache.png target=_blank><img src=ClearTeamsCache.png alt="Clear Teams Cache results window"></a><figcaption>Clear Teams Cache results window</figcaption></figure></div></p><p>That should be it. You should now have a fully functioning &ldquo;program&rdquo; to clear the Microsoft Teams Cache on a computer.</p><img src=/authors/beholden-cypress/avatar.png alt="Photo of Beholden Cypress"><br><strong>Beholden Cypress</strong>
<em>Member</em><div></div><p>A contributor</p><hr></div><div class=post-share><div class="post-share-box share-comments"></div></div><comments id=comments><script src=https://utteranc.es/client.js repo=SysManSquad/sysmansquadblog issue-term=title label="blog comment" theme=github-light crossorigin=anonymous async></script></comments></article></div></div></div><footer id=footer><div class=container><div id=footer-copyright><p class=copyright>&copy; 2023 WinAdmins - https://sysmansquad.com - Systems Management Squad</a></p></div></div></footer></div></body></html>