<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=keyword content="ConfigMgr Microsoft Intune Windows WinAdmins"><meta name=viewport content="width=device-width"><meta name=description content="A community blog and subsidiary of WinAdmins.io"><link rel="shortcut icon" href=/img/favicon.ico><title>A Password Expiration Script-SysManSquad | Systems Management Squad</title><link rel=canonical href=/2021/11/23/2021-11-23-a-password-expiration-script/><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://sysmansquad.com/css/custom.css><script src=https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js></script>
<script src=https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js></script>
<script src=https://sysmansquad.com/js/jquery.slicknav.js></script>
<script src=https://sysmansquad.com/js/asd_SlickNav_Mobile.js></script>
<script src=https://sysmansquad.com/js/clipboard.js></script>
<script src=https://sysmansquad.com/js/custom.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZR1RSQYX"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XXZR1RSQYX",{anonymize_ip:!1})}</script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sysmansquad.com/83"><meta name=twitter:title content="A Password Expiration Script"><meta name=twitter:description content="Script Introduction This post will go through the steps required to create and deploy a password expiration script to run daily and send an email to all users whose passwords will expire in a set number of days.
Scheduled tasks are the recommended implementation for this password expiration script. There are probably other ways to implement this script; however, this script targets scheduled tasks in Windows.
1 2 3 4 #Clear any stored errors $error."></head><body class="home blog"><div id=asd-container><div id=top-bar><div class=container><div id=nav-wrapper><ul class=menu id=menu-top-menu><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/>Home</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/about/><span>About</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=https://github.com/SysManSquad><span>GitHub</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/jointhesquad/><span>Join the Squad</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/meetthesquad/><span>Meet the Squad</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=#><span>MORE></span></a><ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/contact/>Contact</a></li></ul></li></ul></div><div id=top-search><a href=# class=search><i class="fa fa-search"></i></a><div class=show-search><form role=search method=get action=https://www.google.com/search id=searchform><input type=search placeholder="Search and hit enter..." name=q id=q title="Search and hit enter...">
<input type=hidden name=sitesearch value=https://sysmansquad.com>
<button type=submit value=Search class=searchbutton></form></div></div><div class=menu id=menu-mobile></div></div></div><header id=header class=noslider><div class=container><div id=logo><h1><a href=https://sysmansquad.com><img src=/img/SysManSquad-HorizontalColor-Logo.png alt="Systems Management Squad"></a></h1></div></div></header><div class=container><div id=content><div id=main class=fullwidth><article class="post type-post status-publish format-standard has-post-thumbnail hentry"><div class=post-header><h1>A Password Expiration Script</h1><p class=p-meta><span class=post-author><a href=/authors/beholden-cypress>Beholden Cypress</a> /</span>
<span class=post-date>November 23, 2021</span>
<span class=post-categories>/ Endpoint Management</span></p></div><div class=post-entry><h2 id=script-introduction>Script Introduction</h2><p>This post will go through the steps required to create and deploy a password expiration script to run daily and send an email to all users whose passwords will expire in a set number of days.</p><p>Scheduled tasks are the recommended implementation for this password expiration script. There are probably other ways to implement this script; however, this script targets scheduled tasks in Windows.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1>1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2>2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3>3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-4>4</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#998;font-style:italic>#Clear any stored errors</span>
</span></span><span style=display:flex><span><span style=color:teal>$error</span>.clear()
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>#Get the current date</span>
</span></span><span style=display:flex><span><span style=color:teal>$CurrentDate</span> = <span style=color:#0086b3>Get-Date</span> -format <span style=color:#d14>&#34;MMMM dd, yyyy&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>At the beginning of this script, there is an <code>$error.clear()</code> command, which will clear any errors in the session. There should be none, but this makes sure of it.</p><p>There is also a variable for the current date at the top of the script as well that will be used later on in the script.</p><h2 id=script-logging>Script Logging</h2><p>Logging is an integral part of script writing, especially with PowerShell, and this script uses the most basic form of logging in PowerShell: transcripts.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1>1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-2>2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-3>3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-4>4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-5>5</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#998;font-style:italic>#Start Log File</span>
</span></span><span style=display:flex><span><span style=color:teal>$VerbosePreference</span> = <span style=color:#d14>&#34;Continue&#34;</span>
</span></span><span style=display:flex><span><span style=color:teal>$LogPath</span> = <span style=color:#d14>&#34;C:\PasswordBot\Logs\</span>$(<span style=color:#0086b3>Get-Date</span> -Format <span style=color:#0086b3>yyyy-MM</span>-dd)<span style=color:#d14>.log&#34;</span>
</span></span><span style=display:flex><span><span style=color:#0086b3>Get-ChildItem</span> <span style=color:#d14>&#34;$LogPath\*.log&#34;</span> | <span style=color:#0086b3>Where-Object</span> LastWriteTime <span style=color:#000;font-weight:700>-LT</span> (<span style=color:#0086b3>Get-Date</span>).AddDays(-10) | <span style=color:#0086b3>Remove-Item</span> -Confirm<span style=color:#a61717;background-color:#e3d2d2>:</span><span style=color:teal>$false</span>
</span></span><span style=display:flex><span><span style=color:#0086b3>Start-Transcript</span> -Path <span style=color:teal>$LogPath</span> -Append
</span></span></code></pre></td></tr></table></div></div><p>The first part of this log has the variable $VerbosePreference being equal to Continue. This script does not use any verbose logging in its current state; however, if it were modified to include verbose logging, it would already be set up to do so.</p><p>The second variable here is the $LogPath variable. This variable contains the file path and file name for the log file(s). In its current state, the log file gets generated anew everyday with the current date. Following the $LogPath variable is a command to search the log directory and delete any ten-days or older log files.</p><p>Once set up, the Start-Transcript command runs with the arguments -Path and -Append. The $LogPath variable gets passed to the -Path argument, and the -Append gets used if the script has to be run more than once per day.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1>1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-2>2</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:teal>$MailSender</span> = <span style=color:#d14>&#39;Company Name Password Bot &lt;PassBot@companyname.com&gt;&#39;</span>
</span></span><span style=display:flex><span><span style=color:teal>$SMTPServer</span> = <span style=color:#d14>&#39;emailrelay.companyname.com&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=active-directory-and-wmi-query>Active Directory and WMI Query</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-14>14</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#000;font-weight:700>try</span> {
</span></span><span style=display:flex><span>    <span style=color:teal>$users</span> = <span style=color:#0086b3>Get-ADUser</span> -filter {Enabled <span style=color:#000;font-weight:700>-eq</span> <span style=color:teal>$True</span> <span style=color:#000;font-weight:700>-and</span> PasswordNeverExpires <span style=color:#000;font-weight:700>-eq</span> <span style=color:teal>$False</span> <span style=color:#000;font-weight:700>-and</span> PasswordLastSet <span style=color:#000;font-weight:700>-gt</span> 0} -Properties <span style=color:#d14>&#34;SamAccountName&#34;</span>, <span style=color:#d14>&#34;EmailAddress&#34;</span>, <span style=color:#d14>&#34;msDS-UserPasswordExpiryTimeComputed&#34;</span> | <span style=color:#0086b3>Select-Object</span> -Property <span style=color:#d14>&#34;SamAccountName&#34;</span>, <span style=color:#d14>&#34;EmailAddress&#34;</span>, @{Name = <span style=color:#d14>&#34;PasswordExpiry&#34;</span>; Expression = {<span style=color:teal>[datetime]</span>::FromFileTime(<span style=color:teal>$_</span>.<span style=color:#d14>&#34;msDS-UserPasswordExpiryTimeComputed&#34;</span>)}} | <span style=color:#0086b3>Where-Object</span> {<span style=color:teal>$_</span>.EmailAddress} -ErrorAction Stop
</span></span><span style=display:flex><span>    <span style=color:teal>$AuthDC</span> = <span style=color:#0086b3>Get-WMIObject</span> Win32_NTDomain | <span style=color:#0086b3>Select-Object</span> <span style=color:#d14>&#34;DomainControllerName&#34;</span> | <span style=color:#0086b3>Format-Table</span> -HideTableHeaders | <span style=color:#0086b3>Out-String</span> -ErrorAction Stop
</span></span><span style=display:flex><span>    <span style=color:#0086b3>Write-Host</span> <span style=color:#d14>&#39;AD Query Success&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#0086b3>Write-Host</span> <span style=color:#d14>&#34;Machine authenticated to </span>$(<span style=color:teal>$AuthDC</span>)<span style=color:#d14>&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>catch</span> {
</span></span><span style=display:flex><span>    <span style=color:#0086b3>Write-Host</span> <span style=color:#d14>&#39;AD Query failed&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:teal>$error</span>
</span></span><span style=display:flex><span>    <span style=color:#0086b3>Write-Host</span> <span style=color:#d14>&#34;Script failed to run on </span>$(<span style=color:teal>$CurrentDate</span>)<span style=color:#d14>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:teal>$errorString</span> = <span style=color:teal>$error</span> | <span style=color:#0086b3>Out-String</span>
</span></span><span style=display:flex><span>    <span style=color:#0086b3>Send-MailMessage</span> -To <span style=color:#d14>&#39;techSupport@companyname.com&#39;</span> -From <span style=color:teal>$MailSender</span> -Subject <span style=color:#d14>&#39;The Password Bot has failed with an error&#39;</span> -SmtpServer <span style=color:teal>$SMTPServer</span> -Body <span style=color:teal>$errorString</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>break</span>
</span></span><span style=display:flex><span>    }
</span></span></code></pre></td></tr></table></div></div><p>The <code>$users</code> variable gets populated by a command that queries AD for all users who do not have “password does not expire” selected and omits any AD accounts that do not have an email address associated with it. The query pulls down the SamAccountName, EmailAddress, and msDS-UserPasswordExpiryTimeComputed with an alias of “Password Expiry.”</p><p>The following command queries WMI to determine the domain controller the machine is authenticating to and adds it to the <code>$AuthDC</code> variable.</p><p>A couple of Write-Host commands write to the log that the AD query succeeded and displays which DC the machine has authenticated.</p><p>The AD query and WMI query outlined above get encapsulated in a Try and Catch. This action is for error handling in the script.</p><p>Both the AD query and the WMI query have <code>-errorAction Stop</code> associated with them. If either of these actions were to fail, the error would force the script to go down to the catch part of the try and catch. If an error were to occur, it posts to the log that the query failed and writes when the error happened. The script will also send the error message to the email address outlined in the Send-MailMessage cmdlet. The break command at the end of the try-catch will cause the script to jump straight to the end of the script.</p><p>More Script Variables</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-15>15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-16>16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-17>17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-18>18</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#998;font-style:italic># Warning Date Variables</span>
</span></span><span style=display:flex><span><span style=color:teal>$FourteenDayWarnDate</span> = (<span style=color:#0086b3>Get-Date</span>).AddDays(14).ToLongDateString().ToUpper()
</span></span><span style=display:flex><span><span style=color:teal>$TenDayWarnDate</span> = (<span style=color:#0086b3>Get-Date</span>).AddDays(10).ToLongDateString().ToUpper()
</span></span><span style=display:flex><span><span style=color:teal>$FiveDayWarnDate</span> = (<span style=color:#0086b3>Get-Date</span>).AddDays(5).ToLongDateString().ToUpper()
</span></span><span style=display:flex><span><span style=color:teal>$FourDayWarnDate</span> = (<span style=color:#0086b3>Get-Date</span>).AddDays(4).ToLongDateString().ToUpper()
</span></span><span style=display:flex><span><span style=color:teal>$ThreeDayWarnDate</span> = (<span style=color:#0086b3>Get-Date</span>).AddDays(3).ToLongDateString().ToUpper()
</span></span><span style=display:flex><span><span style=color:teal>$TwoDayWarnDate</span> = (<span style=color:#0086b3>Get-Date</span>).AddDays(2).ToLongDateString().ToUpper()
</span></span><span style=display:flex><span><span style=color:teal>$OneDayWarnDate</span> = (<span style=color:#0086b3>Get-Date</span>).AddDays(1).ToLongDateString().ToUpper()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>#Variables for image location</span>
</span></span><span style=display:flex><span><span style=color:teal>$Image1</span> = <span style=color:#d14>&#39;C:\PasswordBot\Images\1.png&#39;</span>
</span></span><span style=display:flex><span><span style=color:teal>$Image2</span> = <span style=color:#d14>&#39;C:\PasswordBot\Images\2.png&#39;</span>
</span></span><span style=display:flex><span><span style=color:teal>$Image3</span> = <span style=color:#d14>&#39;C:\PasswordBot\Images\3.png&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>#Convert images to base64 to embed into the HTML code.</span>
</span></span><span style=display:flex><span><span style=color:teal>$Image1AsBase64</span> = <span style=color:#d14>&#39;&lt;img src=&#34;data:image/png;base64,&#39;</span>+<span style=color:teal>[convert]</span>::ToBase64String((<span style=color:#0086b3>get-content</span> <span style=color:teal>$Image1</span> -encoding byte))+<span style=color:#d14>&#39;&#34;&gt;&#39;</span>
</span></span><span style=display:flex><span><span style=color:teal>$Image2AsBase64</span> = <span style=color:#d14>&#39;&lt;img src=&#34;data:image/png;base64,&#39;</span>+<span style=color:teal>[convert]</span>::ToBase64String((<span style=color:#0086b3>get-content</span> <span style=color:teal>$Image2</span> -encoding byte))+<span style=color:#d14>&#39;&#34;&gt;&#39;</span>
</span></span><span style=display:flex><span><span style=color:teal>$Image3AsBase64</span> = <span style=color:#d14>&#39;&lt;img src=&#34;data:image/png;base64,&#39;</span>+<span style=color:teal>[convert]</span>::ToBase64String((<span style=color:#0086b3>get-content</span> <span style=color:teal>$Image3</span> -encoding byte))+<span style=color:#d14>&#39;&#34;&gt;&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>Variables are an essential part of any repetitive tasks in any scripting language; PowerShell is no exception. The above Warning Date variables get used for calculating the days remaining in a user’s password later on in the heart of the script.</p><p>The image variables are for images stored in the same directory as the script, and the ImageAsBase64 variables convert the above image variables into a base64 string that can be embedded into an HTML page later in the script.</p><h2 id=the-heart-of-the-password-expiration-script>The heart of the Password Expiration Script</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-15>15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-16>16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-17>17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-18>18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-19>19</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-20>20</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-21>21</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-22>22</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-23>23</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-24>24</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-25>25</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-26>26</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-27>27</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-28>28</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-29>29</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-30>30</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-31>31</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-32>32</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-33>33</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-34>34</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-35>35</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-36>36</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-37>37</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-38>38</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-39>39</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-40>40</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-41>41</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-42>42</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-43>43</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-44>44</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-45>45</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-46>46</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-47>47</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-48>48</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-49>49</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-50>50</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-51>51</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-52>52</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-53>53</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-54>54</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-55>55</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-56>56</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-57>57</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-58>58</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-59>59</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-60>60</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-61><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-61>61</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-62><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-62>62</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-63><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-63>63</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-64><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-64>64</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-65><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-65>65</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-66><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-66>66</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-67><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-67>67</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-68><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-68>68</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-69><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-69>69</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-70><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-70>70</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-71><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-71>71</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#000;font-weight:700>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>foreach</span>(<span style=color:teal>$User</span> <span style=color:#000;font-weight:700>in</span> <span style=color:teal>$Users</span>) {
</span></span><span style=display:flex><span>        <span style=color:teal>$days</span> = ((<span style=color:teal>[datetime]</span><span style=color:teal>$User</span>.PasswordExpiry) - (<span style=color:#0086b3>Get-Date</span>)).days
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>        <span style=color:teal>$WarnDate</span> = <span style=color:#000;font-weight:700>Switch</span> (<span style=color:teal>$days</span>) {
</span></span><span style=display:flex><span>            14 {<span style=color:teal>$FourteenDayWarnDate</span>}
</span></span><span style=display:flex><span>            10 {<span style=color:teal>$TenDayWarnDate</span>}
</span></span><span style=display:flex><span>            5 {<span style=color:teal>$FiveDayWarnDate</span>}
</span></span><span style=display:flex><span>            4 {<span style=color:teal>$FourDayWarnDate</span>}
</span></span><span style=display:flex><span>            3 {<span style=color:teal>$ThreeDayWarnDate</span>}
</span></span><span style=display:flex><span>            2 {<span style=color:teal>$TwoDayWarnDate</span>}
</span></span><span style=display:flex><span>            1 {<span style=color:teal>$OneDayWarnDate</span>}
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>if</span> (<span style=color:teal>$days</span> -in 14, 10, 5, 4, 3, 2, 1) {
</span></span><span style=display:flex><span>            <span style=color:teal>$SamAccount</span> = <span style=color:teal>$user</span>.SamAccountName.ToUpper()
</span></span><span style=display:flex><span>            <span style=color:teal>$Subject</span>    = <span style=color:#d14>&#34;Windows Account Password for </span>$(<span style=color:teal>$SamAccount</span>)<span style=color:#d14> will expire soon&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:teal>$EmailBody</span>  = <span style=color:#d14>@&#34;
</span></span></span><span style=display:flex><span><span style=color:#d14>                    &lt;html&gt; 
</span></span></span><span style=display:flex><span><span style=color:#d14>                        &lt;body&gt; 
</span></span></span><span style=display:flex><span><span style=color:#d14>                            &lt;h1&gt;Your Windows Account password will expire soon&lt;/h1&gt; 
</span></span></span><span style=display:flex><span><span style=color:#d14>                            &lt;H2&gt;The Windows Account Password for &lt;span style=&#34;color:red&#34;&gt;$SamAccount&lt;/span&gt; will expire in &lt;span style=&#34;color:red&#34;&gt;$days&lt;/span&gt; days on &lt;span style=&#34;color:red&#34;&gt;</span>$(<span style=color:teal>$WarnDate</span>)<span style=color:#d14>.&lt;/Span&gt;&lt;/H2&gt;
</span></span></span><span style=display:flex><span><span style=color:#d14>                            &lt;H3&gt;If you need assistance changing your password, please reply to this email to submit a ticket&lt;/H3&gt;
</span></span></span><span style=display:flex><span><span style=color:#d14>                            &lt;br&gt;
</span></span></span><span style=display:flex><span><span style=color:#d14>                            &lt;br&gt;
</span></span></span><span style=display:flex><span><span style=color:#d14>                            &lt;br&gt;
</span></span></span><span style=display:flex><span><span style=color:#d14>                            &lt;br&gt;
</span></span></span><span style=display:flex><span><span style=color:#d14>                            &lt;br&gt;
</span></span></span><span style=display:flex><span><span style=color:#d14>                            &lt;H1&gt;How to change your password&lt;/H1&gt;
</span></span></span><span style=display:flex><span><span style=color:#d14>                            &lt;p&gt;While on any part of your computer, press the key combination &lt;b&gt;Ctrl + Alt + Del&lt;/b&gt;. &lt;br&gt; This will bring you to the Windows Security screen. If you are working from a remote computer,&lt;br&gt;you will need to press &lt;B&gt;Ctrl + Alt + End&lt;/B&gt; to get to the same screen&lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#d14>                            &lt;p&gt;$Image1AsBase64&lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#d14>                            &lt;p&gt;Click Change a Password. It will bring you to a new page. &lt;br&gt;Enter your old password, and then enter your new password twice.&lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#d14>                            &lt;p&gt;$Image2AsBase64&lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#d14>                            &lt;p&gt;Once you have confirmed your new password in both text boxes, either press enter or click the arrow to the right of the fourth text box. &lt;br&gt;If it completes successfully, it will say Your password has been changed.&lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#d14>                            &lt;p&gt;$Image3AsBase64&lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#d14>                            &lt;p&gt;&lt;img src=&#34;company logo&#34;&gt;&lt;img src=&#34;company logo&#34;&gt; &lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#d14>                        &lt;/body&gt; 
</span></span></span><span style=display:flex><span><span style=color:#d14>                    &lt;/html&gt;
</span></span></span><span style=display:flex><span><span style=color:#d14>&#34;@</span>
</span></span><span style=display:flex><span>            <span style=color:teal>$MailSplat</span> = @{
</span></span><span style=display:flex><span>                To          = <span style=color:teal>$User</span>.EmailAddress
</span></span><span style=display:flex><span>                From        = <span style=color:teal>$MailSender</span>
</span></span><span style=display:flex><span>                SmtpServer  = <span style=color:teal>$SMTPServer</span>
</span></span><span style=display:flex><span>                Subject     = <span style=color:teal>$Subject</span>
</span></span><span style=display:flex><span>                BodyAsHTML  = <span style=color:teal>$true</span>
</span></span><span style=display:flex><span>                Body        = <span style=color:teal>$EmailBody</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>try</span> {
</span></span><span style=display:flex><span>                <span style=color:#0086b3>Send-MailMessage</span> <span style=color:teal>@MailSplat</span> -ErrorAction Stop
</span></span><span style=display:flex><span>                <span style=color:#0086b3>Write-host</span> <span style=color:#d14>&#34;</span>$(<span style=color:teal>$Days</span>)<span style=color:#d14> days left, Email Sent to </span>$(<span style=color:teal>$SamAccount</span>)<span style=color:#d14>&#34;</span> -ErrorAction Stop
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>catch</span> {
</span></span><span style=display:flex><span>                <span style=color:#0086b3>Write-Host</span> <span style=color:#d14>&#34;Email failed to send&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:teal>$error</span>
</span></span><span style=display:flex><span>                <span style=color:#0086b3>Write-Host</span> <span style=color:#d14>&#34;Script failed to run on </span>$(<span style=color:teal>$CurrentDate</span>)<span style=color:#d14>&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:teal>$errorString</span> = <span style=color:teal>$error</span> | <span style=color:#0086b3>Out-String</span>
</span></span><span style=display:flex><span>                <span style=color:#0086b3>Send-MailMessage</span> -To <span style=color:#d14>&#39;techsupport@companyname.com&#39;</span> -From <span style=color:teal>$MailSender</span> -Subject <span style=color:#d14>&#39;The Password Bot has failed with an error&#39;</span> -SmtpServer <span style=color:teal>$SMTPServer</span> -Body <span style=color:teal>$errorString</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>Break</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>catch</span> {
</span></span><span style=display:flex><span>    <span style=color:#0086b3>Write-Host</span> <span style=color:#d14>&#39;Something Happened&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:teal>$error</span>
</span></span><span style=display:flex><span>    <span style=color:#0086b3>Write-Host</span> <span style=color:#d14>&#34;Script failed to run on </span>$(<span style=color:teal>$CurrentDate</span>)<span style=color:#d14>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:teal>$errorString</span> = <span style=color:teal>$error</span> | <span style=color:#0086b3>Out-String</span>
</span></span><span style=display:flex><span>    <span style=color:#0086b3>Send-MailMessage</span> -To <span style=color:#d14>&#39;techsupport@companyname.com&#39;</span> -From <span style=color:teal>$MailSender</span> -Subject <span style=color:#d14>&#39;The Password Bot has Failed with an error&#39;</span> -SmtpServer <span style=color:teal>$SMTPServer</span> -Body <span style=color:teal>$errorString</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>Break</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>This part is the heart of the script. It does not look easy, but it is pretty easy to understand. The AD query we did earlier created a <code>System.Array()</code> in the <code>$users</code> variable. In this part of the script, the <code>$users</code> variable gets used in a foreach loop. It looks at each user in the array, running said user’s password expiration date against each of the warning date variables mentioned earlier, and if the password expiration date matches any of the warning date variables, it will send an email to the user using saying their password is about to expire.</p><p>The MailSplat is an easy way to organize all the elements of a Send-MailMessage command. This one stores the To, From, SMTPServer, Subject, BodyAsHtml, and the body in a single variable. When it comes time to use the Send-MailMessage cmdlet, pass the <code>$MailSplat</code> variable to the cmdlet instead of typing everything out; this makes things easy to change in a hurry.</p><p>Like before with the AD and WMI queries, the <code>-errorAction Stop</code> is used here to break the script and move down to Catch if something with the script does not work.</p><h2 id=the-end>The End</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-1>1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-2>2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-3>3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-4>4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-5>5</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#000;font-weight:700>if</span> (!(<span style=color:teal>$error</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#0086b3>Write-Host</span> <span style=color:#d14>&#34;The script ran successfully on </span>$(<span style=color:teal>$CurrentDate</span>)<span style=color:#d14>&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0086b3>Stop-Transcript</span>
</span></span></code></pre></td></tr></table></div></div><p>This part looks to see if there were no errors in the script. If no errors occur, it writes to the log that the script ran successfully on the current date and stops the transcript.</p><p>This is the end of the script.</p><p>When all is said and done, an email like this should be produced when the script is run. The email is just using bare HTML, but it can be gussied up with CSS if so inclined.</p><p><div class=image><figure><a href=PasswordExpirationScriptEmail-819x1024.png target=_blank><img src=PasswordExpirationScriptEmail-819x1024.png alt=Screenshot></a></figure></div></p><p>I will not attempt to try and put the entire script here at the end, because I am sure you can see, it does not format the best here (thanks WordPress). Instead, I shall provide a link to this script on my GitHub instead where it looks like it should.</p><p><a href=https://github.com/BeholdenCypress/PowershellScripts/blob/master/Password%20Expirtation%20Bot.ps1>Link to my script on GitHub</a></p><img src=/authors/beholden-cypress/avatar.png alt="Photo of Beholden Cypress"><br><strong>Beholden Cypress</strong>
<em>Member</em><div></div><p>A contributor</p><hr></div><comments id=comments><script src=https://utteranc.es/client.js repo=SysManSquad/sysmansquadblog issue-term=title label="blog comment" theme=github-light crossorigin=anonymous async></script></comments></article></div></div></div><footer id=footer><div class=container><div id=footer-copyright><p class=copyright>&copy; 2022 WinAdmins - https://sysmansquad.com - Systems Management Squad</a></p></div></div></footer></div></body></html>