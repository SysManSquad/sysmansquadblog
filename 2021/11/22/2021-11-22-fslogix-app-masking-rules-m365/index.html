<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=keyword content="ConfigMgr Microsoft Intune Windows WinAdmins"><meta name=viewport content="width=device-width"><meta name=description content="A community blog and subsidiary of WinAdmins.io"><link rel="shortcut icon" href=/img/favicon.ico><title>FSLogix App Masking Rules for M365 Apps-SysManSquad | Systems Management Squad</title><link rel=canonical href=/2021/11/22/2021-11-22-fslogix-app-masking-rules-m365/><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://sysmansquad.com/css/custom.css><script src=https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js></script>
<script src=https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js></script>
<script src=https://sysmansquad.com/js/jquery.slicknav.js></script>
<script src=https://sysmansquad.com/js/asd_SlickNav_Mobile.js></script>
<script src=https://sysmansquad.com/js/custom.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZR1RSQYX"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XXZR1RSQYX",{anonymize_ip:!1})}</script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sysmansquad.com/83"><meta name=twitter:title content="FSLogix App Masking Rules for M365 Apps"><meta name=twitter:description content="I’m deploying Azure Virtual Desktop currently for a client and they want a “general shared desktop” pool that will have a bunch of core apps including Microsoft 365 Apps installed. However, not every user will be licensed for Visio or Project, and only a very select few users are allowed to use Publisher, and fewer still allowed MS Access (They’ve signed contracts so that if they dare create anything in Access, they have to support it for free till day they die, then their next of kin take over support."></head><body class="home blog"><div id=asd-container><div id=top-bar><div class=container><div id=nav-wrapper><ul class=menu id=menu-top-menu><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/>Home</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/about/><span>About</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=https://github.com/SysManSquad><span>GitHub</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/jointhesquad/><span>Join the Squad</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/meetthesquad/><span>Meet the Squad</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=#><span>MORE></span></a><ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/contact/>Contact</a></li></ul></li></ul></div><div id=top-search><a href=# class=search><i class="fa fa-search"></i></a><div class=show-search><form role=search method=get action=https://www.google.com/search id=searchform><input type=search placeholder="Search and hit enter..." name=q id=q title="Search and hit enter...">
<input type=hidden name=sitesearch value=https://sysmansquad.com>
<button type=submit value=Search class=searchbutton></form></div></div><div class=menu id=menu-mobile></div></div></div><header id=header class=noslider><div class=container><div id=logo><h1><a href=https://sysmansquad.com><img src=/img/SysManSquad-HorizontalColor-Logo.png alt="Systems Management Squad"></a></h1></div></div></header><div class=container><div id=content><div id=main class=fullwidth><article class="post type-post status-publish format-standard has-post-thumbnail hentry"><div class=post-header><h1>FSLogix App Masking Rules for M365 Apps</h1><p class=p-meta><span class=post-author><a href=/authors/grant>Grant Dickins</a> /</span>
<span class=post-date>November 22, 2021</span>
<span class=post-categories>/ Endpoint Management</span></p></div><div class=post-entry><p>I’m deploying Azure Virtual Desktop currently for a client and they want a “general shared desktop” pool that will have a bunch of core apps including Microsoft 365 Apps installed. However, not every user will be licensed for Visio or Project, and only a very select few users are allowed to use Publisher, and fewer still allowed MS Access (They’ve signed contracts so that if they dare create anything in Access, they have to support it for free till day they die, then their next of kin take over support.)</p><p>The solution? FSLogix Application Masking!
And it’s generally really easy to set up…. until you want to do the Office suite.</p><p>This is because Office is installed in the same directory and shares a lot of components with all applications in the suite, it makes it a lot more difficult to create app masking rules.</p><p>In order to get around this, I approached this in a modular fashion. Installing each app in a VM and capturing the rules as needed.</p><p>An older way was explained here: <a href="https://www.youtube.com/watch?v=opPTy9nUAwE">YouTube FSLogix Application Masking – Advanced Hiding of Project and Visio</a></p><p>We’re going to use this PowerShell script to create the rules: fslogix/Rules at main · aaronparker/fslogix · GitHub. It requires the Module “FSLogix.PowerShell.Rules”.</p><p>Our rules will hide Access, Publisher, Project, and Visio</p><h2 id=first-things-first-prepare-a-vm>First things first: Prepare a VM</h2><p>Create a standard VM of Windows 10 (I did this on-prem so snapshotting and reverting back is easier).
Once your VM is ready, log in and download the Office Deployment Tool from Download Office Deployment Tool from Official Microsoft Download Center to a temporary location. e.g. C:\ODT<br>Download Aaron Parkers ‘New-MicrosoftOfficeRuleset.ps1‘ script to a working directory. e.g. C:\Scripts<br>Install the FSLogix PowerShell Module:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps data-lang=ps><span style=display:flex><span><span style=color:#900;font-weight:700>Install-Module</span> <span style=color:#900;font-weight:700>-Name</span> <span style=color:#900;font-weight:700>&#34;FSLogix.PowerShell.Rules&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=second-thing-second-prepare-office-customisation-xml-files>Second thing second: Prepare Office Customisation XML files.</h2><p>We need to create a bunch of M365 Apps customisation config XML files.
(I will assume here that you already know how to make M365 Apps <a href=https://docs.microsoft.com/en-us/deployoffice/office-deployment-tool-configuration-options>configuration files</a>)</p><p>Base Office install without Project, or Visio
To create rules for Access, Publisher
Base office with Visio (No Project)
To create rule for Visio
Base office with Project (No Visio)
To create rule for Project
Edit the Office Customisation XML as follows:</p><ol><li>Base Office install without Project, or Visio</li></ol><ul><li>To create rules for Access, Publisher</li></ul><ol start=2><li>Base office with Visio (No Project)</li></ol><ul><li>To create rule for Visio</li></ul><ol start=3><li>Base office with Project (No Visio</li></ol><ul><li>To create rule for Project</li></ul><h2 id=edit-the-office-customisation-xml-as-follows>Edit the Office Customisation XML as follows:</h2><p>Base Install Config:</p><p><div class=image><figure><a href=image-2.png target=_blank><img src=image-2.png alt="Image shows an office setup XML file with product ID O365ProPlusRetail enabled and all other products commented out."></a><figcaption>Base Install Config</figcaption></figure></div></p><p>With Visio:</p><p><div class=image><figure><a href=image-3.png target=_blank><img src=image-3.png alt="Image shows an office setup XML file with product ID O365ProPlusRetail and VisioProRetail enabled and ProjectProRetail commented out."></a><figcaption>Visio added</figcaption></figure></div></p><p>With Project:</p><p><div class=image><figure><a href=image-3.png target=_blank><img src=image-3.png alt="Image shows an office setup XML file with all products enabled."></a><figcaption>All products enabled</figcaption></figure></div></p><p>Save each as a different version. E.g. M365Apps-AVD-Base.xml, M365Apps-AVD-Visio.xml, M365Apps-AVD-Project.xml</p><p>Download the office setup files by running:</p><p><code>C:\ODT\setup.exe /download .\M365Apps-AVD-Base.xml</code></p><p>Snapshot the VM – “Pre-Office” (I snapshot here just in case)</p><p>Now install the Base Office</p><p><code>C:\ODT\setup.exe /configure .\M365Apps-AVD-Base.xml</code></p><h2 id=create-access-ruleset>Create Access Ruleset</h2><p>Run:</p><p><code>C:\Scripts\New-MicrosoftOfficeRuleset.ps1 -SearchString "Access"</code></p><ul><li>Open the generated Rule File (Default C:\Users\USERNAME\Documents\FSLogix Rule Sets\MicrosoftAccess.fxr)</li><li>Check & Delete any entries which are incorrect or aren’t actually relevant to MS Access. i.e. They just have “access” in the name.</li></ul><p><div class=image><figure><a href=image-1.png target=_blank><img src=image-1.png alt="A screenshot showing filtering rules."></a><figcaption>Filter Rules</figcaption></figure></div></p><p>I also deleted all the Classes\CLSID{GUID} rules because they kinda broke Windows. I didn’t have time to test them all, but you <strong>should</strong> for best results.</p><h2 id=create-publisher-ruleset>Create Publisher Ruleset</h2><p>Run:</p><p><code>C:\Scripts\New-MicrosoftOfficeRuleset.ps1 -SearchString "Publisher"</code></p><ul><li>Open the generated Rule File (Default C:\Users\USERNAME\Documents\FSLogix Rule Sets\MicrosoftPublisher.fxr)</li><li>Check for any entries which are incorrect.</li></ul><p>Copy the Access and Publisher rules off the VM to a separate storage location.</p><p>Revert the VM to last snapshot.</p><h2 id=create-visio-ruleset>Create Visio Ruleset</h2><p>Install Office with Visio</p><p><code>C:\ODT\setup.exe /configure .\M365Apps-AVD-Visio.xml</code></p><p>Run:</p><p><code>C:\Scripts\New-MicrosoftOfficeRuleset.ps1 -SearchString "Visio"</code></p><ul><li>Open the generated Rule File (Default C:\Users\USERNAME\Documents\FSLogix Rule Sets\MicrosoftVisio.fxr)</li><li>Check for any entries which are incorrect.</li><li></li></ul><p>Revert the VM to last snapshot.</p><h2 id=create-project-ruleset>Create Project Ruleset</h2><p>Install Office with Project</p><p><code>C:\ODT\setup.exe /configure .\M365Apps-AVD-Project.xml</code></p><p>Run:</p><p><code>C:\Scripts\New-MicrosoftOfficeRuleset.ps1 -SearchString "Project", "WinProj"</code></p><ul><li>Open the generated Rule File (Default C:\Users\USERNAME\Documents\FSLogix Rule Sets\MicrosoftProject.fxr)</li><li>Check for any entries which are incorrect.</li></ul><p>This one is quite difficult. I found and deleted a load of entries that are nothing to do with Project (I am open to corrections):</p><p>HKLM\SOFTWARE\Microsoft\Office\ClickToRun\REGISTRY\MACHINE\Software\Classes\Outlook.File.otm.15
HKLM\SOFTWARE\Microsoft\Office\ClickToRun\REGISTRY\MACHINE\Software\Classes\Access.Project.16
HKLM\SOFTWARE\Microsoft\Office\ClickToRun\REGISTRY\MACHINE\Software\Classes\Access.Project
HKLM\SOFTWARE\Microsoft\Office\ClickToRun\REGISTRY\MACHINE\Software\Classes\Access.BlankProjectTemplate.16
HKLM\SOFTWARE\Microsoft\Office\ClickToRun\REGISTRY\MACHINE\Software\Classes\Access.BlankProjectTemplate
HKLM\SOFTWARE\Microsoft\Office\ClickToRun\REGISTRY\MACHINE\Software\Classes\Access.ADEFile.16
HKLM\SOFTWARE\Microsoft\Office\ClickToRun\REGISTRY\MACHINE\Software\Classes\Access.ADEFile
HKLM\SOFTWARE\Classes\Outlook.File.otm.15
HKLM\SOFTWARE\Classes\Access.Project.16
HKLM\SOFTWARE\Classes\Access.Project
HKLM\SOFTWARE\Classes\Access.BlankProjectTemplate.16
HKLM\SOFTWARE\Classes\Access.BlankProjectTemplate
HKLM\SOFTWARE\Classes\Access.ADEFile.16
HKLM\SOFTWARE\Classes\Access.ADEFile</p><p>I also had to add:
%CommonStartMenuFolder%\Programs\Microsoft Office Tools\Project Server Accounts.lnk</p><p>Copy the Project Ruleset off the VM to a separate storage location.</p><h2 id=conclusion>Conclusion</h2><p>You should now have 4 rulesets ready to test, create assignments, and then deploy to your desired machines.</p><p>Pay close attention to any entries in HKLM\SOFTWARE\Classes\CLSID{GUID}.
These are sometimes related to the application, but often seem to be more system based registry keys and masking them can break things!</p><p><strong>Test thoroughly!!!</strong></p><img src=/authors/grant/avatar.png alt="Photo of Grant Dickins"><br><strong>Grant Dickins</strong>
<em>Contributor</em><div><a href=https://twitter.com/_G_rant><img src=/img/social/twitter.png></a></div><p>Grant has worked supporting IT in the Oil & Gas industry for 10 years, has a keen interest in Config Manager and trying to bring the industry kicking and screaming into the modern cloud-based world.</p><hr></div><comments id=comments><script src=https://utteranc.es/client.js repo=SysManSquad/sysmansquadblog issue-term=title label="blog comment" theme=github-light crossorigin=anonymous async></script></comments></article></div></div></div><footer id=footer><div class=container><div id=footer-copyright><p class=copyright>&copy; 2022 WinAdmins - https://sysmansquad.com - Systems Management Squad</a></p></div></div></footer></div></body></html>