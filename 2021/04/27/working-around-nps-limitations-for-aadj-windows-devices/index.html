<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=keyword content="ConfigMgr Microsoft Intune Windows WinAdmins">
<meta name=viewport content="width=device-width">
<meta name=description content="A community blog and subsidiary of WinAdmins.io">
<link rel="shortcut icon" href=/img/favicon.ico>
<title>Working around NPS limitations for AADJ Windows devices-SysManSquad | Systems Management Squad</title>
<link rel=canonical href=/2021/04/27/working-around-nps-limitations-for-aadj-windows-devices/>
<link rel=stylesheet href=/css/style.css>
<link rel=stylesheet href=https://blog.sysmansquad.com/css/custom.css>
<script src=https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js></script>
<script src=https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js></script>
<script src=https://blog.sysmansquad.com/js/jquery.slicknav.js></script>
<script src=https://blog.sysmansquad.com/js/asd_SlickNav_Mobile.js></script>
<script src=https://blog.sysmansquad.com/js/custom.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZR1RSQYX"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-XXZR1RSQYX',{anonymize_ip:!1})}</script>
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://blog.sysmansquad.com/83">
<meta name=twitter:title content="Working around NPS limitations for AADJ Windows devices">
<meta name=twitter:description content="Author Andrew Blackburn
Introduction In this post, I&rsquo;ll show you a workaround to get device based wireless authentication working for AADJ Windows devices via NPS. Keep in mind this is a workaround and your mileage may vary.
Background NPS does not play nice when it comes to AADJ device authentication. There is a fantastic writeup on this issue here.
The tl;dr of the issue Device based authentication works when there is a computer object in your on-prem.">
</head>
<body class="home blog">
<div id=asd-container>
<div id=top-bar>
<div class=container>
<div id=nav-wrapper>
<ul class=menu id=menu-top-menu>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/>Home</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/about/>
<span>About</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=https://github.com/SysManSquad>
<span>GitHub</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/jointhesquad/>
<span>Join the Squad</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/meetthesquad/>
<span>Meet the Squad</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=#>
<span>MORE></span>
</a>
<ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/contact/>Contact</a>
</li>
</ul>
</li>
</ul>
</div>
<div id=top-search>
<a href=# class=search><i class="fa fa-search"></i></a>
<div class=show-search>
<form role=search method=get action=https://www.google.com/search id=searchform>
<input type=search placeholder="Search and hit enter..." name=q id=q title="Search and hit enter...">
<input type=hidden name=sitesearch value=https://blog.sysmansquad.com>
<button type=submit value=Search>
</form>
</div>
</div>
<div class=menu id=menu-mobile></div>
</div>
</div>
<header id=header class=noslider>
<div class=container>
<div id=logo>
<h1><a href=https://blog.sysmansquad.com><img src=/img/SysManSquad-HorizontalColor-Logo.png alt="Systems Management Squad"></a></h1>
</div>
</div>
</header>
<div class=container>
<div id=content>
<div id=main class=fullwidth>
<article class="post type-post status-publish format-standard has-post-thumbnail hentry">
<div class=post-header>
<h1>Working around NPS limitations for AADJ Windows devices</h1>
<p class=p-meta>
<span class=post-author><a href=/authors/molly>SysManSquad</a> / </span>
<span class=post-date>April 28, 2021 </span>
<span class=post-categories>/ Endpoint Management </span>
<span class=post-categories>/ Intune </span>
<span class=post-categories>/ Networking </span>
</p>
</div>
<div class=post-entry>
<h1 id=author>Author</h1>
<p>Andrew Blackburn</p>
<h2 id=introduction>Introduction</h2>
<p>In this post, I&rsquo;ll show you a workaround to get device based wireless authentication working for AADJ Windows devices via NPS. Keep in mind this is a workaround and your mileage may vary.</p>
<h2 id=background>Background</h2>
<p>NPS does not play nice when it comes to AADJ device authentication. There is a fantastic writeup on this issue <a href=https://docs.microsoft.com/answers/questions/57999/device-certificate-scep-based-authentication-again.html>here</a>.</p>
<h3 id=the-tldr-of-the-issue><strong>The tl;dr of the issue</strong></h3>
<p>Device based authentication works when there is a computer object in your on-prem. directory that backs up NPS&rsquo;s authentication checks. If the devices are AADJ only (not hybrid), then there is no computer object in the on-prem. directory. NPS sees the device as unknown and authentication fails.</p>
<h3 id=why-is-device-based-authentication-important><strong>Why is device based authentication important?</strong></h3>
<p>Ideally, there should be a connection to the network at the login screen. This isn&rsquo;t a big deal if you&rsquo;re 1:1 because of cached credentials. If you&rsquo;re not 1:1, e.g. shared devices, you will need a network connection at the login screen to ensure the first time login for a user works.</p>
<h3 id=why-not-just-hybrid-join-your-machines><strong>Why not just hybrid join your machines?</strong></h3>
<p><div class=image>
<figure>
<a href=haadj.gif target=_blank>
<img src=haadj.gif alt=gif>
</a>
</figure>
</div>
More great gifs like this on the <a href=https://aka.ms/winadmins>Windows Admins</a> Discord server.</p>
<h2 id=things-i-am-assuming-you-have>Things I am assuming you have</h2>
<ul>
<li>Healthy PKI
<ul>
<li>Certificate enrollment configured for the user <strong>and</strong> device via your MDM</li>
</ul>
</li>
<li>Healthy wireless network
<ul>
<li>802.1X via an on-prem. NPS</li>
<li>WiFi profile(s) pushed out to your devices via your MDM</li>
</ul>
</li>
</ul>
<h2 id=the-workaround>The workaround</h2>
<p>There are several workarounds discussed in the post I linked above. For me, the easiest method is creating &ldquo;dummy&rdquo; computer objects in Active Directory that match the AADJ devices. Once NPS sees the AADJ device in your local AD, authentication works.</p>
<p>I settled on using PowerShell for this workaround. Although tedious, you could do your initial testing via ADUC and the attribute editor.</p>
<h3 id=basic-version-of-the-script>Basic version of the script</h3>
<p>This basic version of the script lets you create one device at a time (useful for testing):</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=12><a style=outline:none;text-decoration:none;color:inherit href=#12>12</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=13><a style=outline:none;text-decoration:none;color:inherit href=#13>13</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=14><a style=outline:none;text-decoration:none;color:inherit href=#14>14</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=15><a style=outline:none;text-decoration:none;color:inherit href=#15>15</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=16><a style=outline:none;text-decoration:none;color:inherit href=#16>16</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=17><a style=outline:none;text-decoration:none;color:inherit href=#17>17</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=18><a style=outline:none;text-decoration:none;color:inherit href=#18>18</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=19><a style=outline:none;text-decoration:none;color:inherit href=#19>19</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=20><a style=outline:none;text-decoration:none;color:inherit href=#20>20</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=21><a style=outline:none;text-decoration:none;color:inherit href=#21>21</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=22><a style=outline:none;text-decoration:none;color:inherit href=#22>22</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=23><a style=outline:none;text-decoration:none;color:inherit href=#23>23</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=24><a style=outline:none;text-decoration:none;color:inherit href=#24>24</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=25><a style=outline:none;text-decoration:none;color:inherit href=#25>25</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=26><a style=outline:none;text-decoration:none;color:inherit href=#26>26</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=27><a style=outline:none;text-decoration:none;color:inherit href=#27>27</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=28><a style=outline:none;text-decoration:none;color:inherit href=#28>28</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=29><a style=outline:none;text-decoration:none;color:inherit href=#29>29</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=30><a style=outline:none;text-decoration:none;color:inherit href=#30>30</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=31><a style=outline:none;text-decoration:none;color:inherit href=#31>31</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=32><a style=outline:none;text-decoration:none;color:inherit href=#32>32</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=33><a style=outline:none;text-decoration:none;color:inherit href=#33>33</a>
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>[<span style=color:#000;font-weight:700>CmdletBinding</span>(DefaultParameterSetName = <span style=color:#d14>&#39;Default&#39;</span>)]
<span style=color:#000;font-weight:700>param</span>(
    [<span style=color:#000;font-weight:700>Parameter</span>(<span style=color:#000;font-weight:700>Mandatory</span>=<span style=color:teal>$False</span>)] <span style=color:teal>[String]</span> <span style=color:teal>$deviceName</span> = <span style=color:#d14>&#34;&#34;</span>,
    [<span style=color:#000;font-weight:700>Parameter</span>(<span style=color:#000;font-weight:700>Mandatory</span>=<span style=color:teal>$False</span>)] <span style=color:teal>[Switch]</span> <span style=color:teal>$nameMap</span>
    )

<span style=color:#998;font-style:italic># Set the OU for computer object creation</span>
<span style=color:teal>$orgUnit</span> = <span style=color:#d14>&#34;OU=Dummy Devices,OU=Devices,DC=yourdomain,DC=tld&#34;</span> 

<span style=color:#998;font-style:italic># Set the certificate path for name mapping</span>
<span style=color:teal>$certPath</span> = <span style=color:#d14>&#34;X509:I&gt;DC=tld,DC=yourdomain,CN=your-CAS&gt;CN=&#34;</span> 

<span style=color:#998;font-style:italic># Prepare SAMAccountName based off of length constraints</span>
<span style=color:teal>$SAMAccountName</span> = <span style=color:#000;font-weight:700>if</span> (<span style=color:teal>$deviceName</span>.Length <span style=color:#000;font-weight:700>-ge</span> 15) {<span style=color:teal>$deviceName</span>.Substring(0,15) + <span style=color:#d14>&#34;$&#34;</span>} <span style=color:#000;font-weight:700>else</span> {<span style=color:teal>$deviceName</span> + <span style=color:#d14>&#34;$&#34;</span>}

<span style=color:#998;font-style:italic># Create the dummy computer object in AD</span>
<span style=color:#000;font-weight:700>try</span> {
    <span style=color:#0086b3>New-ADComputer</span> -Name <span style=color:#d14>&#34;$deviceName&#34;</span> -SAMAccountName <span style=color:teal>$SAMAccountName</span> -Path <span style=color:teal>$orgUnit</span> -ServicePrincipalNames <span style=color:#d14>&#34;HOST/$deviceName&#34;</span>
    <span style=color:#0086b3>Write-Host</span> <span style=color:#d14>&#34;Computer object created. (</span>$(<span style=color:teal>$deviceName</span>)<span style=color:#d14>)&#34;</span> -ForegroundColor Green
} <span style=color:#000;font-weight:700>catch</span> {
    <span style=color:#0086b3>Write-Host</span> <span style=color:#d14>&#34;Skipping AD computer object creation (likely because it already exists in AD)&#34;</span> -ForegroundColor Yellow
}

<span style=color:#998;font-style:italic># Perform name mapping if specified</span>
<span style=color:#000;font-weight:700>if</span> (<span style=color:teal>$nameMap</span>) {
    <span style=color:#000;font-weight:700>try</span> {
        <span style=color:#0086b3>Set-ADComputer</span> -Identity <span style=color:teal>$SAMAccountName</span> -Add @{<span style=color:#d14>&#39;altSecurityIdentities&#39;</span>=<span style=color:#d14>&#34;</span>$(<span style=color:teal>$certPath</span>)$(<span style=color:teal>$deviceName</span>)<span style=color:#d14>&#34;</span>}
        <span style=color:#0086b3>Write-Host</span> <span style=color:#d14>&#34;Name mapping for computer object done. (</span>$(<span style=color:teal>$certPath</span>)$(<span style=color:teal>$deviceName</span>)<span style=color:#d14>)&#34;</span> -ForegroundColor Green
    } <span style=color:#000;font-weight:700>catch</span> {
        <span style=color:#0086b3>Write-Host</span> <span style=color:#d14>&#34;Skipping name mapping (likely because device does not exist in AD)&#34;</span> -ForegroundColor Red
        exit 1
    }
}
</code></pre></td></tr></table>
</div>
</div><p>There are three important things this script does:</p>
<ol>
<li>Creates the computer object
<ul>
<li>Be sure to use the correct device name. Usually this will be what you have mapped to your device certificate. In my case, I used the AAD Device ID for the computer.</li>
</ul>
</li>
<li>Adds the service principal name (SPN) to the computer object
<ul>
<li>This is what NPS sees when a device authenticates (HOST/devicename). Again, device name is very important here.</li>
</ul>
</li>
<li>Adds a certificate name mapping to the computer object if needed
<ul>
<li>I have heard from others this may not be necessary. This won&rsquo;t work in my environment unless there is a name mapping.</li>
</ul>
</li>
</ol>
<p>Be sure to run this on a domain computer that has the &lsquo;ActiveDirectory&rsquo; module. Also, the account that the script is running under will need permissions to create and edit computer objects in AD.</p>
<p>Here is an example run command:</p>
<blockquote>
<p>.\New-DummyADComputer.ps1 -deviceName &ldquo;device-name-here&rdquo; -nameMap</p>
</blockquote>
<p><div class=image>
<figure>
<a href=image-8.png target=_blank>
<img src=image-8.png alt=screenshot>
</a>
</figure>
</div> After using the script for a test device, you should see the computer object in your AD.</p>
<p><div class=image>
<figure>
<a href=image-9.png target=_blank>
<img src=image-9.png alt=screenshot>
</a>
</figure>
</div></p>
<p>Now, you should be able to perform successful device based 802.1X authentication on your test device. 👍</p>
<h3 id=more-advanced-version-of-the-script-that-works-with-ms-graph>More advanced version of the script that works with MS Graph</h3>
<p>For my use case, I needed something that I could run on a schedule and forget about. This more advanced version of the script pulls down all of the Autopilot devices from MS Graph using the &lsquo;WindowsAutopilotIntune&rsquo; module. It then uses the &lsquo;ActiveDirectory&rsquo; module to create/prepare matching computer objects in AD.</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=12><a style=outline:none;text-decoration:none;color:inherit href=#12>12</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=13><a style=outline:none;text-decoration:none;color:inherit href=#13>13</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=14><a style=outline:none;text-decoration:none;color:inherit href=#14>14</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=15><a style=outline:none;text-decoration:none;color:inherit href=#15>15</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=16><a style=outline:none;text-decoration:none;color:inherit href=#16>16</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=17><a style=outline:none;text-decoration:none;color:inherit href=#17>17</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=18><a style=outline:none;text-decoration:none;color:inherit href=#18>18</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=19><a style=outline:none;text-decoration:none;color:inherit href=#19>19</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=20><a style=outline:none;text-decoration:none;color:inherit href=#20>20</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=21><a style=outline:none;text-decoration:none;color:inherit href=#21>21</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=22><a style=outline:none;text-decoration:none;color:inherit href=#22>22</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=23><a style=outline:none;text-decoration:none;color:inherit href=#23>23</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=24><a style=outline:none;text-decoration:none;color:inherit href=#24>24</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=25><a style=outline:none;text-decoration:none;color:inherit href=#25>25</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=26><a style=outline:none;text-decoration:none;color:inherit href=#26>26</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=27><a style=outline:none;text-decoration:none;color:inherit href=#27>27</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=28><a style=outline:none;text-decoration:none;color:inherit href=#28>28</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=29><a style=outline:none;text-decoration:none;color:inherit href=#29>29</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=30><a style=outline:none;text-decoration:none;color:inherit href=#30>30</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=31><a style=outline:none;text-decoration:none;color:inherit href=#31>31</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=32><a style=outline:none;text-decoration:none;color:inherit href=#32>32</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=33><a style=outline:none;text-decoration:none;color:inherit href=#33>33</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=34><a style=outline:none;text-decoration:none;color:inherit href=#34>34</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=35><a style=outline:none;text-decoration:none;color:inherit href=#35>35</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=36><a style=outline:none;text-decoration:none;color:inherit href=#36>36</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=37><a style=outline:none;text-decoration:none;color:inherit href=#37>37</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=38><a style=outline:none;text-decoration:none;color:inherit href=#38>38</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=39><a style=outline:none;text-decoration:none;color:inherit href=#39>39</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=40><a style=outline:none;text-decoration:none;color:inherit href=#40>40</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=41><a style=outline:none;text-decoration:none;color:inherit href=#41>41</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=42><a style=outline:none;text-decoration:none;color:inherit href=#42>42</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=43><a style=outline:none;text-decoration:none;color:inherit href=#43>43</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=44><a style=outline:none;text-decoration:none;color:inherit href=#44>44</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=45><a style=outline:none;text-decoration:none;color:inherit href=#45>45</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=46><a style=outline:none;text-decoration:none;color:inherit href=#46>46</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=47><a style=outline:none;text-decoration:none;color:inherit href=#47>47</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=48><a style=outline:none;text-decoration:none;color:inherit href=#48>48</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=49><a style=outline:none;text-decoration:none;color:inherit href=#49>49</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=50><a style=outline:none;text-decoration:none;color:inherit href=#50>50</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=51><a style=outline:none;text-decoration:none;color:inherit href=#51>51</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=52><a style=outline:none;text-decoration:none;color:inherit href=#52>52</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=53><a style=outline:none;text-decoration:none;color:inherit href=#53>53</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=54><a style=outline:none;text-decoration:none;color:inherit href=#54>54</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=55><a style=outline:none;text-decoration:none;color:inherit href=#55>55</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=56><a style=outline:none;text-decoration:none;color:inherit href=#56>56</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=57><a style=outline:none;text-decoration:none;color:inherit href=#57>57</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=58><a style=outline:none;text-decoration:none;color:inherit href=#58>58</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=59><a style=outline:none;text-decoration:none;color:inherit href=#59>59</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=60><a style=outline:none;text-decoration:none;color:inherit href=#60>60</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=61><a style=outline:none;text-decoration:none;color:inherit href=#61>61</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=62><a style=outline:none;text-decoration:none;color:inherit href=#62>62</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=63><a style=outline:none;text-decoration:none;color:inherit href=#63>63</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=64><a style=outline:none;text-decoration:none;color:inherit href=#64>64</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=65><a style=outline:none;text-decoration:none;color:inherit href=#65>65</a>
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>[<span style=color:#000;font-weight:700>CmdletBinding</span>(DefaultParameterSetName = <span style=color:#d14>&#39;Default&#39;</span>)]
<span style=color:#000;font-weight:700>param</span>(
    [<span style=color:#000;font-weight:700>Parameter</span>(<span style=color:#000;font-weight:700>Mandatory</span>=<span style=color:teal>$True</span>)] <span style=color:teal>[String]</span> <span style=color:teal>$TenantId</span> = <span style=color:#d14>&#34;&#34;</span>,
    [<span style=color:#000;font-weight:700>Parameter</span>(<span style=color:#000;font-weight:700>Mandatory</span>=<span style=color:teal>$True</span>)] <span style=color:teal>[String]</span> <span style=color:teal>$ClientId</span> = <span style=color:#d14>&#34;&#34;</span>,
    [<span style=color:#000;font-weight:700>Parameter</span>(<span style=color:#000;font-weight:700>Mandatory</span>=<span style=color:teal>$True</span>)] <span style=color:teal>[String]</span> <span style=color:teal>$ClientSecret</span> = <span style=color:#d14>&#34;&#34;</span>,
    [<span style=color:#000;font-weight:700>Parameter</span>(<span style=color:#000;font-weight:700>Mandatory</span>=<span style=color:teal>$False</span>)] <span style=color:teal>[Switch]</span> <span style=color:teal>$NameMap</span>
)

<span style=color:#998;font-style:italic># Get NuGet</span>
<span style=color:#0086b3>Get-PackageProvider</span> -Name <span style=color:#d14>&#34;NuGet&#34;</span> -Force | <span style=color:#0086b3>Out-Null</span>

<span style=color:#998;font-style:italic># Get WindowsAutopilotIntune module (and dependencies)</span>
<span style=color:teal>$module</span> = <span style=color:#0086b3>Import-Module</span> WindowsAutopilotIntune -PassThru -ErrorAction Ignore
<span style=color:#000;font-weight:700>if</span> (<span style=color:#000;font-weight:700>-not</span> <span style=color:teal>$module</span>) {
    <span style=color:#0086b3>Write-Host</span> <span style=color:#d14>&#34;Installing module WindowsAutopilotIntune&#34;</span>
    <span style=color:#0086b3>Install-Module</span> WindowsAutopilotIntune -Force
}
<span style=color:#0086b3>Import-Module</span> WindowsAutopilotIntune -Scope Global

<span style=color:#998;font-style:italic># Connect to MSGraph with application credentials</span>
<span style=color:#0086b3>Connect-MSGraphApp</span> -Tenant <span style=color:teal>$TenantId</span> -AppId <span style=color:teal>$ClientId</span> -AppSecret <span style=color:teal>$ClientSecret</span>

<span style=color:#998;font-style:italic># Pull latest Autopilot device information</span>
<span style=color:teal>$AutopilotDevices</span> = <span style=color:#0086b3>Get-AutopilotDevice</span> | <span style=color:#0086b3>Select-Object</span> azureActiveDirectoryDeviceId

<span style=color:#998;font-style:italic># Set the OU for computer object creation</span>
<span style=color:teal>$orgUnit</span> = <span style=color:#d14>&#34;OU=Dummy Devices,OU=Devices,DC=yourdomain,DC=tld&#34;</span> 

<span style=color:#998;font-style:italic># Set the certificate path for name mapping</span>
<span style=color:teal>$certPath</span> = <span style=color:#d14>&#34;X509:I&gt;DC=tld,DC=yourdomain,CN=your-CAS&gt;CN=&#34;</span> 

<span style=color:#998;font-style:italic># Create new Autopilot computer objects in AD while skipping already existing computer objects</span>
<span style=color:#000;font-weight:700>foreach</span> (<span style=color:teal>$Device</span> <span style=color:#000;font-weight:700>in</span> <span style=color:teal>$AutopilotDevices</span>) {
    <span style=color:#000;font-weight:700>if</span> (<span style=color:#0086b3>Get-ADComputer</span> -Filter <span style=color:#d14>&#34;Name -eq &#34;&#34;</span>$(<span style=color:teal>$Device</span>.azureActiveDirectoryDeviceId)<span style=color:#d14>&#34;&#34;&#34;</span> -SearchBase <span style=color:teal>$orgUnit</span> -ErrorAction SilentlyContinue) {
        <span style=color:#0086b3>Write-Host</span> <span style=color:#d14>&#34;Skipping </span>$(<span style=color:teal>$Device</span>.azureActiveDirectoryDeviceId)<span style=color:#d14> because it already exists. &#34;</span> -ForegroundColor Yellow
    } <span style=color:#000;font-weight:700>else</span> {
        <span style=color:#998;font-style:italic># Create new AD computer object</span>
        <span style=color:#000;font-weight:700>try</span> {
            <span style=color:#0086b3>New-ADComputer</span> -Name <span style=color:#d14>&#34;</span>$(<span style=color:teal>$Device</span>.azureActiveDirectoryDeviceId)<span style=color:#d14>&#34;</span> -SAMAccountName <span style=color:#d14>&#34;</span>$(<span style=color:teal>$Device</span>.azureActiveDirectoryDeviceId.Substring(0,15))<span style=color:#d14>`$</span><span style=color:#d14>&#34;</span> -ServicePrincipalNames <span style=color:#d14>&#34;HOST/</span>$(<span style=color:teal>$Device</span>.azureActiveDirectoryDeviceId)<span style=color:#d14>&#34;</span> -Path <span style=color:teal>$orgUnit</span>
            <span style=color:#0086b3>Write-Host</span> <span style=color:#d14>&#34;Computer object created. (</span>$(<span style=color:teal>$Device</span>.azureActiveDirectoryDeviceId)<span style=color:#d14>)&#34;</span> -ForegroundColor Green
        } <span style=color:#000;font-weight:700>catch</span> {
            <span style=color:#0086b3>Write-Host</span> <span style=color:#d14>&#34;Error. Skipping computer object creation.&#34;</span> -ForegroundColor Red
        }
        
        <span style=color:#998;font-style:italic># Perform name mapping</span>
        <span style=color:#000;font-weight:700>try</span> {
            <span style=color:#0086b3>Set-ADComputer</span> -Identity <span style=color:#d14>&#34;</span>$(<span style=color:teal>$Device</span>.azureActiveDirectoryDeviceId.Substring(0,15))<span style=color:#d14>&#34;</span> -Add @{<span style=color:#d14>&#39;altSecurityIdentities&#39;</span>=<span style=color:#d14>&#34;</span>$(<span style=color:teal>$certPath</span>)$(<span style=color:teal>$Device</span>.azureActiveDirectoryDeviceId)<span style=color:#d14>&#34;</span>}
            <span style=color:#0086b3>Write-Host</span> <span style=color:#d14>&#34;Name mapping for computer object done. (</span>$(<span style=color:teal>$certPath</span>)$(<span style=color:teal>$Device</span>.azureActiveDirectoryDeviceId)<span style=color:#d14>)&#34;</span> -ForegroundColor Green
        } <span style=color:#000;font-weight:700>catch</span> {
            <span style=color:#0086b3>Write-Host</span> <span style=color:#d14>&#34;Error. Skipping name mapping.&#34;</span> -ForegroundColor Red
        }
    }
}

<span style=color:#998;font-style:italic># Reverse the process and remove any dummmy computer objects in AD that are no longer in Autopilot</span>
<span style=color:teal>$DummyDevices</span> = <span style=color:#0086b3>Get-ADComputer</span> -Filter * -SearchBase <span style=color:teal>$orgUnit</span> | <span style=color:#0086b3>Select-Object</span> Name, SAMAccountName
<span style=color:#000;font-weight:700>foreach</span> (<span style=color:teal>$DummyDevice</span> <span style=color:#000;font-weight:700>in</span> <span style=color:teal>$DummyDevices</span>) {
  <span style=color:#000;font-weight:700>if</span> (<span style=color:teal>$AutopilotDevices</span>.azureActiveDirectoryDeviceId <span style=color:#000;font-weight:700>-contains</span> <span style=color:teal>$DummyDevice</span>.Name) {
        <span style=color:#998;font-style:italic># Write-Host &#34;$($DummyDevice.Name) exists in Autopilot.&#34; -ForegroundColor Green</span>
    } <span style=color:#000;font-weight:700>else</span> {
        <span style=color:#0086b3>Write-Host</span> <span style=color:#d14>&#34;</span>$(<span style=color:teal>$DummyDevice</span>.Name)<span style=color:#d14> does not exist in Autopilot.&#34;</span> -ForegroundColor Yellow
        <span style=color:#998;font-style:italic># Remove-ADComputer -Identity $DummyDevice.SAMAccountName -Confirm:$False -WhatIf </span>
        <span style=color:#998;font-style:italic>#Remove -WhatIf once you are comfortrable with this workflow and have verified the remove operations are only performed in the OU you specified</span>
    }
}
</code></pre></td></tr></table>
</div>
</div><p>Here is a play-by-play of the script:</p>
<ul>
<li>Connects to MS Graph with application credentials
<ul>
<li>You could change this to perform an interactive login. For my use case, Azure app-based authentication allows me to schedule this script. The Azure app registration only needs API permissions to read Autopilot devices.</li>
</ul>
</li>
<li>Pulls Autopilot device information from MS Graph</li>
<li>Createsnewdummy computer objectsinAD using the Autopilot device information
<ul>
<li>Alreadyexistingdummy devices are skipped</li>
</ul>
</li>
<li>Reverses the process and removes any dummy computer objects in AD that no longer exist in Autopilot
<ul>
<li><strong>This step is potentially dangerous.</strong> Because of that, I added comments in the script above (line 63) and added <em>-WhatIf</em> as further risk control.</li>
</ul>
</li>
</ul>
<p>Here is an example run command:</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=1><a style=outline:none;text-decoration:none;color:inherit href=#1>1</a>
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>.\<span style=color:#0086b3>Sync-DummyComputers</span>.ps1 -TenantId <span style=color:#d14>&#34;your-tenant-id-here&#34;</span> -ClientId <span style=color:#d14>&#34;your-app-id-here&#34;</span> -ClientSecret <span style=color:#d14>&#34;your-app-secret-here&#34;</span> -NameMap
</code></pre></td></tr></table>
</div>
</div><p><div class=image>
<figure>
<a href=image-3-1024x71.png target=_blank>
<img src=image-3-1024x71.png alt=screenshot>
</a>
</figure>
</div></p>
<p>After running this script for the first time, you should see your new dummy computer objects in the OU you configured.</p>
<p><div class=image>
<figure>
<a href=image-15.png target=_blank>
<img src=image-15.png alt=screenshot>
</a>
</figure>
</div></p>
<p>Now, you should be able to perform successful device based 802.1X authentication on your devices. 👍</p>
<h3 id=expected-changes-for-readers>Expected changes for readers</h3>
<p>I would expect you need to make changes to the script based off of your needs. Here are a few things I think will vary between readers:</p>
<ul>
<li>Device name</li>
<li>I went with the AAD Device ID in my certificates</li>
<li>The org. unit where your dummy computer objects will live</li>
<li>The X509 certificate path used for name mapping</li>
<li>This is dependent on your CA and other factors. I was able to find this path by performing the name mapping in ADUC and looking at the &lsquo;altSecurityIdentities&rsquo; attribute on the object</li>
</ul>
<h2 id=closing-thoughts>Closing thoughts</h2>
<p>It took me several tries to nail this down and I would expect this on your end too. Analyzing NPS logs to see what I was missing was the most helpful troubleshooting step on my end.</p>
<p>I&rsquo;m not sure why Microsoft hasn&rsquo;t considered this or even followed up to the <a href=https://docs.microsoft.com/answers/questions/57999/device-certificate-scep-based-authentication-again.html>linked post above</a>. In an ideal world, Microsoft might create some sort of connector for on-prem. NPS to check AAD, as well as the local AD, for devices during authentications.</p>
<p>I realize that a solution like ClearPass would completely mitigate the need for a workaround like this. For many reasons, like budget, continuing to use NPS is ideal for my environment.</p>
<p>I hope this gets you to a decent starting point when you are considering device based authentication for your AADJ Windows devices.</p>
<img src=/authors/molly/avatar.png alt="Photo of SysManSquad"><br>
<strong>SysManSquad</strong>
<em>Staff</em>
<div>
<a href=https://twitter.com/sysmansquad><img src=/img/social/twitter.png></a>
</div>
<p>Molly, the best puppy</p>
<hr>
</div>
<div class=post-share>
<div class="post-share-box share-comments">
hello
</div>
</div>
<comments id=comments>
<script src=https://utteranc.es/client.js repo=SysManSquad/sysmansquadblog issue-term=title label="blog comment" theme=github-light crossorigin=anonymous async></script>
</comments>
</article>
</div>
</div>
</div>
<footer id=footer>
<div class=container>
<div id=footer-copyright>
<p class=copyright>&copy; 2022 WinAdmins - https://blog.sysmansquad.com - Systems Management Squad</a></p>
</div>
</div>
</footer>
</div>
</body>
</html>