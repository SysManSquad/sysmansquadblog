<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=keyword content="ConfigMgr Microsoft Intune Windows WinAdmins">
<meta name=viewport content="width=device-width">
<meta name=description content="A community blog and subsidiary of WinAdmins.io">
<link rel="shortcut icon" href=/img/favicon.ico>
<title>Updated Modern Driver/BIOS Management with CMG Support-SysManSquad | Systems Management Squad</title>
<link rel=canonical href=/2021/04/27/updated-modern-driver-bios-management-with-cmg-support/>
<link rel=stylesheet href=/css/style.css>
<link rel=stylesheet href=https://blog.sysmansquad.com/css/custom.css>
<script src=https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js></script>
<script src=https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js></script>
<script src=https://blog.sysmansquad.com/js/jquery.slicknav.js></script>
<script src=https://blog.sysmansquad.com/js/asd_SlickNav_Mobile.js></script>
<script src=https://blog.sysmansquad.com/js/custom.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZR1RSQYX"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-XXZR1RSQYX',{anonymize_ip:!1})}</script>
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://blog.sysmansquad.com/83">
<meta name=twitter:title content="Updated Modern Driver/BIOS Management with CMG Support">
<meta name=twitter:description content="<li class=&#34;uagb-toc__list&#34;> [Improvements to Invoke-GetPackageIDFromAdminService](#improvements-to-invoke-getpackageidfromadminservice)<ul class=&#34;uagb-toc__list&#34;> <li class=&#34;uagb-toc__list&#34;> [1) New parameters and ParameterSets](#1-new-parameters-and-parametersets)<li class=&#34;uagb-toc__list&#34;> <li class=&#34;uagb-toc__list&#34;> [2) Verify, Install and Import the MSAL.PS module](#2-verify-install-and-import-the-msalps-module)<li class=&#34;uagb-toc__list&#34;> <li class=&#34;uagb-toc__list&#34;> [3) Querying the AdminService](#3-querying-the-adminservice) </li></ul> </li></ul> </li></ul> </li> <li class=&#34;uagb-toc__list&#34;> [Improvements to the task sequence](#improvements-to-the-task-sequence)<ul class=&#34;uagb-toc__list&#34;> <li class=&#34;uagb-toc__list&#34;> [1) Is the client on Internet?](#1-is-the-client-on-internet)<li class=&#34;uagb-toc__list&#34;> <li class=&#34;uagb-toc__list&#34;> [2) Additional Parameters for Internet clients](#2-additional-parameters-for-internet-clients)<li class=&#34;uagb-toc__list&#34;> <li class=&#34;uagb-toc__list&#34;> [3) Running the script with the right parameters](#3-running-the-script-with-the-right-parameters) </li></ul> </li></ul> </li></ul> </li></ul> </li> <li class=&#34;uagb-toc__list&#34;> [The end result](#the-end-result)<li class=&#34;uagb-toc__list&#34;> [How do I set this up in my environment?">
</head>
<body class="home blog">
<div id=asd-container>
<div id=top-bar>
<div class=container>
<div id=nav-wrapper>
<ul class=menu id=menu-top-menu>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/>Home</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/about/>
<span>About</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=https://github.com/SysManSquad>
<span>GitHub</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/jointhesquad/>
<span>Join the Squad</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/meetthesquad/>
<span>Meet the Squad</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=#>
<span>MORE></span>
</a>
<ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/contact/>Contact</a>
</li>
</ul>
</li>
</ul>
</div>
<div id=top-search>
<a href=# class=search><i class="fa fa-search"></i></a>
<div class=show-search>
<form role=search method=get action=https://www.google.com/search id=searchform>
<input type=search placeholder="Search and hit enter..." name=q id=q title="Search and hit enter...">
<input type=hidden name=sitesearch value=https://blog.sysmansquad.com>
<button type=submit value=Search>
</form>
</div>
</div>
<div class=menu id=menu-mobile></div>
</div>
</div>
<header id=header class=noslider>
<div class=container>
<div id=logo>
<h1><a href=https://blog.sysmansquad.com><img src=/img/SysManSquad-HorizontalColor-Logo.png alt="Systems Management Squad"></a></h1>
</div>
</div>
</header>
<div class=container>
<div id=content>
<div id=main class=fullwidth>
<article class="post type-post status-publish format-standard has-post-thumbnail hentry">
<div class=post-header>
<h1>Updated Modern Driver/BIOS Management with CMG Support</h1>
<p class=p-meta>
<span class=post-date>April 28, 2021 / </span>
<span class=post-categories>Endpoint Management / </span>
<span class=post-categories>MECM/MEMCM/SCCM / </span>
<span class=post-categories>Powershell / </span>
<span class=post-categories>Task Sequence / </span>
</p>
</div>
<div class=post-entry>
<pre><code>        &lt;li class=&quot;uagb-toc__list&quot;&gt;
          [Improvements to Invoke-GetPackageIDFromAdminService](#improvements-to-invoke-getpackageidfromadminservice)&lt;ul class=&quot;uagb-toc__list&quot;&gt;
            &lt;li class=&quot;uagb-toc__list&quot;&gt;
              [1) New parameters and ParameterSets](#1-new-parameters-and-parametersets)&lt;li class=&quot;uagb-toc__list&quot;&gt;
                &lt;li class=&quot;uagb-toc__list&quot;&gt;
                  [2) Verify, Install and Import the MSAL.PS module](#2-verify-install-and-import-the-msalps-module)&lt;li class=&quot;uagb-toc__list&quot;&gt;
                    &lt;li class=&quot;uagb-toc__list&quot;&gt;
                      [3) Querying the AdminService](#3-querying-the-adminservice)
                    &lt;/li&gt;&lt;/ul&gt;
                  &lt;/li&gt;&lt;/ul&gt;
                &lt;/li&gt;&lt;/ul&gt;
              &lt;/li&gt;
              &lt;li class=&quot;uagb-toc__list&quot;&gt;
                [Improvements to the task sequence](#improvements-to-the-task-sequence)&lt;ul class=&quot;uagb-toc__list&quot;&gt;
                  &lt;li class=&quot;uagb-toc__list&quot;&gt;
                    [1) Is the client on Internet?](#1-is-the-client-on-internet)&lt;li class=&quot;uagb-toc__list&quot;&gt;
                      &lt;li class=&quot;uagb-toc__list&quot;&gt;
                        [2) Additional Parameters for Internet clients](#2-additional-parameters-for-internet-clients)&lt;li class=&quot;uagb-toc__list&quot;&gt;
                          &lt;li class=&quot;uagb-toc__list&quot;&gt;
                            [3) Running the script with the right parameters](#3-running-the-script-with-the-right-parameters)
                          &lt;/li&gt;&lt;/ul&gt;
                        &lt;/li&gt;&lt;/ul&gt;
                      &lt;/li&gt;&lt;/ul&gt;
                    &lt;/li&gt;&lt;/ul&gt;
                  &lt;/li&gt;
                  &lt;li class=&quot;uagb-toc__list&quot;&gt;
                    [The end result](#the-end-result)&lt;li class=&quot;uagb-toc__list&quot;&gt;
                      [How do I set this up in my environment?](#how-do-i-set-this-up-in-my-environment)&lt;ul class=&quot;uagb-toc__list&quot;&gt;
                        &lt;li class=&quot;uagb-toc__list&quot;&gt;
                          [What if I have multiple CMGs?](#what-if-i-have-multiple-cmgs)
                        &lt;/li&gt;
                      &lt;/ul&gt;
                    &lt;/li&gt;&lt;/ul&gt;
                  &lt;/li&gt;
                &lt;/ul&gt;
              &lt;/li&gt;&lt;/ul&gt;
            &lt;/li&gt;
          &lt;/ul&gt;
        &lt;/li&gt;
        
        &lt;li class=&quot;uagb-toc__list&quot;&gt;
          [A note on the task sequence size](#a-note-on-the-task-sequence-size)&lt;li class=&quot;uagb-toc__list&quot;&gt;
            [Links](#links)
          &lt;/li&gt;&lt;/ul&gt;
        &lt;/li&gt;
      &lt;/ul&gt;
    &lt;/li&gt;&lt;/ul&gt;
  &lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;
&lt;/ol&gt;
</code></pre>
<p>Hello,</p>
<p>This is a long and overdue update on a solution I started working on last year to allow my organization to use the modern driver management solution without the need of the custom webservice. I also wanted the solution to use the built-in task sequence steps as much as possible to allow other administrators to customize the solution to their need without the need to go modify a big PowerShell script.</p>
<p>You can read the original blog posts here:</p>
<p><strong>Modern Driver Management with the Administration Service</strong></p>
<p><strong>Modern BIOS Management with the Administration Service</strong></p>
<h2 id=notable-improvements>Notable improvements</h2>
<h2 id=prerequisites-to-use-the-solution-over-cmg>Prerequisites to use the solution over CMG</h2>
<h3 id=a-working-cmg>A working CMG</h3>
<p>There are multiple blog articles and guides online to help you set up your CMG. Here are some links that helped me:</p>
<ul>
<li><a href=https://docs.microsoft.com/en-us/mem/configmgr/core/clients/manage/cmg/setup-cloud-management-gateway>Official documentation/guidance from Microsoft</a></li>
<li><a href=https://systemcenterdudes.com/setup-and-configure-sccm-cloud-management-gateway-1806/>CMG Guide from System Center Dudes</a></li>
<li><a href=https://www.prajwaldesai.com/setup-sccm-cloud-management-gateway/>CMG Guide from Prajwal Desai</a></li>
</ul>
<p>Personally, for my lab, I used the <a href=https://z-nerd.com/blog/2019/05/20-lets-encrypt-cloud-management-gateway/>Let&rsquo;s Encrypt Cloud Management Gateway</a> blog post by Nathan Ziehnert to set up my CMG.</p>
<h3 id=additional-configuration-to-use-the-adminservice-over-cmg>Additional configuration to use the AdminService over CMG</h3>
<p>There is some additional configuration that is needed to be able to query the AdminService over the cloud management gateway.</p>
<p>Once again, another one of Nathan’s blog post helped me: <a href=https://z-nerd.com/blog/2019/12/03-adminservice-over-cmg/>Securing Access to the ConfigMgr AdminService Over Cloud Management Gateway</a></p>
<p>There are 2 things I had to do differently in the Authentication section:</p>
<ul>
<li>Add a platform and select “Mobile and desktop applications” and check the box for : <a href=https://login.microsoftonline.com/common/oauth2/nativeclient>https://login.microsoftonline.com/common/oauth2/nativeclient</a></li>
<li>Select “Yes” to Allow public client flows</li>
</ul>
<p><div class=image>
<figure>
<a href=image.png target=_blank>
<img src=image.png alt>
</a>
</figure>
</div> </p>
<h2 id=how-to-query-the-adminservice-over-cmg>How to query the AdminService over CMG?</h2>
<p>I started my research by reading the blog post from Sandy Zeng here: <a href=https://msendpointmgr.com/2019/07/16/use-configmgr-administration-service-adminservice-over-internet/>https://msendpointmgr.com/2019/07/16/use-configmgr-administration-service-adminservice-over-internet/</a></p>
<p>Also, at the same time, when I was looking at my application registration in the Azure Portal I saw this notification:</p>
<p><div class=image>
<figure>
<a href=image-1.png target=_blank>
<img src=image-1.png alt>
</a>
</figure>
</div> </p>
<p>After inspecting Sandy’s script, I confirmed that it was using Azure Active Directory Authentication Library (ADAL), so I wanted to make my solution work with MSAL instead of ADAL.</p>
<p>After doing some research, I found the perfect PowerShell module to help me: <a href=https://github.com/AzureAD/MSAL.PS/>MSAL.PS</a></p>
<p>With the help of that module, I was easily able to get an access token that is needed to query the AdminService over CMG.</p>
<h3 id=using-the-msalps-module>Using the MSAL.PS module</h3>
<p>Here is a sample script I used to test retrieving an access token with the MSAL.PS module:</p>
<p><div class=image>
<figure>
<a href=image-2.png target=_blank>
<img src=image-2.png alt>
</a>
</figure>
</div> </p>
<p>And here is what the result looks like:</p>
<p><div class=image>
<figure>
<a href=getmsaltoken-1-1024x873.png target=_blank>
<img src=getmsaltoken-1-1024x873.png alt>
</a>
</figure>
</div> </p>
<p>Now that I have an access token, I can easily query the AdminService over CMG. I reused the same part of the code used by Sandy to do this:</p>
<p><div class=image>
<figure>
<a href=image-4.png target=_blank>
<img src=image-4.png alt>
</a>
</figure>
</div> </p>
<p>In the example above, I was successfully able to retrieve information for 36 packages from the AdminService over CMG.</p>
<h2 id=improvements-to-invoke-getpackageidfromadminservice>Improvements to Invoke-GetPackageIDFromAdminService</h2>
<p>Now that I knew what information I needed to use to query the AdminService over CMG, I was ready to make the necessary modifications to my script.</p>
<h3 id=1-new-parameters-and-parametersets>1) New parameters and ParameterSets</h3>
<p>Depending on if the client is on the internet or not, my script would require a different set of parameters. This was the perfect opportunity to use <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_parameter_sets?view=powershell-7.1">parameter sets</a>.</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=12><a style=outline:none;text-decoration:none;color:inherit href=#12>12</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=13><a style=outline:none;text-decoration:none;color:inherit href=#13>13</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=14><a style=outline:none;text-decoration:none;color:inherit href=#14>14</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=15><a style=outline:none;text-decoration:none;color:inherit href=#15>15</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=16><a style=outline:none;text-decoration:none;color:inherit href=#16>16</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=17><a style=outline:none;text-decoration:none;color:inherit href=#17>17</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=18><a style=outline:none;text-decoration:none;color:inherit href=#18>18</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=19><a style=outline:none;text-decoration:none;color:inherit href=#19>19</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=20><a style=outline:none;text-decoration:none;color:inherit href=#20>20</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=21><a style=outline:none;text-decoration:none;color:inherit href=#21>21</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=22><a style=outline:none;text-decoration:none;color:inherit href=#22>22</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=23><a style=outline:none;text-decoration:none;color:inherit href=#23>23</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=24><a style=outline:none;text-decoration:none;color:inherit href=#24>24</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=25><a style=outline:none;text-decoration:none;color:inherit href=#25>25</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=26><a style=outline:none;text-decoration:none;color:inherit href=#26>26</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=27><a style=outline:none;text-decoration:none;color:inherit href=#27>27</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=28><a style=outline:none;text-decoration:none;color:inherit href=#28>28</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=29><a style=outline:none;text-decoration:none;color:inherit href=#29>29</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=30><a style=outline:none;text-decoration:none;color:inherit href=#30>30</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=31><a style=outline:none;text-decoration:none;color:inherit href=#31>31</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=32><a style=outline:none;text-decoration:none;color:inherit href=#32>32</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=33><a style=outline:none;text-decoration:none;color:inherit href=#33>33</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=34><a style=outline:none;text-decoration:none;color:inherit href=#34>34</a>
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>[<span style=color:#000;font-weight:700>parameter</span>(<span style=color:#000;font-weight:700>Mandatory</span> = <span style=color:teal>$true</span>, <span style=color:#000;font-weight:700>ParameterSetName</span> = <span style=color:#d14>&#34;Intranet&#34;</span>)]
[ValidateNotNullOrEmpty()]
<span style=color:teal>[string]</span><span style=color:teal>$ServerFQDN</span>,

[<span style=color:#000;font-weight:700>parameter</span>(<span style=color:#000;font-weight:700>Mandatory</span> = <span style=color:teal>$true</span>, <span style=color:#000;font-weight:700>ParameterSetName</span> = <span style=color:#d14>&#34;Internet&#34;</span>)]
[ValidateNotNullOrEmpty()]
<span style=color:teal>[string]</span><span style=color:teal>$ExternalUrl</span>,

[<span style=color:#000;font-weight:700>parameter</span>(<span style=color:#000;font-weight:700>Mandatory</span> = <span style=color:teal>$true</span>, <span style=color:#000;font-weight:700>ParameterSetName</span> = <span style=color:#d14>&#34;Internet&#34;</span>)]
[ValidateNotNullOrEmpty()]
<span style=color:teal>[string]</span><span style=color:teal>$TenantID</span>,

[<span style=color:#000;font-weight:700>parameter</span>(<span style=color:#000;font-weight:700>Mandatory</span> = <span style=color:teal>$true</span>, <span style=color:#000;font-weight:700>ParameterSetName</span> = <span style=color:#d14>&#34;Internet&#34;</span>)]
[ValidateNotNullOrEmpty()]
<span style=color:teal>[string]</span><span style=color:teal>$ClientID</span>,

[<span style=color:#000;font-weight:700>parameter</span>(<span style=color:#000;font-weight:700>Mandatory</span> = <span style=color:teal>$false</span>, <span style=color:#000;font-weight:700>ParameterSetName</span> = <span style=color:#d14>&#34;Internet&#34;</span>)]
[ValidateNotNullOrEmpty()]
<span style=color:teal>[string]</span><span style=color:teal>$ApplicationIdUri</span> = <span style=color:#d14>&#39;https://ConfigMgrService&#39;</span>,


[<span style=color:#000;font-weight:700>parameter</span>(<span style=color:#000;font-weight:700>Mandatory</span> = <span style=color:teal>$false</span>, <span style=color:#000;font-weight:700>ParameterSetName</span> = <span style=color:#d14>&#34;Intranet&#34;</span>)]
[<span style=color:#000;font-weight:700>parameter</span>(<span style=color:#000;font-weight:700>Mandatory</span> = <span style=color:teal>$true</span>, <span style=color:#000;font-weight:700>ParameterSetName</span> = <span style=color:#d14>&#34;Internet&#34;</span>)]
[ValidateNotNullOrEmpty()]
<span style=color:teal>[string]</span><span style=color:teal>$Username</span>,

[<span style=color:#000;font-weight:700>parameter</span>(<span style=color:#000;font-weight:700>Mandatory</span> = <span style=color:teal>$false</span>, <span style=color:#000;font-weight:700>ParameterSetName</span> = <span style=color:#d14>&#34;Intranet&#34;</span>)]
[<span style=color:#000;font-weight:700>parameter</span>(<span style=color:#000;font-weight:700>Mandatory</span> = <span style=color:teal>$true</span>, <span style=color:#000;font-weight:700>ParameterSetName</span> = <span style=color:#d14>&#34;Internet&#34;</span>)]
[ValidateNotNullOrEmpty()]
<span style=color:teal>[string]</span><span style=color:teal>$Password</span>,

[<span style=color:#000;font-weight:700>parameter</span>(<span style=color:#000;font-weight:700>Mandatory</span> = <span style=color:teal>$false</span>, <span style=color:#000;font-weight:700>ParameterSetName</span> = <span style=color:#d14>&#34;Intranet&#34;</span>)]
[<span style=color:#000;font-weight:700>parameter</span>(<span style=color:#000;font-weight:700>Mandatory</span> = <span style=color:teal>$false</span>, <span style=color:#000;font-weight:700>ParameterSetName</span> = <span style=color:#d14>&#34;Internet&#34;</span>)]
<span style=color:teal>[bool]</span><span style=color:teal>$BypassCertCheck</span> = <span style=color:teal>$false</span>,
</code></pre></td></tr></table>
</div>
</div><h3 id=2-verify-install-and-import-the-msalps-module>2) Verify, Install and Import the MSAL.PS module</h3>
<p>I wrote a function to handle installing & importing the MSAL.PS.</p>
<p>The tricky part here is that the MSAL.PS module requires us to accept the license agreement before we can install the module. There is a parameter <strong>-AcceptLicense</strong> for the Install-Module function but it is only available in the <a href=https://docs.microsoft.com/en-us/powershell/module/powershellget>PowerShellGet module</a> version 2 or higher.</p>
<p>This function checks for the availability of the MSAL.PS module and if it’s not there it will check for the prerequisites to install before it can import the module.</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=12><a style=outline:none;text-decoration:none;color:inherit href=#12>12</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=13><a style=outline:none;text-decoration:none;color:inherit href=#13>13</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=14><a style=outline:none;text-decoration:none;color:inherit href=#14>14</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=15><a style=outline:none;text-decoration:none;color:inherit href=#15>15</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=16><a style=outline:none;text-decoration:none;color:inherit href=#16>16</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=17><a style=outline:none;text-decoration:none;color:inherit href=#17>17</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=18><a style=outline:none;text-decoration:none;color:inherit href=#18>18</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=19><a style=outline:none;text-decoration:none;color:inherit href=#19>19</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=20><a style=outline:none;text-decoration:none;color:inherit href=#20>20</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=21><a style=outline:none;text-decoration:none;color:inherit href=#21>21</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=22><a style=outline:none;text-decoration:none;color:inherit href=#22>22</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=23><a style=outline:none;text-decoration:none;color:inherit href=#23>23</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=24><a style=outline:none;text-decoration:none;color:inherit href=#24>24</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=25><a style=outline:none;text-decoration:none;color:inherit href=#25>25</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=26><a style=outline:none;text-decoration:none;color:inherit href=#26>26</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=27><a style=outline:none;text-decoration:none;color:inherit href=#27>27</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=28><a style=outline:none;text-decoration:none;color:inherit href=#28>28</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=29><a style=outline:none;text-decoration:none;color:inherit href=#29>29</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=30><a style=outline:none;text-decoration:none;color:inherit href=#30>30</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=31><a style=outline:none;text-decoration:none;color:inherit href=#31>31</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=32><a style=outline:none;text-decoration:none;color:inherit href=#32>32</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=33><a style=outline:none;text-decoration:none;color:inherit href=#33>33</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=34><a style=outline:none;text-decoration:none;color:inherit href=#34>34</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=35><a style=outline:none;text-decoration:none;color:inherit href=#35>35</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=36><a style=outline:none;text-decoration:none;color:inherit href=#36>36</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=37><a style=outline:none;text-decoration:none;color:inherit href=#37>37</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=38><a style=outline:none;text-decoration:none;color:inherit href=#38>38</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=39><a style=outline:none;text-decoration:none;color:inherit href=#39>39</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=40><a style=outline:none;text-decoration:none;color:inherit href=#40>40</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=41><a style=outline:none;text-decoration:none;color:inherit href=#41>41</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=42><a style=outline:none;text-decoration:none;color:inherit href=#42>42</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=43><a style=outline:none;text-decoration:none;color:inherit href=#43>43</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=44><a style=outline:none;text-decoration:none;color:inherit href=#44>44</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=45><a style=outline:none;text-decoration:none;color:inherit href=#45>45</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=46><a style=outline:none;text-decoration:none;color:inherit href=#46>46</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=47><a style=outline:none;text-decoration:none;color:inherit href=#47>47</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=48><a style=outline:none;text-decoration:none;color:inherit href=#48>48</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=49><a style=outline:none;text-decoration:none;color:inherit href=#49>49</a>
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#000;font-weight:700>Function</span> <span style=color:#0086b3>Import-MSALPSModule</span>{
    <span style=color:#0086b3>Add-TextToCMLog</span> <span style=color:teal>$LogFile</span> <span style=color:#d14>&#34;Checking if MSAL.PS module is available on the device.&#34;</span> <span style=color:teal>$component</span> 1
    <span style=color:teal>$MSALModule</span> = <span style=color:#0086b3>Get-Module</span> -ListAvailable MSAL.<span style=color:#0086b3>PS
</span><span style=color:#0086b3></span>    <span style=color:#000;font-weight:700>If</span>(<span style=color:teal>$MSALModule</span>){
        <span style=color:#0086b3>Add-TextToCMLog</span> <span style=color:teal>$LogFile</span> <span style=color:#d14>&#34;Module is already available.&#34;</span> <span style=color:teal>$component</span> 1
    }<span style=color:#000;font-weight:700>Else</span>{
        <span style=color:#998;font-style:italic>#Setting PowerShell to use TLS 1.2 for PowerShell Gallery</span>
        <span style=color:teal>[Net.ServicePointManager]</span>::SecurityProtocol = <span style=color:teal>[Net.SecurityProtocolType]</span>::Tls12
        
        <span style=color:#0086b3>Add-TextToCMLog</span> <span style=color:teal>$LogFile</span> <span style=color:#d14>&#34;MSAL.PS is not installed, checking for prerequisites before installing module.&#34;</span> <span style=color:teal>$component</span> 1
        
        <span style=color:#0086b3>Add-TextToCMLog</span> <span style=color:teal>$LogFile</span> <span style=color:#d14>&#34;Checking for NuGet package provider... &#34;</span> <span style=color:teal>$component</span> 1
        <span style=color:#000;font-weight:700>If</span>(<span style=color:#000;font-weight:700>-not</span> (<span style=color:#0086b3>Get-PackageProvider</span> -Name NuGet -ListAvailable -ErrorAction SilentlyContinue)){
            <span style=color:#0086b3>Add-TextToCMLog</span> <span style=color:teal>$LogFile</span> <span style=color:#d14>&#34;NuGet package provider is not installed, installing NuGet...&#34;</span> <span style=color:teal>$component</span> 1
            <span style=color:teal>$NuGetVersion</span> = <span style=color:#0086b3>Install-PackageProvider</span> -Name NuGet -Force -ErrorAction Stop | <span style=color:#0086b3>Select-Object</span> -ExpandProperty Version
            <span style=color:#0086b3>Add-TextToCMLog</span> <span style=color:teal>$LogFile</span> <span style=color:#d14>&#34;NuGet package provider version </span>$(<span style=color:teal>$NuGetVersion</span>)<span style=color:#d14> installed.&#34;</span> <span style=color:teal>$component</span> 1
        }
        
        <span style=color:#0086b3>Add-TextToCMLog</span> <span style=color:teal>$LogFile</span> <span style=color:#d14>&#34;Checking for PowerShellGet module version 2 or higher &#34;</span> <span style=color:teal>$component</span> 1
        <span style=color:teal>$PowerShellGetLatestVersion</span> = <span style=color:#0086b3>Get-Module</span> -ListAvailable -Name PowerShellGet | <span style=color:#0086b3>Sort-Object</span> -Property Version -Descending | <span style=color:#0086b3>Select-Object</span> -First 1 -ExpandProperty Version       
        <span style=color:#000;font-weight:700>If</span>((<span style=color:#000;font-weight:700>-not</span> <span style=color:teal>$PowerShellGetLatestVersion</span>)){
            <span style=color:#0086b3>Add-TextToCMLog</span> <span style=color:teal>$LogFile</span> <span style=color:#d14>&#34;Could not find any version of PowerShellGet installed.&#34;</span> <span style=color:teal>$component</span> 1
        }
        <span style=color:#000;font-weight:700>If</span>((<span style=color:teal>$PowerShellGetLatestVersion</span>.Major <span style=color:#000;font-weight:700>-lt</span> 2)){
            <span style=color:#0086b3>Add-TextToCMLog</span> <span style=color:teal>$LogFile</span> <span style=color:#d14>&#34;Current PowerShellGet version is </span>$(<span style=color:teal>$PowerShellGetLatestVersion</span>)<span style=color:#d14> and needs to be updated.&#34;</span> <span style=color:teal>$component</span> 1
        }
        <span style=color:#000;font-weight:700>If</span>((<span style=color:#000;font-weight:700>-not</span> <span style=color:teal>$PowerShellGetLatestVersion</span>) <span style=color:#000;font-weight:700>-or</span> (<span style=color:teal>$PowerShellGetLatestVersion</span>.Major <span style=color:#000;font-weight:700>-lt</span> 2)){
            <span style=color:#0086b3>Add-TextToCMLog</span> <span style=color:teal>$LogFile</span> <span style=color:#d14>&#34;Installing latest version of PowerShellGet...&#34;</span> <span style=color:teal>$component</span> 1
            <span style=color:#0086b3>Install-Module</span> -Name PowerShellGet -AllowClobber -Force
            <span style=color:teal>$InstalledVersion</span> = <span style=color:#0086b3>Get-Module</span> -ListAvailable -Name PowerShellGet | <span style=color:#0086b3>Sort-Object</span> -Property Version -Descending | <span style=color:#0086b3>Select-Object</span> -First 1 -ExpandProperty Version
            <span style=color:#0086b3>Add-TextToCMLog</span> <span style=color:teal>$LogFile</span> <span style=color:#d14>&#34;PowerShellGet module version </span>$(<span style=color:teal>$InstalledVersion</span>)<span style=color:#d14> installed.&#34;</span> <span style=color:teal>$component</span> 1
        }
        
        <span style=color:#0086b3>Add-TextToCMLog</span> <span style=color:teal>$LogFile</span> <span style=color:#d14>&#34;Installing MSAL.PS module...&#34;</span> <span style=color:teal>$component</span> 1
        <span style=color:#000;font-weight:700>If</span>((<span style=color:#000;font-weight:700>-not</span> <span style=color:teal>$PowerShellGetLatestVersion</span>) <span style=color:#000;font-weight:700>-or</span> (<span style=color:teal>$PowerShellGetLatestVersion</span>.Major <span style=color:#000;font-weight:700>-lt</span> 2)){
            <span style=color:#0086b3>Add-TextToCMLog</span> <span style=color:teal>$LogFile</span> <span style=color:#d14>&#34;Starting another powershell process to install the module...&#34;</span> <span style=color:teal>$component</span> 1
            <span style=color:teal>$result</span> = <span style=color:#0086b3>Start-Process</span> -FilePath powershell.exe -ArgumentList <span style=color:#d14>&#34;Install-Module MSAL.PS -AcceptLicense -Force&#34;</span> -PassThru -Wait -NoNewWindow
            <span style=color:#000;font-weight:700>If</span>(<span style=color:teal>$result</span>.ExitCode <span style=color:#000;font-weight:700>-ne</span> 0){
                <span style=color:#0086b3>Add-TextToCMLog</span> <span style=color:teal>$LogFile</span> <span style=color:#d14>&#34;Failed to install MSAL.PS module&#34;</span> <span style=color:teal>$component</span> 3
                <span style=color:#000;font-weight:700>Throw</span> <span style=color:#d14>&#34;Failed to install MSAL.PS module&#34;</span>
            }
        }<span style=color:#000;font-weight:700>Else</span>{
            <span style=color:#0086b3>Install-Module</span> MSAL.<span style=color:#0086b3>PS </span>-AcceptLicense -Force
        }
    }
    <span style=color:#0086b3>Add-TextToCMLog</span> <span style=color:teal>$LogFile</span> <span style=color:#d14>&#34;Importing MSAL.PS module...&#34;</span> <span style=color:teal>$component</span> 1
    <span style=color:#0086b3>Import-module</span> MSAL.<span style=color:#0086b3>PS </span>-Force
    <span style=color:#0086b3>Add-TextToCMLog</span> <span style=color:teal>$LogFile</span> <span style=color:#d14>&#34;MSAL.PS module successfully imported.&#34;</span> <span style=color:teal>$component</span> 1
}
</code></pre></td></tr></table>
</div>
</div><h4 id=what-about-winpe-powershell-gallery-does-not-work-in-winpe>What about WinPE? PowerShell Gallery does not work in WinPE!</h4>
<p>You are right, by default PowerShell Gallery does not work in WinPE. To solve this issue, you have 2 options:</p>
<pre><code>  &lt;div class=&quot;wp-block-media-text__content&quot;&gt;
    &lt;p&gt;
      a) Create a package with the saved module and distribute it to your CMG
    &lt;/p&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<pre><code>      &lt;div class=&quot;wp-block-media-text__content&quot;&gt;
        &lt;p&gt;
          b) Edit the package in the “Manually install MSAL.PS module” step:
        &lt;/p&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<p>Both options will allow you to install and import the MSAL.PS module in WinPE.</p>
<p>If you decide to go with enabling support for PowerShell Gallery in WinPE, you can disable the step to manually install the module in the task sequence.</p>
<h3 id=3-querying-the-adminservice>3) Querying the AdminService</h3>
<p>Now, depending on what parameters were used, we will query the AdminService locally or via the CMG:</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=12><a style=outline:none;text-decoration:none;color:inherit href=#12>12</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=13><a style=outline:none;text-decoration:none;color:inherit href=#13>13</a>
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#000;font-weight:700>switch</span>(<span style=color:teal>$PSCmdlet</span>.<span style=color:#000;font-weight:700>ParameterSetName</span>){
    <span style=color:#d14>&#39;Intranet&#39;</span>{
        <span style=color:teal>$Packages</span> = <span style=color:#0086b3>Invoke-RestMethod</span> -Method Get -Uri <span style=color:teal>$WMIPackageURL</span> -Body <span style=color:teal>$Body</span> <span style=color:teal>@InvokeRestMethodCredential</span> | <span style=color:#0086b3>Select-Object</span> -ExpandProperty value
    }
    <span style=color:#d14>&#39;Internet&#39;</span>{
        <span style=color:teal>$authHeader</span> = @{
            <span style=color:#d14>&#39;Content-Type&#39;</span>  = <span style=color:#d14>&#39;application/json&#39;</span>
            <span style=color:#d14>&#39;Authorization&#39;</span> = <span style=color:#d14>&#34;Bearer &#34;</span> + <span style=color:teal>$token</span>.AccessToken
            <span style=color:#d14>&#39;ExpiresOn&#39;</span>	    = <span style=color:teal>$token</span>.ExpiresOn
        }
        <span style=color:teal>$Packages</span> = <span style=color:#0086b3>Invoke-RestMethod</span> -Method Get -Uri <span style=color:teal>$WMIPackageURL</span> -Headers <span style=color:teal>$authHeader</span> -Body <span style=color:teal>$Body</span> | <span style=color:#0086b3>Select-Object</span> -ExpandProperty value
    }
} 
</code></pre></td></tr></table>
</div>
</div><p>The rest of the script to filter and select the most suitable package did not change.</p>
<h2 id=improvements-to-the-task-sequence>Improvements to the task sequence</h2>
<p>Now that the script itself supports querying over CMG, I needed to make some adjustments to the “<strong>Query AdminService for PackageID</strong>” task sequence to properly call the script with the right parameters.</p>
<h3 id=1-is-the-client-on-internet>1) Is the client on Internet?</h3>
<p>We need to determine if the device running the task sequence is on Internet or on the corporate network (intranet).</p>
<p>First, we try using the _SMSTSIsClientOnInternet task sequence variable:</p>
<p><div class=image>
<figure>
<a href=image-6.png target=_blank>
<img src=image-6.png alt>
</a>
</figure>
</div> </p>
<p>Note: In my limited testing, I found that if a task sequence does not reference any package, this variable may not be set.</p>
<p>If the “ClientIsOnInternet” is still not set after this step and device is not in WinPE, we use the following PowerShell command to determine if the device is on Internet:</p>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=1><a style=outline:none;text-decoration:none;color:inherit href=#1>1</a>
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#0086b3>Get-CimInstance</span> -ClassName <span style=color:#d14>&#34;ClientInfo&#34;</span> -Namespace <span style=color:#d14>&#34;Root\CCM&#34;</span> | <span style=color:#0086b3>Select-Object</span> -ExpandProperty InInternet
</code></pre></td></tr></table>
</div>
</div>
<p><div class=image>
<figure>
<a href=clientinfo-1024x613.png target=_blank>
<img src=clientinfo-1024x613.png alt>
</a>
</figure>
</div> </p>
<h3 id=2-additional-parameters-for-internet-clients>2) Additional Parameters for Internet clients</h3>
<p>Here you fill out your environment-specific information. The additional parameters needed for CMG support are:</p>
<ul>
<li>ExternalUrl: The ExternalUrl to access the AdminService from your CMG. The following query can be used to find the ExternalUrl:</li>
</ul>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=1><a style=outline:none;text-decoration:none;color:inherit href=#1>1</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=2><a style=outline:none;text-decoration:none;color:inherit href=#2>2</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=3><a style=outline:none;text-decoration:none;color:inherit href=#3>3</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=4><a style=outline:none;text-decoration:none;color:inherit href=#4>4</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=5><a style=outline:none;text-decoration:none;color:inherit href=#5>5</a>
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#000;font-weight:700>SELECT</span><span style=color:#bbb> 
</span><span style=color:#bbb></span>ProxyServerName,<span style=color:#bbb>
</span><span style=color:#bbb></span>ExternalUrl<span style=color:#bbb> 
</span><span style=color:#bbb></span><span style=color:#000;font-weight:700>FROM</span><span style=color:#bbb> </span>[dbo].[vProxy_Routings]<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#000;font-weight:700>WHERE</span><span style=color:#bbb> </span>[dbo].[vProxy_Routings].ExternalEndpointName<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span><span style=color:#d14>&#39;AdminService&#39;</span><span style=color:#bbb>
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>TenantId: Your Azure AD Tenant ID</li>
<li>ClientId: The Client ID of the application registration that you created to interact with the AdminService. See <a href="https://sysmansquad.com/wp-admin/post.php?post=2552&action=edit#additional-configuration-to-use-the-adminservice-over-cmg">additional configuration to use the AdminService over CMG</a> for details.</li>
<li>ApplicationIdUri: The application ID Uri for your application registration. The default value of &ldquo;https://ConfigMgrService&rdquo; will probably be OK for most people.</li>
</ul>
<p><div class=image>
<figure>
<a href=setparam-1024x503.png target=_blank>
<img src=setparam-1024x503.png alt>
</a>
</figure>
</div> </p>
<h3 id=3-running-the-script-with-the-right-parameters>3) Running the script with the right parameters</h3>
<p>Depending on the value of the “ClientIsOnInternet” variable, we run the script with different parameters.</p>
<p>If the client is determined to be intranet, use the intranet parameters:</p>
<p><div class=image>
<figure>
<a href=invoke-intranet-1024x357.png target=_blank>
<img src=invoke-intranet-1024x357.png alt>
</a>
</figure>
</div> </p>
<p>If the client is on Internet, use the internet parameters:</p>
<p><div class=image>
<figure>
<a href=invoke-internet-1024x262.png target=_blank>
<img src=invoke-internet-1024x262.png alt>
</a>
</figure>
</div> </p>
<h2 id=the-end-result>The end result</h2>
<p>You can now use the Modern Driver Management and Modern BIOS Management solution for Internet clients just like you are doing with your intranet clients.</p>
<p>If you are on Current Branch 2010 or later, you can use a boot media to run bare metal deployment on the Internet and still use the Modern Driver/BIOS Management solution.</p>
<p><div class=image>
<figure>
<a href=log-921x1024.png target=_blank>
<img src=log-921x1024.png alt>
</a>
</figure>
</div> </p>
<h2 id=how-do-i-set-this-up-in-my-environment>How do I set this up in my environment?</h2>
<ol>
<li>Download the task sequences <a href=https://github.com/CharlesNRU/mdm-adminservice/raw/master/MDM-TS.zip>here</a>.</li>
<li>Import the task sequences in your environment</li>
<li>Configure the parameters correctly in the “Query AdminService for PackageID” task sequence:</li>
</ol>
<p><div class=image>
<figure>
<a href=setparam-1024x503.png target=_blank>
<img src=setparam-1024x503.png alt>
</a>
</figure>
</div> </p>
<p>For example on what you can do with these task sequences, see my previous blog posts:</p>
<ul>
<li><a href=https://sysmansquad.com/2020/05/15/modern-driver-management-with-the-administration-service/>https://sysmansquad.com/2020/05/15/modern-driver-management-with-the-administration-service/</a></li>
<li><a href=https://sysmansquad.com/2020/06/18/modern-bios-management-with-the-administration-service/>https://sysmansquad.com/2020/06/18/modern-bios-management-with-the-administration-service/</a></li>
</ul>
<h3 id=what-if-i-have-multiple-cmgs>What if I have multiple CMGs?</h3>
<p>There is nothing stopping you from writing a small script to detect/check which CMG to use and then set the &ldquo;AS_ExternalUrl&rdquo; variable to whatever you want.</p>
<p>Now you have support for multiple CMGs 🙂</p>
<h2 id=a-note-on-the-task-sequence-size>A note on the task sequence size</h2>
<p>Currently, the scripts used in this solution are added directly in the task sequence instead of referencing a package containing the scripts. As you can see below, the task sequence size can be somewhat big:</p>
<p><div class=image>
<figure>
<a href=tasksequencesize-1024x193.png target=_blank>
<img src=tasksequencesize-1024x193.png alt>
</a>
</figure>
</div> </p>
<p>If you are concerned about the total size of the task sequence, you could store the scripts in a package instead and this would greatly reduce the size of the task sequence.</p>
<p>Reference regarding task sequence size: <a href=https://docs.microsoft.com/en-us/mem/configmgr/osd/deploy-use/manage-task-sequences-to-automate-tasks#reduce-the-size-of-task-sequence-policy>https://docs.microsoft.com/en-us/mem/configmgr/osd/deploy-use/manage-task-sequences-to-automate-tasks#reduce-the-size-of-task-sequence-policy</a></p>
<h2 id=links>Links</h2>
<p><a href=https://github.com/CharlesNRU/mdm-adminservice/raw/master/MDM-TS.zip>Task Sequence Exports</a></p>
<p><a href=https://github.com/CharlesNRU/mdm-adminservice>MDM-AdminService GitHub repository</a></p>
</div>
<div class=post-share>
<div class="post-share-box share-comments">
hello
</div>
</div>
<comments id=comments>
<script src=https://utteranc.es/client.js repo=SysManSquad/sysmansquadblog issue-term=title label="blog comment" theme=github-light crossorigin=anonymous async></script>
</comments>
</article>
</div>
</div>
</div>
<footer id=footer>
<div class=container>
<div id=footer-copyright>
<p class=copyright>&copy; 2022 WinAdmins - https://blog.sysmansquad.com - Systems Management Squad</a></p>
</div>
</div>
</footer>
</div>
</body>
</html>