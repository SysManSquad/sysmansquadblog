<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=keyword content="ConfigMgr Microsoft Intune Windows WinAdmins">
<meta name=viewport content="width=device-width">
<meta name=description content="A community blog and subsidiary of WinAdmins.io">
<link rel="shortcut icon" href=/img/favicon.ico>
<title>Automating Outside of Business Hours Responses-SysManSquad | Systems Management Squad</title>
<link rel=canonical href=/2020/12/30/automating-changing-out-of-business-hours-responses/>
<link rel=stylesheet href=/css/style.css>
<link rel=stylesheet href=https://blog.sysmansquad.com/css/custom.css>
<script src=https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js></script>
<script src=https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js></script>
<script src=https://blog.sysmansquad.com/js/jquery.slicknav.js></script>
<script src=https://blog.sysmansquad.com/js/asd_SlickNav_Mobile.js></script>
<script src=https://blog.sysmansquad.com/js/custom.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZR1RSQYX"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-XXZR1RSQYX',{anonymize_ip:!1})}</script>
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://blog.sysmansquad.com/83">
<meta name=twitter:title content="Automating Outside of Business Hours Responses">
<meta name=twitter:description content="Have you ever had customers emailing in outside of hours? In this post we will setup some scripted automatic maintenance of Auto-Reply responses on a user account.
We considered several possibilities but the customer did not have an Azure Subscription yet, we ended up using PowerShell, Microsoft Graph, App Authentication, and a Scheduled Task.">
</head>
<body class="home blog">
<div id=asd-container>
<div id=top-bar>
<div class=container>
<div id=nav-wrapper>
<ul class=menu id=menu-top-menu>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/>Home</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/about/>
<span>About</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=https://github.com/SysManSquad>
<span>GitHub</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/jointhesquad/>
<span>Join the Squad</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/meetthesquad/>
<span>Meet the Squad</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=#>
<span>MORE></span>
</a>
<ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/contact/>Contact</a>
</li>
</ul>
</li>
</ul>
</div>
<div id=top-search>
<a href=# class=search><i class="fa fa-search"></i></a>
<div class=show-search>
<form role=search method=get action=https://www.google.com/search id=searchform>
<input type=search placeholder="Search and hit enter..." name=q id=q title="Search and hit enter...">
<input type=hidden name=sitesearch value=https://blog.sysmansquad.com>
<button type=submit value=Search>
</form>
</div>
</div>
<div class=menu id=menu-mobile></div>
</div>
</div>
<header id=header class=noslider>
<div class=container>
<div id=logo>
<h1><a href=https://blog.sysmansquad.com><img src=/img/SysManSquad-HorizontalColor-Logo.png alt="Systems Management Squad"></a></h1>
</div>
</div>
</header>
<div class=container>
<div id=content>
<div id=main class=fullwidth>
<article class="post type-post status-publish format-standard has-post-thumbnail hentry">
<div class=post-header>
<h1>Automating Outside of Business Hours Responses</h1>
<p class=p-meta>
<span class=post-date>December 30, 2020 / </span>
<span class=post-categories>Azure / </span>
<span class=post-categories>Endpoint Management / </span>
<span class=post-categories>Graph / </span>
<span class=post-categories>How-To / </span>
<span class=post-categories>Microsoft / </span>
<span class=post-categories>Powershell / </span>
<span class=post-categories>Scripting / </span>
</p>
</div>
<div class=post-entry>
<p>Have you ever had customers emailing in outside of hours? In this post we will setup some scripted automatic maintenance of Auto-Reply responses on a user account.</p>
<p>We considered several possibilities but the customer did not have an Azure Subscription yet, we ended up using <strong>PowerShell</strong>, <strong>Microsoft Graph</strong>, <strong>App Authentication</strong>, and a <strong>Scheduled Task</strong>.</p>
<p>Our customer will be moving to Azure later so we will probably revisit this as Azure Functions, or possibly Power Automate later on. For now, we went through a few options for these responses:</p>
<ul>
<li>Ticketing system responses</li>
<li>Outlook rules</li>
<li>Out-of-office responses</li>
<li>Some tool or process to receive and process emails and respond at appropriate times</li>
</ul>
<pre><code>            &lt;p&gt;
              We chose to use the **out-of-office responses** for our setup, because they would not need a separate server/service to run them, a running copy of Outlook to process them, and this customer did not have a current Azure Subscription to charge against for a more server-less solution like Azure Automation, Functions, or Power Automate.
            &lt;/p&gt;
            
            &lt;p&gt;
              So, since Microsoft doesn't have a way to set up multiple sets of responses ahead of time, we need to create:
            &lt;/p&gt;
            
            &lt;ul&gt;
              &lt;li&gt;
                something to make the changes &lt;ul&gt;
                  &lt;li&gt;
                    our script below will use **Microsoft Graph** to update the user's **Auto-Reply** settings
                  &lt;/li&gt;
                &lt;/ul&gt;
              &lt;/li&gt;
              
              &lt;li&gt;
                a way for our script to log in without a user present&lt;ul&gt;
                  &lt;li&gt;
                    we set up **Certificate Authentication** so that we can have this working securely, without a password or token to compromise
                  &lt;/li&gt;
                &lt;/ul&gt;
              &lt;/li&gt;
              
              &lt;li&gt;
                and an automated way to run our script&lt;ul&gt;
                  &lt;li&gt;
                    we opted for a **Scheduled Task** just as a simple way to schedule the update script to run regularly and access the certificate we will use to authenticate to **MS Graph**
                  &lt;/li&gt;
                &lt;/ul&gt;
              &lt;/li&gt;
            &lt;/ul&gt;
</code></pre>
<h2 id=create-our-app-registration>Create our App Registration</h2>
<pre><code>            &lt;p&gt;
              First, we need to create an App to use for authentication, so that a user or administrator doesn't have to log in every time to run this. Just like my last post, where we created an app registration to [Find Microsoft Accounts on your company domain](https://sysmansquad.com/2020/11/23/find-microsoft-accounts/#setting-up-your-app-registration), we need to register an App for our script to authenticate and be granted permissions.
            &lt;/p&gt;
            
            &lt;p&gt;
              This time, for our setup process we will:
            &lt;/p&gt;
            
            &lt;ul&gt;
              &lt;li&gt;
                create a **single tenant** app
              &lt;/li&gt;
              &lt;li&gt;
                add API Permissions to **ReadWrite **all **MailboxSettings**&lt;ul&gt;
                  &lt;li&gt;
                    in my example, I am requesting ReadWrite to all, but you should be able to [scope it to specific users](https://docs.microsoft.com/en-us/graph/auth-limit-mailbox-access) for a more secure implementation
                  &lt;/li&gt;
                &lt;/ul&gt;
              &lt;/li&gt;
              
              &lt;li&gt;
                create a **certificate** for authentication
              &lt;/li&gt;
              &lt;li&gt;
                upload the authentication **certificate** to the new **App**
              &lt;/li&gt;
              &lt;li&gt;
                export local copies of the **Public cert** and **PFX **to C:\Temp&lt;ul&gt;
                  &lt;li&gt;
                    if you need to set this Script up on another machine, you will need to import the **PFX** into the **user store** on that **machine**
                  &lt;/li&gt;
                &lt;/ul&gt;
              &lt;/li&gt;
              
              &lt;li&gt;
                grant **Admin Consent** for the **app permissions**
              &lt;/li&gt;
              &lt;li&gt;
                Generate our **Connect-MGGraph** Command to use in the out-of-office automation script
              &lt;/li&gt;
            &lt;/ul&gt;
            
            &lt;p&gt;
              This is a long list of tasks, and for more details and a more GUI-based walkthrough, I recommend you check out [this post](https://laurakokkarinen.com/authenticating-to-office-365-apis-with-a-certificate-step-by-step/#creating-the-certificate). For the ease of my setup (and to keep this a reasonable length) I included a script below to set everything up.
            &lt;/p&gt;
            
            &lt;p&gt;
              Just setup the first few variables on lines 2-4 with your options
            &lt;/p&gt;
</code></pre>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=12><a style=outline:none;text-decoration:none;color:inherit href=#12>12</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=13><a style=outline:none;text-decoration:none;color:inherit href=#13>13</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=14><a style=outline:none;text-decoration:none;color:inherit href=#14>14</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=15><a style=outline:none;text-decoration:none;color:inherit href=#15>15</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=16><a style=outline:none;text-decoration:none;color:inherit href=#16>16</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=17><a style=outline:none;text-decoration:none;color:inherit href=#17>17</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=18><a style=outline:none;text-decoration:none;color:inherit href=#18>18</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=19><a style=outline:none;text-decoration:none;color:inherit href=#19>19</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=20><a style=outline:none;text-decoration:none;color:inherit href=#20>20</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=21><a style=outline:none;text-decoration:none;color:inherit href=#21>21</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=22><a style=outline:none;text-decoration:none;color:inherit href=#22>22</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=23><a style=outline:none;text-decoration:none;color:inherit href=#23>23</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=24><a style=outline:none;text-decoration:none;color:inherit href=#24>24</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=25><a style=outline:none;text-decoration:none;color:inherit href=#25>25</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=26><a style=outline:none;text-decoration:none;color:inherit href=#26>26</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=27><a style=outline:none;text-decoration:none;color:inherit href=#27>27</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=28><a style=outline:none;text-decoration:none;color:inherit href=#28>28</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=29><a style=outline:none;text-decoration:none;color:inherit href=#29>29</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=30><a style=outline:none;text-decoration:none;color:inherit href=#30>30</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=31><a style=outline:none;text-decoration:none;color:inherit href=#31>31</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=32><a style=outline:none;text-decoration:none;color:inherit href=#32>32</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=33><a style=outline:none;text-decoration:none;color:inherit href=#33>33</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=34><a style=outline:none;text-decoration:none;color:inherit href=#34>34</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=35><a style=outline:none;text-decoration:none;color:inherit href=#35>35</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=36><a style=outline:none;text-decoration:none;color:inherit href=#36>36</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=37><a style=outline:none;text-decoration:none;color:inherit href=#37>37</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=38><a style=outline:none;text-decoration:none;color:inherit href=#38>38</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=39><a style=outline:none;text-decoration:none;color:inherit href=#39>39</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=40><a style=outline:none;text-decoration:none;color:inherit href=#40>40</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=41><a style=outline:none;text-decoration:none;color:inherit href=#41>41</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=42><a style=outline:none;text-decoration:none;color:inherit href=#42>42</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=43><a style=outline:none;text-decoration:none;color:inherit href=#43>43</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=44><a style=outline:none;text-decoration:none;color:inherit href=#44>44</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=45><a style=outline:none;text-decoration:none;color:inherit href=#45>45</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=46><a style=outline:none;text-decoration:none;color:inherit href=#46>46</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=47><a style=outline:none;text-decoration:none;color:inherit href=#47>47</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=48><a style=outline:none;text-decoration:none;color:inherit href=#48>48</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=49><a style=outline:none;text-decoration:none;color:inherit href=#49>49</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=50><a style=outline:none;text-decoration:none;color:inherit href=#50>50</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=51><a style=outline:none;text-decoration:none;color:inherit href=#51>51</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=52><a style=outline:none;text-decoration:none;color:inherit href=#52>52</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=53><a style=outline:none;text-decoration:none;color:inherit href=#53>53</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=54><a style=outline:none;text-decoration:none;color:inherit href=#54>54</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=55><a style=outline:none;text-decoration:none;color:inherit href=#55>55</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=56><a style=outline:none;text-decoration:none;color:inherit href=#56>56</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=57><a style=outline:none;text-decoration:none;color:inherit href=#57>57</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=58><a style=outline:none;text-decoration:none;color:inherit href=#58>58</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=59><a style=outline:none;text-decoration:none;color:inherit href=#59>59</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=60><a style=outline:none;text-decoration:none;color:inherit href=#60>60</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=61><a style=outline:none;text-decoration:none;color:inherit href=#61>61</a>
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#998;font-style:italic># --- config start</span>
<span style=color:teal>$appName</span> = <span style=color:#d14>&#34;AutomaticAutoReply&#34;</span>
<span style=color:teal>$password</span> = <span style=color:#d14>&#34;Come up with something secure!&#34;</span> <span style=color:#998;font-style:italic># Certificate password</span>
<span style=color:teal>$folderPath</span> = <span style=color:#d14>&#34;C:\temp&#34;</span> <span style=color:#998;font-style:italic># Where do you want the certificate files to get saved to? The folder needs to exist.</span>


<span style=color:#998;font-style:italic>#region Graph permissions &amp; constants</span>
<span style=color:teal>$graphResourceId</span> = <span style=color:#d14>&#34;00000003-0000-0000-c000-000000000000&#34;</span>
<span style=color:teal>$UserReadAll</span> = @{
    Id   = <span style=color:#d14>&#34;df021288-bdef-4463-88db-98f22de89214&#34;</span>
    <span style=color:#0086b3>Type </span>= <span style=color:#d14>&#34;Role&#34;</span>
}
<span style=color:teal>$MailboxSettingsReadWriteAll</span> = @{
    Id   = <span style=color:#d14>&#34;6931bccd-447a-43d1-b442-00a195474933&#34;</span>
    <span style=color:#0086b3>Type </span>= <span style=color:#d14>&#34;Role&#34;</span>
} 
<span style=color:#998;font-style:italic>#endregion</span>

<span style=color:#998;font-style:italic>#region Create Certificate</span>
<span style=color:teal>$certStoreLocation</span> = <span style=color:#d14>&#34;cert:\CurrentUser\My&#34;</span>
<span style=color:teal>$certificate</span> = <span style=color:#0086b3>New-SelfSignedCertificate</span> -Subject <span style=color:teal>$appName</span>  -CertStoreLocation <span style=color:teal>$certStoreLocation</span> -NotBefore (<span style=color:#0086b3>Get-Date</span>).AddDays(-1) -NotAfter (<span style=color:#0086b3>Get-Date</span>).AddYears(10) -KeyExportPolicy Exportable -KeySpec Signature

<span style=color:teal>$certificatePath</span> = <span style=color:teal>$certStoreLocation</span> + <span style=color:#d14>&#39;\&#39;</span> + <span style=color:teal>$certificate</span>.Thumbprint
<span style=color:teal>$filePath</span> = <span style=color:teal>$folderPath</span> + <span style=color:#d14>&#39;\&#39;</span> + <span style=color:teal>$appName</span>
<span style=color:teal>$securePassword</span> = <span style=color:#0086b3>ConvertTo-SecureString</span> -String <span style=color:teal>$password</span> -Force -AsPlainText
<span style=color:#0086b3>Export-Certificate</span> -Cert <span style=color:teal>$certificatePath</span> -FilePath (<span style=color:teal>$filePath</span> + <span style=color:#d14>&#39;.cer&#39;</span>)
<span style=color:#0086b3>Export-PfxCertificate</span> -Cert <span style=color:teal>$certificatePath</span> -FilePath (<span style=color:teal>$filePath</span> + <span style=color:#d14>&#39;.pfx&#39;</span>) -Password <span style=color:teal>$securePassword</span>
<span style=color:#998;font-style:italic>#endregion</span>

<span style=color:#998;font-style:italic># Requires an Global Admin for the rights to the Application ReadWrite scopes to register the app</span>
<span style=color:#998;font-style:italic>#region Create App Registration</span>
<span style=color:#0086b3>Connect-MgGraph</span> -Scopes <span style=color:#d14>&#34;Application.ReadWrite.All User.Read&#34;</span>
<span style=color:#0086b3>Select-MgProfile</span> beta 
<span style=color:#998;font-style:italic># Get context for access to tenant ID</span>
<span style=color:teal>$context</span> = <span style=color:#0086b3>Get-MgContext</span>

<span style=color:teal>$appRegistration</span> = <span style=color:#0086b3>New-MgApplication</span> -DisplayName <span style=color:teal>$AppName</span> -SignInAudience <span style=color:#d14>&#34;AzureADMyOrg&#34;</span> `
    -RequiredResourceAccess @{ ResourceAppId = <span style=color:teal>$graphResourceId</span>; ResourceAccess = <span style=color:teal>$UserReadAll</span>, <span style=color:teal>$MailboxSettingsReadWriteAll</span> } `
    -AdditionalProperties @{} -KeyCredentials @(@{ <span style=color:#0086b3>Type </span>= <span style=color:#d14>&#34;AsymmetricX509Cert&#34;</span>; Usage = <span style=color:#d14>&#34;Verify&#34;</span>; Key = <span style=color:teal>$certificate</span>.RawData })

<span style=color:#998;font-style:italic>#Add convenience RedirectURLs to the app</span>
<span style=color:teal>$redirectURIPatch</span> = <span style=color:#d14>&#39;{&#34;web&#34;:{&#34;redirectUris&#34;:[&#39;</span> + <span style=color:#d14>&#34;</span><span style=color:#d14>`&#34;</span><span style=color:#d14>https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationMenuBlade/CallAnAPI/appId/</span>$(<span style=color:teal>$appRegistration</span>.AppId)<span style=color:#d14>/isMSAApp/</span><span style=color:#d14>`&#34;</span><span style=color:#d14>&#34;</span> + <span style=color:#d14>&#39;]}}&#39;</span>
<span style=color:#0086b3>Invoke-GraphRequest</span> -Uri <span style=color:#d14>&#34;https://graph.microsoft.com/v1.0/applications/</span>$(<span style=color:teal>$appRegistration</span>.Id)<span style=color:#d14>&#34;</span> -Method PATCH -Body <span style=color:teal>$redirectURIPatch</span> -ContentType <span style=color:#d14>&#39;application/json&#39;</span>

<span style=color:#998;font-style:italic># Create corresponding service principal</span>
<span style=color:#0086b3>New-MgServicePrincipal</span> -AppId <span style=color:teal>$appRegistration</span>.AppId -AdditionalProperties @{} | <span style=color:#0086b3>Out-Null</span>
<span style=color:#998;font-style:italic>#endregion</span>

<span style=color:#998;font-style:italic>#Write Out Admin Consent URL</span>
<span style=color:teal>$adminConsentUrl</span> = <span style=color:#d14>&#34;https://login.microsoftonline.com/{0}/adminconsent?client_id={1}&#34;</span> <span style=color:#000;font-weight:700>-f</span> <span style=color:teal>$context</span>.TenantId,<span style=color:teal>$appRegistration</span>.AppId
<span style=color:#0086b3>Write-Host</span> -ForeGroundColor Yellow <span style=color:#d14>&#34;Please go to the following URL in your browser to provide admin consent&#34;</span>
<span style=color:#0086b3>Write-Host</span> <span style=color:teal>$adminConsentUrl</span> 
Pause ; <span style=color:#0086b3>Write-Host</span> 

<span style=color:#998;font-style:italic>#Generate Connect-MgGraph App W/ Cert Auth command</span>
<span style=color:teal>$connectGraph</span> = <span style=color:#d14>&#34;Connect-MgGraph -ClientId </span><span style=color:#d14>`&#34;</span><span style=color:#d14>{0}</span><span style=color:#d14>`&#34;</span><span style=color:#d14> -TenantId </span><span style=color:#d14>`&#34;</span><span style=color:#d14>{1}</span><span style=color:#d14>`&#34;</span><span style=color:#d14> -CertificateThumbPrint </span><span style=color:#d14>`&#34;</span><span style=color:#d14>{2}</span><span style=color:#d14>`&#34;</span><span style=color:#d14>&#34;</span> <span style=color:#000;font-weight:700>-f</span> <span style=color:teal>$appRegistration</span>.AppId, <span style=color:teal>$context</span>.TenantId, <span style=color:teal>$certificate</span>.Thumbprint 
<span style=color:#0086b3>Write-Host</span> -ForeGroundColor Cyan <span style=color:#d14>&#34;After providing admin consent, you can use the following values with Connect-MgGraph for app-only:&#34;</span>
<span style=color:#0086b3>Write-Host</span> <span style=color:teal>$connectGraph</span>
<span style=color:teal>$connectGraph</span> + <span style=color:#d14>&#34;</span><span style=color:#d14>`n</span><span style=color:#d14> Get-MgContext&#34;</span> | <span style=color:#0086b3>Set-Clipboard</span> 
<span style=color:#0086b3>Write-Host</span> -ForeGroundColor Cyan <span style=color:#d14>&#34;Copied to ClipBoard&#34;</span>

</code></pre></td></tr></table>
</div>
</div><pre><code>            ## Using our App Auth Certificate
            
            
            &lt;p&gt;
              To use the App auth Certificate is fairly simple, and the script above outputs the command to use. For my app it came out to the **Connect-mgGraph** command shown below.
            &lt;/p&gt;&lt;figure class=&quot;wp-block-image size-large&quot; id=&quot;AppAuthExampleImage&quot;&gt;
            
            ![](image-8.png)&lt;figcaption&gt;Sample **Connect-mgGraph** command shown above&lt;br /&gt;Connected with Certificate based, AppOnly login. &lt;/figcaption&gt;&lt;/figure&gt; &lt;p&gt;**Connect-mgGraph****Connect-mgGraph****Connect-mgGraph****Connect-mgGraph**
              You can use the &lt;strong&gt;Get-mgContext&lt;/strong&gt; to verify you are connected &lt;strong&gt;AppOnly&lt;/strong&gt;/non-interactive login, as well as the &lt;strong&gt;app name &lt;/strong&gt;and your &lt;strong&gt;permissions scopes&lt;/strong&gt;.
            &lt;/p&gt;
            
            &lt;p&gt;
              For a comparison, here is a screenshot of what this looks like connected as my Global Admin during the app registration - [Screenshot](https://i.imgur.com/cEi2DNy.png)
            &lt;/p&gt;
</code></pre>
<h2 id=assembling-our-update-script>Assembling our Update Script</h2>
<pre><code>            &lt;p&gt;
              Now that we can authenticate to the Graph API, we need to make a script to update the Out-of-office messages, which are part of the [MailboxSettings](https://docs.microsoft.com/en-us/graph/api/user-get-mailboxsettings?view=graph-rest-1.0&amp;tabs=http) resource.
            &lt;/p&gt;
            
            &lt;p&gt;
              Using those variables from the previous app we created above, it provided out several variables we will need in the top of the script below. You can see them in the [previous screenshot](#AppAuthExampleImage). Pull those variables into Lines 3-6 below.
            &lt;/p&gt;
            
            &lt;p&gt;
              We can select our User to update the Automatic Out-of-office responses on, and even setup a Teams WebHook notification for failures or errors, like they did for this post [Teams Channel Notification when OSD Fails](https://sysmansquad.com/2020/04/22/teams-channel-notification-when-osd-fails/#step-1). Just update &lt;code&gt;$WebHookURL&lt;/code&gt; on line 12 with your WebHookURL and set the user you want to maintain on line 9.
            &lt;/p&gt;
            
            &lt;p&gt;
              In the script below, I set up Out-Of-Office replies scheduled from 5PM until 8AM the following workday morning.
            &lt;/p&gt;
            
            &lt;p&gt;
              Next, on lines 58-75, I assemble a **patch JSON**, and use Invoke-GraphRequest to patch it onto our user and change the settings.
            &lt;/p&gt;
</code></pre>
<div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=12><a style=outline:none;text-decoration:none;color:inherit href=#12>12</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=13><a style=outline:none;text-decoration:none;color:inherit href=#13>13</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=14><a style=outline:none;text-decoration:none;color:inherit href=#14>14</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=15><a style=outline:none;text-decoration:none;color:inherit href=#15>15</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=16><a style=outline:none;text-decoration:none;color:inherit href=#16>16</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=17><a style=outline:none;text-decoration:none;color:inherit href=#17>17</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=18><a style=outline:none;text-decoration:none;color:inherit href=#18>18</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=19><a style=outline:none;text-decoration:none;color:inherit href=#19>19</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=20><a style=outline:none;text-decoration:none;color:inherit href=#20>20</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=21><a style=outline:none;text-decoration:none;color:inherit href=#21>21</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=22><a style=outline:none;text-decoration:none;color:inherit href=#22>22</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=23><a style=outline:none;text-decoration:none;color:inherit href=#23>23</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=24><a style=outline:none;text-decoration:none;color:inherit href=#24>24</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=25><a style=outline:none;text-decoration:none;color:inherit href=#25>25</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=26><a style=outline:none;text-decoration:none;color:inherit href=#26>26</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=27><a style=outline:none;text-decoration:none;color:inherit href=#27>27</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=28><a style=outline:none;text-decoration:none;color:inherit href=#28>28</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=29><a style=outline:none;text-decoration:none;color:inherit href=#29>29</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=30><a style=outline:none;text-decoration:none;color:inherit href=#30>30</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=31><a style=outline:none;text-decoration:none;color:inherit href=#31>31</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=32><a style=outline:none;text-decoration:none;color:inherit href=#32>32</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=33><a style=outline:none;text-decoration:none;color:inherit href=#33>33</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=34><a style=outline:none;text-decoration:none;color:inherit href=#34>34</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=35><a style=outline:none;text-decoration:none;color:inherit href=#35>35</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=36><a style=outline:none;text-decoration:none;color:inherit href=#36>36</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=37><a style=outline:none;text-decoration:none;color:inherit href=#37>37</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=38><a style=outline:none;text-decoration:none;color:inherit href=#38>38</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=39><a style=outline:none;text-decoration:none;color:inherit href=#39>39</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=40><a style=outline:none;text-decoration:none;color:inherit href=#40>40</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=41><a style=outline:none;text-decoration:none;color:inherit href=#41>41</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=42><a style=outline:none;text-decoration:none;color:inherit href=#42>42</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=43><a style=outline:none;text-decoration:none;color:inherit href=#43>43</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=44><a style=outline:none;text-decoration:none;color:inherit href=#44>44</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=45><a style=outline:none;text-decoration:none;color:inherit href=#45>45</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=46><a style=outline:none;text-decoration:none;color:inherit href=#46>46</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=47><a style=outline:none;text-decoration:none;color:inherit href=#47>47</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=48><a style=outline:none;text-decoration:none;color:inherit href=#48>48</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=49><a style=outline:none;text-decoration:none;color:inherit href=#49>49</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=50><a style=outline:none;text-decoration:none;color:inherit href=#50>50</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=51><a style=outline:none;text-decoration:none;color:inherit href=#51>51</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=52><a style=outline:none;text-decoration:none;color:inherit href=#52>52</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=53><a style=outline:none;text-decoration:none;color:inherit href=#53>53</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=54><a style=outline:none;text-decoration:none;color:inherit href=#54>54</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=55><a style=outline:none;text-decoration:none;color:inherit href=#55>55</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=56><a style=outline:none;text-decoration:none;color:inherit href=#56>56</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=57><a style=outline:none;text-decoration:none;color:inherit href=#57>57</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=58><a style=outline:none;text-decoration:none;color:inherit href=#58>58</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=59><a style=outline:none;text-decoration:none;color:inherit href=#59>59</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=60><a style=outline:none;text-decoration:none;color:inherit href=#60>60</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=61><a style=outline:none;text-decoration:none;color:inherit href=#61>61</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=62><a style=outline:none;text-decoration:none;color:inherit href=#62>62</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=63><a style=outline:none;text-decoration:none;color:inherit href=#63>63</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=64><a style=outline:none;text-decoration:none;color:inherit href=#64>64</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=65><a style=outline:none;text-decoration:none;color:inherit href=#65>65</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=66><a style=outline:none;text-decoration:none;color:inherit href=#66>66</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=67><a style=outline:none;text-decoration:none;color:inherit href=#67>67</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=68><a style=outline:none;text-decoration:none;color:inherit href=#68>68</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=69><a style=outline:none;text-decoration:none;color:inherit href=#69>69</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=70><a style=outline:none;text-decoration:none;color:inherit href=#70>70</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=71><a style=outline:none;text-decoration:none;color:inherit href=#71>71</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=72><a style=outline:none;text-decoration:none;color:inherit href=#72>72</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=73><a style=outline:none;text-decoration:none;color:inherit href=#73>73</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=74><a style=outline:none;text-decoration:none;color:inherit href=#74>74</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=75><a style=outline:none;text-decoration:none;color:inherit href=#75>75</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=76><a style=outline:none;text-decoration:none;color:inherit href=#76>76</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=77><a style=outline:none;text-decoration:none;color:inherit href=#77>77</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=78><a style=outline:none;text-decoration:none;color:inherit href=#78>78</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=79><a style=outline:none;text-decoration:none;color:inherit href=#79>79</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=80><a style=outline:none;text-decoration:none;color:inherit href=#80>80</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=81><a style=outline:none;text-decoration:none;color:inherit href=#81>81</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=82><a style=outline:none;text-decoration:none;color:inherit href=#82>82</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=83><a style=outline:none;text-decoration:none;color:inherit href=#83>83</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=84><a style=outline:none;text-decoration:none;color:inherit href=#84>84</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=85><a style=outline:none;text-decoration:none;color:inherit href=#85>85</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=86><a style=outline:none;text-decoration:none;color:inherit href=#86>86</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=87><a style=outline:none;text-decoration:none;color:inherit href=#87>87</a>
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#998;font-style:italic>#Region Variables</span>
<span style=color:#998;font-style:italic>#Vars for Graph Connection</span>
<span style=color:teal>$ClientID</span>   = <span style=color:#d14>&#39;9d6033b0-XXXX-XXXX-XXXX-33f02ff30d52&#39;</span>
<span style=color:#998;font-style:italic>#$tenant    = &#39;Contoso.one&#39;    #Domain Name for a tenant also works here in my testing, just as Tenant GUID does</span>
<span style=color:teal>$tenant</span>     = <span style=color:#d14>&#39;3a15396c-YYYY-YYYY-YYYY-b09dea3002bc&#39;</span> 
<span style=color:teal>$thumbPrint</span> = <span style=color:#d14>&#39;84283902E8ZZZZZZZZZZZZZZZZZZZZZZ081275FE&#39;</span>

<span style=color:#998;font-style:italic>#User to Update AutomaticReply settings on </span>
<span style=color:teal>$updateUser</span> = <span style=color:#d14>&#39;orders@contoso.one&#39;</span>

<span style=color:#998;font-style:italic>#Vars for Error Reporting - Teams WebHook URL</span>
<span style=color:teal>$WebHookUrl</span> = <span style=color:#d14>&#34;https://outlook.office.com/webhook/4e19076a-7be4-4a07-a7ab-7ba839f6d29b@ca5590ff-9078-4e3c-bd01-54e9ef648e8f/IncomingWebhook/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxx/be9d78f9-d8f2-4932-8246-64ae2aa11f8a&#34;</span>
<span style=color:#998;font-style:italic>#EndRegion</span>


<span style=color:#998;font-style:italic>#Function to Assemble Error into text and send it to a Teams Channel for alerting on errors</span>
<span style=color:#000;font-weight:700>function</span> Fail() { 
<span style=color:#000;font-weight:700>param</span> (
    <span style=color:teal>$ErrorRecord</span>,
    <span style=color:teal>$WebHookUrl</span>
)
    
    <span style=color:teal>$body</span> = <span style=color:#0086b3>ConvertTo-JSON</span> -Depth 2 @{
        title = <span style=color:#d14>&#34;Mailbox Auto Reply Maintenance Failed&#34;</span>
        text  =  <span style=color:teal>$ErrorRecord</span> | <span style=color:#0086b3>Out-String</span>
    }

    <span style=color:#0086b3>Invoke-RestMethod</span> -Uri <span style=color:teal>$WebHookUrl</span> -Method Post -Body <span style=color:teal>$body</span> -ContentType <span style=color:#d14>&#39;application/json&#39;</span>
}

<span style=color:teal>$Message</span> = <span style=color:#d14>&#34;Thank you, we have received your email and will respond the following business day. br /&gt; br /&gt; Our regular business hours are Monday - Friday, 8AM - 5PM, EST.&#34;</span>

<span style=color:#998;font-style:italic>#Get today&#39;s date</span>
<span style=color:teal>$Today</span> = (<span style=color:#0086b3>Get-Date</span>)
<span style=color:#998;font-style:italic>#Test Other Dates - Cannot be in the past!</span>
<span style=color:#998;font-style:italic>#$Today = [datetime]&#39;2021-11-20&#39;</span>

<span style=color:#998;font-style:italic>#Get day of week</span>
<span style=color:teal>$Day</span> = <span style=color:teal>$Today</span>.DayOfWeek.ToString()

<span style=color:#998;font-style:italic>#format today to normal date</span>
<span style=color:teal>$sTime</span> = <span style=color:teal>$Today</span>.ToString(<span style=color:#d14>&#39;MM/dd/yyyy&#39;</span>)
<span style=color:#998;font-style:italic>#format tomorrow to normal date</span>
<span style=color:teal>$eTime</span> = <span style=color:teal>$Today</span>.AddDays(1).ToString(<span style=color:#d14>&#39;MM/dd/yyyy&#39;</span>)

<span style=color:#998;font-style:italic>#combine date and time to start reply</span>
<span style=color:teal>$StartTime</span> = <span style=color:#d14>&#34;$sTime 17:00:00&#34;</span>
<span style=color:#998;font-style:italic>#combine date and time to end reply </span>
<span style=color:teal>$EndTime</span> = <span style=color:#d14>&#34;$eTime 08:00:00&#34;</span>

<span style=color:#998;font-style:italic>#if Friday set from Friday 5pm to Monday 8am</span>
<span style=color:#000;font-weight:700>if</span> (<span style=color:teal>$Day</span> <span style=color:#000;font-weight:700>-eq</span> <span style=color:#d14>&#34;Friday&#34;</span>) {
    <span style=color:#998;font-style:italic>#format weekend dates </span>
    <span style=color:teal>$wTime</span> = <span style=color:teal>$Today</span>.AddDays(3).ToString(<span style=color:#d14>&#39;MM/dd/yyyy&#39;</span>)
    <span style=color:#998;font-style:italic>#combine weekend and time </span>
    <span style=color:teal>$weekendTime</span> = <span style=color:#d14>&#34;$wTime 08:00:00&#34;</span>
}


<span style=color:teal>$patch</span> = <span style=color:#d14>@&#34;
</span><span style=color:#d14>{
</span><span style=color:#d14>    &#34;automaticRepliesSetting&#34;: {
</span><span style=color:#d14>        &#34;status&#34;: &#34;Scheduled&#34;,
</span><span style=color:#d14>        &#34;externalAudience&#34;: &#34;all&#34;,
</span><span style=color:#d14>        &#34;internalReplyMessage&#34;: &#34;$Message&#34;,
</span><span style=color:#d14>        &#34;externalReplyMessage&#34;: &#34;$Message&#34;,
</span><span style=color:#d14>        &#34;scheduledStartDateTime&#34;: {
</span><span style=color:#d14>            &#34;dateTime&#34;: &#34;</span>$(<span style=color:teal>$StartTime</span>.ToUniversalTime().ToString(<span style=color:#d14>&#34;s&#34;</span>))<span style=color:#d14>&#34;,
</span><span style=color:#d14>            &#34;timeZone&#34;: &#34;UTC&#34;
</span><span style=color:#d14>        },
</span><span style=color:#d14>        &#34;scheduledEndDateTime&#34;: {
</span><span style=color:#d14>            &#34;dateTime&#34;: &#34;</span>$(<span style=color:teal>$EndTime</span>.ToUniversalTime().ToString(<span style=color:#d14>&#34;s&#34;</span>))<span style=color:#d14>&#34;,
</span><span style=color:#d14>            &#34;timeZone&#34;: &#34;UTC&#34;
</span><span style=color:#d14>        }
</span><span style=color:#d14>    }   
</span><span style=color:#d14>}
</span><span style=color:#d14>&#34;@</span>
<span style=color:#000;font-weight:700>try</span> {
    <span style=color:#0086b3>Connect-MgGraph</span> -ClientId <span style=color:teal>$ClientID</span> -CertificateThumbprint (<span style=color:teal>$Thumbprint</span> ) -TenantId <span style=color:teal>$tenant</span> -Verbose 
    <span style=color:#0086b3>Select-MgProfile</span> -Name beta

    <span style=color:#0086b3>Invoke-GraphRequest</span> -Uri <span style=color:#d14>&#34;https://graph.microsoft.com/beta/users/</span>$(<span style=color:teal>$updateUser</span>)<span style=color:#d14>/mailboxsettings&#34;</span>  -Method PATCH <span style=color:teal>$patch</span>  -Verbose -ContentType <span style=color:#d14>&#39;application/json&#39;</span>
}
<span style=color:#000;font-weight:700>catch</span> {
    Fail -ErrorRecord <span style=color:teal>$_</span> -WebHookUrl <span style=color:teal>$WebHookUrl</span>
}

</code></pre></td></tr></table>
</div>
</div><h2 id=scheduling-the-script>Scheduling the Script</h2>
<pre><code>            &lt;p&gt;
              Since this script is scheduling the out-of-office messages, but not setting them directly, it can run any time after the previous out-of-office scheduled time has finished.
            &lt;/p&gt;
            
            &lt;p&gt;
              Since my schedule was 5PM to 8AM Monday-Friday, I made a scheduled task and set it up to run Weekly - Monday-Friday at 9AM.
            &lt;/p&gt;&lt;figure class=&quot;wp-block-image size-large&quot;&gt;
            
            ![](image-12.png)&lt;/figure&gt; &lt;p&gt;
              In my testing, since it was only accessing the Current User's profile, and did not need access to other networked resources, you can skip storing the password to increase security.
            &lt;/p&gt;&lt;figure class=&quot;wp-block-image size-large&quot;&gt;
            
            ![](image-9.png)&lt;/figure&gt; &lt;p&gt;
              For the program to run, we just need to specify to run the file with powershell.exe. On my system, it was trying to default opening the .ps1 in notepad, so I switched to directly running powershell.exe to bypass that.
            &lt;/p&gt;&lt;figure class=&quot;wp-block-image size-large&quot;&gt;
            
            ![](image-13.png)&lt;/figure&gt; 
</code></pre>
<h2 id=conclusion>Conclusion</h2>
<pre><code>            &lt;p&gt;
              With this setup, we have an automated flow to update the Out-Of-Office replies outside of business hours. To recap, we have:
            &lt;/p&gt;
            
            &lt;ul&gt;
              &lt;li&gt;
                Made an app registration to grant the needed API Permissions to.
              &lt;/li&gt;
              &lt;li&gt;
                Setup and used an authentication certificate for our script to connect without a user logging in.
              &lt;/li&gt;
              &lt;li&gt;
                Made a script to invoke the Microsoft Graph API and make our change.
              &lt;/li&gt;
              &lt;li&gt;
                Used a simple scheduled task that could run on any machine with access to the certificate to make the changes. Mostly just for a scheduling and recurrence mechanism.
              &lt;/li&gt;
            &lt;/ul&gt;
            
            &lt;p&gt;
              This was just one small example of using the tools at hand, within our current constraints of this customer that doesn't currently have an Azure Subscription to charge against, but it can be used with any tenant.
            &lt;/p&gt;
            
            &lt;p&gt;
              What processes are you looking at automating? You could dump a report of user sign-ins every week, fetch email statistics every hour, schedule removing licenses from users who are inactive, run a report of all newly created Teams and Groups in your Tenant and email those out to your admin team, or any number of other things.
            &lt;/p&gt;
            
            &lt;p&gt;
              Next time, maybe we can go over some of the serverless options that we could run this on if we have an active subscription, like Azure Functions, or possibly Power Automate.
            &lt;/p&gt;
</code></pre>
<h4 id=where-to-find-me>Where to find me</h4>
<pre><code>            &lt;p&gt;
              If you have questions, are having problems, or just want to chat over something, you can leave a comment below or reach me on the [WinAdmins Discord](https://discord.com/invite/winadmins) at [@PsychoData](https://discordapp.com/users/264652399824601088)
            &lt;/p&gt;
</code></pre>
</div>
<comments id=comments>
<script src=https://utteranc.es/client.js repo=SysManSquad/sysmansquadblog issue-term=title label="blog comment" theme=github-light crossorigin=anonymous async></script>
</comments>
</article>
</div>
</div>
</div>
<footer id=footer>
<div class=container>
<div id=footer-copyright>
<p class=copyright>&copy; 2022 WinAdmins - https://blog.sysmansquad.com - Systems Management Squad</a></p>
</div>
</div>
</footer>
</div>
</body>
</html>