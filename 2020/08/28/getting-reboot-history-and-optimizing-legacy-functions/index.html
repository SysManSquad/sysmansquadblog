<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=keyword content="ConfigMgr Microsoft Intune Windows WinAdmins">
<meta name=viewport content="width=device-width">
<meta name=description content="A community blog and subsidiary of WinAdmins.io">
<link rel="shortcut icon" href=/img/favicon.ico>
<title>Getting Reboot History and Optimizing Legacy Functions-SysManSquad | Systems Management Squad</title>
<link rel=canonical href=/2020/08/28/getting-reboot-history-and-optimizing-legacy-functions/>
<link rel=stylesheet href=/css/style.css>
<link rel=stylesheet href=https://blog.sysmansquad.com/css/custom.css>
<script src=https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js></script>
<script src=https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js></script>
<script src=https://blog.sysmansquad.com/js/jquery.slicknav.js></script>
<script src=https://blog.sysmansquad.com/js/asd_SlickNav_Mobile.js></script>
<script src=https://blog.sysmansquad.com/js/custom.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZR1RSQYX"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-XXZR1RSQYX',{anonymize_ip:!1})}</script>
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://blog.sysmansquad.com/83">
<meta name=twitter:title content="Getting Reboot History and Optimizing Legacy Functions">
<meta name=twitter:description content="The other day, I logged on to a jump server and, while investigating an unrelated issue, I noticed the BG Info background showed the Last Reboot as March 1st, 2020. &ldquo;That can&rsquo;t be right,&rdquo; I thought. &ldquo;We have weekly maintenance windows to reboot these servers.&rdquo;
As I opened an old stand-by function from my stash (originally posted here: https://gallery.technet.microsoft.com/scriptcenter/Get-RebootHistory-bc804819 in 2015) and ran it, I was a bit annoyed at how SLOW it was.">
</head>
<body class="home blog">
<div id=asd-container>
<div id=top-bar>
<div class=container>
<div id=nav-wrapper>
<ul class=menu id=menu-top-menu>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/>Home</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/about/>
<span>About</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=https://github.com/SysManSquad>
<span>GitHub</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/jointhesquad/>
<span>Join the Squad</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/meetthesquad/>
<span>Meet the Squad</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=#>
<span>MORE></span>
</a>
<ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/contact/>Contact</a>
</li>
</ul>
</li>
</ul>
</div>
<div id=top-search>
<a href=# class=search><i class="fa fa-search"></i></a>
<div class=show-search>
<form role=search method=get action=https://www.google.com/search id=searchform>
<input type=search placeholder="Search and hit enter..." name=q id=q title="Search and hit enter...">
<input type=hidden name=sitesearch value=https://blog.sysmansquad.com>
<button type=submit value=Search>
</form>
</div>
</div>
<div class=menu id=menu-mobile></div>
</div>
</div>
<header id=header class=noslider>
<div class=container>
<div id=logo>
<h1><a href=https://blog.sysmansquad.com><img src=/img/SysManSquad-HorizontalColor-Logo.png alt="Systems Management Squad"></a></h1>
</div>
</div>
</header>
<div class=container>
<div id=content>
<div id=main class=fullwidth>
<article class="post type-post status-publish format-standard has-post-thumbnail hentry">
<div class=post-header>
<h1>Getting Reboot History and Optimizing Legacy Functions</h1>
<span class=post-date>August 28, 2020</span>
</div>
<div class=post-entry>
<p>The other day, I logged on to a jump server and, while investigating an unrelated issue, I noticed the BG Info background showed the Last Reboot as March 1st, 2020. &ldquo;That can&rsquo;t be right,&rdquo; I thought. &ldquo;We have weekly maintenance windows to reboot these servers.&rdquo;</p>
<p>As I opened an old stand-by function from my stash (originally posted here: <a href=https://gallery.technet.microsoft.com/scriptcenter/Get-RebootHistory-bc804819>https://gallery.technet.microsoft.com/scriptcenter/Get-RebootHistory-bc804819</a> in 2015) and ran it, I was a bit annoyed at how SLOW it was. I decide to open the function and was saddened to see that it wasn&rsquo;t even using Get-Event&mldr; It was using WMI to comb Event Logs. So, I deviated from my original task and set out fixing it. Here&rsquo;s how:</p>
<p>The first thing I needed to do was identify how to get the same information in a faster manner. Since this function is using <code>Get-WMIObject</code> to search Event Logs, we already know improvements can be made with using <code>Get-EventLog</code> or <code>Get-WinEvent</code>. And we can test each with <code>Measure-Object</code> to determine the winner:</p>
<p>&lsquo;Get-EventLog takes {0} milliseconds to find {1} events&rsquo; -f (Measure-Command -Expression {
$Params = @{
Logname = &lsquo;System&rsquo;
InstanceId = &ldquo;2147484722&rdquo;,&ldquo;2147489656&rdquo;,&ldquo;2147489657&rdquo;
}<br>
$Count = (Get-EventLog @Params).count
}).TotalMilliseconds,$Count
Remove-Variable Params,count</p>
<p>&lsquo;Get-WMIObject takes {0} milliseconds to find {1} events&rsquo; -f (Measure-Command -Expression {
$Params = @{
Class = &lsquo;Win32_NTLogEvent&rsquo;
Filter = &ldquo;LogFile = &lsquo;System&rsquo; and EventCode = 6009 or EventCode = 6008 or EventCode = 1074&rdquo;
} <br>
$Count = (Get-WmiObject @Params).count
}).TotalMilliseconds,$Count
Remove-Variable Params,count</p>
<p>Which resulted in the following times:</p>
<p>Wow, I knew WMI cmdlets were a bit slow, but I didn&rsquo;t expect to see such a drastic improvement by using <code>Get-WinEvent</code>. It&rsquo;s safe to say this is how we&rsquo;ll move forward.</p>
<p>I like the information that <code>Get-RebootHistory</code> outputs, so I want to keep the same data while using the more efficient command. Let&rsquo;s dig through the function to find out what we&rsquo;re modifying.</p>
<p>Identify the main, slow command:</p>
<p>ForEach ($Event In $Events) {..}</p>
<p>And Since it&rsquo;s using splatting, we need to find the variable holding the values:</p>
<p>Now we need to replace <code>Get-WMIObject</code> with <code>Get-WinEvent</code> and compare the outputs. Referencing good ol' <a href=https://devblogs.microsoft.com/scripting/use-filterhashtable-to-filter-event-log-with-powershell/>Dr. Scripto&rsquo;s blog on the FilterHashtable param</a>, we replace the WMI splat and the <code>$Events</code> line with:</p>
<p>Next we&rsquo;ll need to verify the integrity of this <code>Switch</code> statement</p>
<p>Testing the output of our new <code>$Events</code> variable, we see the properties of the first element do not have the same property names. Most are easy enough to match up, save for the <code>InsertionStrings</code> property<br>
<div class=image>
<figure>
<a href=Snag_2180a815.png target=_blank>
<img src=Snag_2180a815.png alt="Event property compare">
</a>
</figure>
</div><br>
For the <code>InsertionStrings</code> property, I just went exploring and tried this, which had the corresponding values:<br>
<div class=image>
<figure>
<a href=Snag_2184b929.png target=_blank>
<img src=Snag_2184b929.png alt="6008 properties">
</a>
</figure>
</div><br>
and led to the new Switch statement:</p>
<p>Finally, we validate the <code>$ShutdownDetail</code> values:</p>
<p>Once again, there are values to modify by comparing the output of the WMI event object to the new object, but I came across one property that didn&rsquo;t translate well, the <code>LastShutdownUser</code> property. With WMI, the readable User Name was placed in the <code>$Events[0].InsertionStrings</code> property, but <code>Get-WinEvent</code> provides just the SID. I put together a quick CIM function to grab the User name:</p>
<p>Now I can call that function for the <code>LastShutdownUser</code> property and replicate the output from the original <code>Get-RebootHistory</code> function in the output object.<br>
Additionally, we can once again replace the <code>InsertionStrings</code> and simplify the <code>LastShutdownUser</code>, <code>LastShutdownProcess</code>, <code>LastShutdown</code>, and <code>LastShutdownReason</code> since <code>Get-WinEvent</code> also provides more readily readable values:</p>
<p>All of that leads to the finished product, which I&rsquo;ve put in a gist on GitHub.<br>
Enjoy!</p>
<p><a href=https://gist.github.com/hkystar35/12b5f54401edfb9077346da7fe938e4e>https://gist.github.com/hkystar35/12b5f54401edfb9077346da7fe938e4e</a></p>
</div>
<comments id=comments>
<script src=https://utteranc.es/client.js repo=SysManSquad/sysmansquadblog issue-term=title label="blog comment" theme=github-light crossorigin=anonymous async></script>
</comments>
</article>
</div>
</div>
</div>
<footer id=footer>
<div class=container>
<div id=footer-copyright>
<p class=copyright>&copy; 2021 WinAdmins - https://blog.sysmansquad.com - Systems Management Squad</a></p>
</div>
</div>
</footer>
</div>
</body>
</html>