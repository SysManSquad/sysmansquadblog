<!doctype html><html lang=en-us><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=keyword content="ConfigMgr Microsoft Intune Windows WinAdmins"><meta name=viewport content="width=device-width"><meta name=description content="A community blog and subsidiary of WinAdmins.io"><link rel="shortcut icon" href=/img/favicon.ico><title>Find Microsoft Accounts on Company Domains-SysManSquad | Systems Management Squad</title>
<link rel=canonical href=/2020/11/23/find-microsoft-accounts/><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://sysmansquad.com/css/custom.css><script src=https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js></script><script src=https://sysmansquad.com/js/jquery.slicknav.js></script><script src=https://sysmansquad.com/js/asd_SlickNav_Mobile.js></script><script src=https://sysmansquad.com/js/clipboard.js></script><script src=https://sysmansquad.com/js/custom.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZR1RSQYX"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XXZR1RSQYX")}</script></head><body class="home blog"><div id=asd-container><div id=top-bar><div class=container><div id=nav-wrapper><ul class=menu id=menu-top-menu><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/>Home</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/about/><span>About</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=https://github.com/SysManSquad><span>GitHub</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/jointhesquad/><span>Join the Squad</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/meetthesquad/><span>Meet the Squad</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=#><span>MORE></span></a><ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/contact/>Contact</a></li></ul></li></ul></div><div id=top-search><a href=# class=search><i class="fa fa-search"></i></a><div class=show-search><form role=search method=get action=https://www.google.com/search id=searchform><input type=search placeholder="Search and hit enter..." name=q id=q title="Search and hit enter...">
<input type=hidden name=sitesearch value=https://sysmansquad.com/>
<button type=submit value=Search class=searchbutton></form></div></div><div class=menu id=menu-mobile></div></div></div><header id=header class=noslider><div class=container><div id=logo><h1><a href=https://sysmansquad.com/><img src=/img/SysManSquad-HorizontalColor-Logo.png alt="Systems Management Squad"></a></h1></div></div></header><div class=container><div id=content><div id=main class=fullwidth><article class="post type-post status-publish format-standard has-post-thumbnail hentry"><div class=post-header><h1>Find Microsoft Accounts on Company Domains</h1><p class=p-meta><span class=post-author><a href=/authors/kevin-crouch>Kevin Crouch</a> / </span><span class=post-date>November 23, 2020 </span><span class=post-categories>/ Azure </span><span class=post-categories>/ How-To </span><span class=post-categories>/ Microsoft </span><span class=post-categories>/ Powershell </span><span class=post-categories>/ Scripting</span></p></div><div class=post-entry><p>The other day I was helping someone over in the <a href=https://aka.ms/WinAdmins>WinAdmins Discord</a>. Their users kept getting confused about what their passwords were, and it was causing a lot of HelpDesk tickets. Let&rsquo;s find out what users have Microsoft accounts on the company domain so we can help move those accounts elsewhere to streamline the user experience.</p><h2 id=update-on-prevention>Update on Prevention:</h2><blockquote><p>Microsoft has introduced some changes that at least seem to prevent <em>NEW</em> Microsoft Accounts on Company Domains. I added more details in the <a href=#preventing>Preventing</a> section if you want to read more about this. If you just want to find the accounts, jump to <a href=#identifying-the-problem>Identifying the Problem</a>.</p></blockquote><h3 id=preventing-new-registration>Preventing new registration</h3><p>Microsoft has introduced some changes that at least seem to prevent <em>NEW</em> Microsoft Accounts on Company Domains. I haven&rsquo;t been able to find any specific announcement about this feature/capability, but supposedly all you need to do is have the relevant domain in your Office 365 Domains as Managed.</p><h3 id=what-the-blocking-looks-like>What the blocking looks like</h3><p>So far, it seems that the blocking will prevent them from Registering a new account with a validated work email domain, or from adding that email as an alias.</p><p><div class=image><figure><a href=image-2.png target=_blank><img src=image-2.png alt=screenshot></a></figure></div>Blocked from registering from a new Microsoft Account with Company Email<div class=image><figure><a href=image-1.png target=_blank><img src=image-1.png alt=screenshot></a></figure></div>Blocked from adding the company email as an alias on a current account<div class=image><figure><a href=zgvcQSD1.png target=_blank><img src=zgvcQSD1.png alt=screenshot></a></figure></div>Seems to work off Domain, not specific Email Addresses</p><h2 id=identifying-the-problem>Identifying the Problem</h2><p>This prompt is the main source of the user’s confusion; the email address is the same for the user’s Work/School account and a Microsoft account. When an app supports signing in with both a Work/School and Personal account, it prompts the user for which type of account they want to use. Most users don&rsquo;t know what the difference is, or where the Microsoft account came from.</p><p><div class=image><figure><a href=image-1-edited.png target=_blank><img src=image-1-edited.png alt="Screenshot showing a choice between work / School account and Personal / Microsoft Account"></a></figure></div></p><p>As that link in the screenshot says, you can <a href="https://go.microsoft.com/fwlink/p/?LinkID=733247">Rename the personal Microsoft account</a>, but how can you know which users have a conflicting Microsoft account?</p><h2 id=designing-a-solution>Designing a Solution</h2><p>To find these conflicting Microsoft accounts, we can &mldr; abuse&mldr; an Azure App Registrations capabilities. We create a custom application that we register to only accept Microsoft accounts, not AzureAD/Work/School accounts. – if you try to use an email for your domain that doesn’t have a Microsoft account, it will just throw back an error that no Microsoft account could be found.</p><p><div class=image><figure><a href=image-2-edited.png target=_blank><img src=image-2-edited.png alt="This screenshot shows that a microsoft Account sign in prompt will return a warning if you give it an email address with no Microsoft Account associated "></a></figure></div></p><p>Even better! We can leverage this, along with <strong><a href="https://docs.microsoft.com/azure/active-directory/develop/active-directory-optional-claims#:~:text=app%2Buser%20token.-,login_hint,-Login%20hint">login hints</a></strong>, to scale this up and make a scriptable solution to find any domain emails that have a Microsoft account conflicting with their Work account.</p><p>At this time, I don’t know of a way to prevent Microsoft accounts on the company domain, or automatically move them - but we can at least find the conflicts. This will allow the Help Desk to contact the end-user and help them relocate the personal account.</p><h2 id=setting-up-your-app-registration>Setting up your App Registration</h2><p>To set this up, we need to head to the <a href=https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/RegisteredApps>Azure Portal</a> and create a new <strong>app registration</strong></p><p><div class=image><figure><a href=image-3.png target=_blank><img src=image-3.png alt="Navigate to portal.azure.com, search for App Registrations, and select New Registration"></a></figure></div>We need a name for the consumers to see if they authorize our test application. I used: <code>ContosoMicrosoftAccountVerifier</code></p><p>For supported account types, we cannot use the first three options because they all support tenant/company logins, but the fourth type will serve our purposes.</p><p><div class=image><figure><a href=image-4.png target=_blank><img src=image-4.png alt="We cannot support account types from regular tenants, and instead only support Personal / Microsoft Accounts"></a></figure></div>We do not need a redirect URL for this setup.</p><p>Next, we need to setup a few aspects of the application, to use for dummy information.</p><p>Under <strong>API Permissions</strong>, we need to add a permission of some sort for it to request access to. The least amount of permissions was just the <strong>Profile</strong> permission.</p><p><div class=image><figure><a href=image-5.png target=_blank><img src=image-5.png alt="select the minimum amount of permissions that you can. They should never be signed into anyway "></a></figure></div>Even though people should not be logging into our App, we need to setup some sort of Authentication for the App to theoretically use, even though we won&rsquo;t use it.</p><p>Under <strong>Certificates and Secrets</strong>, I created a New Client Secret. You do not need to save the key values</p><p><div class=image><figure><a href=image-6.png target=_blank><img src=image-6.png alt="Create a Dummy client secret, for the Microsoft backend. you do not need to keep the key"></a></figure></div></p><h2 id=constructing-our-app-authorization-url>Constructing our App Authorization URL</h2><p>Next, we need to gather the information for our authentication URL.</p><ul><li>Authentication endpoints</li><li>Application ID (Client ID in the URL)</li><li>Email Addresses to check</li><li>Scope for our API Permissions</li></ul><p>We get most of these from our App’s Overview page, from the API Permissions tab, and combine those with some other parameters from the <a href=https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-auth-code-flow#request-an-authorization-code>OAuth 2.0 code flow</a> to get a URL similar to the one below</p><p><code>https://login.microsoftonline.com/consumers/oauth2/v2.0/authorize?client_id=bd53bb89-0cc1-4eb3-90b7-ba008b1f2a2c&amp;scope=user.read&amp;response_type=code&amp;state=23424&amp;login_hint=TinaFey@contoso.one</code></p><p>You can test this URL above live for yourself, or use your own app created with the process above. Just adjust the <strong>Client_ID</strong> to match your <strong>Application ID</strong>, and adjust the <strong>login_hint</strong> to match your user.</p><h3 id=valid-microsoft-account><strong>Valid Microsoft Account</strong></h3><p><div class=image><figure><a href=image-7.png target=_blank><img src=image-7.png alt="Providing a Valid Microsoft Account email continues to a Password Prompt"></a></figure></div>Note: the email address is recognized, and the prompt has switched to “Enter password”</p><h3 id=no-valid-microsoft-account><strong>No Valid Microsoft Account</strong></h3><p><div class=image><figure><a href=image-8.png target=_blank><img src=image-8.png alt="Providing an invalid Microsoft Account email throws a watning that the Microsoft Account does not exists"></a></figure></div>Note: the email address is not recognized, and the prompt still shows “That Microsoft account doesn’t exist”</p><h2 id=scripting-the-verification-process>Scripting the verification Process</h2><p>Below is a quick script I made to build a list of all the company emails and iterate through checking them.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-22>22</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#998;font-style:italic>#$emailAddresses = &#39;tinafey@contoso.one&#39;,&#39;username@domain.com&#39;,&#39;ronswanson@contoso.one&#39;</span>
</span></span><span style=display:flex><span><span style=color:teal>$emailAddresses</span> = <span style=color:#0086b3>Get-EXORecipient</span> -RecipientTypeDetails UserMailbox -PropertySets Minimum | <span style=color:#0086b3>select </span>-ExpandProperty Emailaddresses | <span style=color:#0086b3>where </span>{<span style=color:teal>$_</span> <span style=color:#000;font-weight:700>-match</span> <span style=color:#d14>&#34;SMTP:&#34;</span>} | <span style=color:#000;font-weight:700>foreach</span> {<span style=color:teal>$_</span> <span style=color:#000;font-weight:700>-replace</span> <span style=color:#d14>&#39;^smtp:&#39;</span>} 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:teal>$ApplicationID</span>  = <span style=color:#d14>&#39;bd53bb89-0cc1-4eb3-90b7-ba008b1f2a2c&#39;</span>
</span></span><span style=display:flex><span><span style=color:teal>$scope</span>          = <span style=color:#d14>&#39;user.read&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:teal>$results</span> = [<span style=color:teal>System.Collections.ArrayList</span>]::new()
</span></span><span style=display:flex><span><span style=color:teal>$emailAddresses</span> | <span style=color:#000;font-weight:700>foreach</span> -Begin { <span style=color:teal>$i</span> = <span style=color:#099>1</span>} -Process {
</span></span><span style=display:flex><span><span style=color:#0086b3>Write-Progress</span> -Activity <span style=color:#d14>&#39;Checking Email Addresses for Microsoft Accounts&#39;</span> -CurrentOperation (<span style=color:#d14>&#34;Checking {0} - {1}/{2}&#34;</span> <span style=color:#000;font-weight:700>-f</span> <span style=color:teal>$_</span>,<span style=color:teal>$i</span>,<span style=color:teal>$emailAddresses</span>.Count) -PercentComplete (<span style=color:teal>$i</span>/(<span style=color:teal>$emailAddresses</span>.count)*<span style=color:#099>100</span>)
</span></span><span style=display:flex><span><span style=color:teal>$UserURL</span>  = <span style=color:#d14>&#39;https://login.microsoftonline.com/consumers/oauth2/v2.0/authorize?client_id={0}&amp;scope={1}&amp;response_type=code&amp;state=23424&amp;login_hint={2}&#39;</span> <span style=color:#000;font-weight:700>-f</span> <span style=color:teal>$ApplicationID</span>,<span style=color:teal>$scope</span>,<span style=color:teal>$_</span>
</span></span><span style=display:flex><span><span style=color:teal>$response</span> = <span style=color:#0086b3>Invoke-WebRequest</span> -Uri <span style=color:teal>$UserURL</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:teal>$results</span>.Add( 
</span></span><span style=display:flex><span>[<span style=color:teal>psCustomobject</span>]@{
</span></span><span style=display:flex><span>EmailAddress = <span style=color:teal>$_</span>
</span></span><span style=display:flex><span>HasMSAccount = <span style=color:teal>$response</span> <span style=color:#000;font-weight:700>-match</span> <span style=color:#d14>&#39;&#34;HasPassword&#34;:1&#39;</span> 
</span></span><span style=display:flex><span>Result       = <span style=color:teal>$response</span>.StatusCode
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>) | <span style=color:#0086b3>Out-Null</span>
</span></span><span style=display:flex><span><span style=color:teal>$i</span>++
</span></span><span style=display:flex><span>} 
</span></span><span style=display:flex><span><span style=color:teal>$results</span>
</span></span></code></pre></td></tr></table></div></div><p><div class=image><figure><a href=image-10.png target=_blank><img src=image-10.png alt=screenshot></a></figure></div></p><h2 id=user-consent-prompt>User Consent Prompt</h2><p>Our app doesn’t have any server code. We only need to get to the pre-login experience to confirm whether an email address has a Microsoft account associated with it. This means that users don’t need to finish logging in and authorize the app, but if they do finish logging in, they will get a consent prompt like this.</p><p><div class=image><figure><a href=image-9.png target=_blank><img src=image-9.png alt="If a user does sign into this app fully, they will be prompted to approve the permissions requested earlier"></a></figure></div>Note: <strong>Unverified</strong> is the default state, but you can verify your tenant to show your company’s name instead. Details <a href="https://go.microsoft.com/fwlink/?linkid=2121525&amp;clcid=0x9">here</a></p><h2 id=wrap-up>Wrap up</h2><p>With this app we made, we can verify whether any email address has a Microsoft account associated with it with an automated method that we can script against.</p><p>To test any email address manually, just remove the <strong>login_hint</strong> parameter from the URL and you can enter any email address to check it, even without their password.</p><p><a href="https://login.microsoftonline.com/consumers/oauth2/v2.0/authorize?client_id=bd53bb89-0cc1-4eb3-90b7-ba008b1f2a2c&amp;scope=user.read&amp;response_type=code&amp;state=23424&amp;login_hint=TinaFey@contoso.one">https://login.microsoftonline.com/consumers/oauth2/v2.0/authorize?client_id=<strong>bd53bb89-0cc1-4eb3-90b7-ba008b1f2a2c</strong>&amp;scope=user.read&amp;response_type=code&amp;state=23424</a></p><img src=/authors/kevin-crouch/avatar.png alt="Photo of Kevin Crouch"><br><strong>Kevin Crouch</strong>
<em>Contributor</em><div></div><p>System Administrator</p><hr></div><div class=post-share><div class="post-share-box share-comments"></div></div><comments id=comments><script src=https://utteranc.es/client.js repo=SysManSquad/sysmansquadblog issue-term=title label="blog comment" theme=github-light crossorigin=anonymous async></script></comments></article></div></div></div><footer id=footer><div class=container><div id=footer-copyright><p class=copyright>&copy; 2024 WinAdmins - https://sysmansquad.com/ - Systems Management Squad</a></p></div></div></footer></div></body></html>