<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=keyword content="ConfigMgr Microsoft Intune Windows WinAdmins"><meta name=viewport content="width=device-width"><meta name=description content="A community blog and subsidiary of WinAdmins.io"><link rel="shortcut icon" href=/img/favicon.ico><title>NET-103 : Layering in Active Directory-SysManSquad | Systems Management Squad</title><link rel=canonical href=/2020/05/19/net-103-layering-in-active-directory/><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://sysmansquad.com/css/custom.css><script src=https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js></script>
<script src=https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js></script>
<script src=https://sysmansquad.com/js/jquery.slicknav.js></script>
<script src=https://sysmansquad.com/js/asd_SlickNav_Mobile.js></script>
<script src=https://sysmansquad.com/js/clipboard.js></script>
<script src=https://sysmansquad.com/js/custom.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZR1RSQYX"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XXZR1RSQYX",{anonymize_ip:!1})}</script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sysmansquad.com/83"><meta name=twitter:title content="NET-103 : Layering in Active Directory"><meta name=twitter:description content="Joe Ravi / CC BY-SA https://creativecommons.org/licenses/by-sa/3.0 In previous articles, we&rsquo;ve built the basic services you need without getting too far in the weeds. Now we&rsquo;re going to layer in a central identity service.
It&rsquo;s also hopefully going to be a lot shorter than previous articles, though I can&rsquo;t make any promises - these things tend to all start small, then balloon rapidly.
If you&rsquo;re continuing from NET-102 you&rsquo;ll already have the following machines:"></head><body class="home blog"><div id=asd-container><div id=top-bar><div class=container><div id=nav-wrapper><ul class=menu id=menu-top-menu><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/>Home</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/about/><span>About</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=https://github.com/SysManSquad><span>GitHub</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/jointhesquad/><span>Join the Squad</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/meetthesquad/><span>Meet the Squad</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=#><span>MORE></span></a><ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/contact/>Contact</a></li></ul></li></ul></div><div id=top-search><a href=# class=search><i class="fa fa-search"></i></a><div class=show-search><form role=search method=get action=https://www.google.com/search id=searchform><input type=search placeholder="Search and hit enter..." name=q id=q title="Search and hit enter...">
<input type=hidden name=sitesearch value=https://sysmansquad.com>
<button type=submit value=Search class=searchbutton></form></div></div><div class=menu id=menu-mobile></div></div></div><header id=header class=noslider><div class=container><div id=logo><h1><a href=https://sysmansquad.com><img src=/img/SysManSquad-HorizontalColor-Logo.png alt="Systems Management Squad"></a></h1></div></div></header><div class=container><div id=content><div id=main class=fullwidth><article class="post type-post status-publish format-standard has-post-thumbnail hentry"><div class=post-header><h1>NET-103 : Layering in Active Directory</h1><p class=p-meta><span class=post-author><a href=/authors/aaron>Aaron Glenn</a> /</span>
<span class=post-date>May 19, 2020</span>
<span class=post-categories>/ How-To</span>
<span class=post-categories>/ Powershell</span>
<span class=post-categories>/ Scripting</span>
<span class=post-categories>/ Windows</span></p></div><div class=post-entry><p><div class=image><figure><a href=Canada_Goose_Branta_Canadensis.jpg target=_blank><img src=Canada_Goose_Branta_Canadensis.jpg alt=Canada_Goose_Branta_Canadensis.jpg></a><figcaption>Joe Ravi / CC BY-SA https://creativecommons.org/licenses/by-sa/3.0</figcaption></figure></div></p><p>In <a href=https://www.sysmansquad.com/2020/01/23/net-102-build-your-lab/>previous articles</a>, we&rsquo;ve built the basic services you need without getting too far in the weeds. Now we&rsquo;re going to layer in a central identity service.</p><p>It&rsquo;s also hopefully going to be a lot shorter than previous articles, though I can&rsquo;t make any promises - these things tend to all start small, then balloon rapidly.</p><p>If you&rsquo;re continuing from NET-102 you&rsquo;ll already have the following machines:</p><table><thead><tr><th>Machine</th><th>Description</th></tr></thead><tbody><tr><td>gateway</td><td>pfsense gateway functioning as a firewall & router</td></tr><tr><td>lab-dns</td><td>dns server</td></tr><tr><td>lab-dhcp</td><td>dhcp server</td></tr><tr><td>workstation</td><td>windows 10 workstation with all of the RSAT tools installed</td></tr></tbody></table><p>Pretty simple so far, we just have the bare bones of a network. New devices placed on the network will get an address and be able to resolve hostnames. Now we&rsquo;ll want to expand on this to allow you to have a centralized set of credentials. This enables you to use the same user name and password across many machines without needing to create them on each machine.</p><p>At the moment, you don&rsquo;t really have a good way to just look at your configuration other than powershell commands if you followed instructions from NET-102. This obviously isn&rsquo;t optimal when you just need a quick look around, or need to get something done quickly. Some things like the DNS server console might connect OK from your admin workstation, but it&rsquo;s likely that nothing works quite right. If anything does work at all it may be because you&rsquo;ve got the same username and password configured across all machines in your lab.</p><p>Warning: Before you continue, if you have given your admin workstation vm a network adapter on your real network, <strong>make sure that it has NO default gateway and NO dns servers specified</strong>. It should have a static address configuration, and look similar to the following:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-11>11</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>C:\Users\User1&gt;ipconfig /all
</span></span><span style=display:flex><span>Ethernet adapter Ethernet0:
</span></span><span style=display:flex><span>   Connection-specific DNS Suffix  . :
</span></span><span style=display:flex><span>   Description . . . . . . . . . . . : hardware description&gt;
</span></span><span style=display:flex><span>   Physical Address. . . . . . . . . : 00-00-00-00-00-00
</span></span><span style=display:flex><span>   DHCP Enabled. . . . . . . . . . . : No
</span></span><span style=display:flex><span>   Autoconfiguration Enabled . . . . : Yes
</span></span><span style=display:flex><span>   IPv4 Address. . . . . . . . . . . : 192.168.0.40(Preferred)
</span></span><span style=display:flex><span>   Subnet Mask . . . . . . . . . . . : 255.255.255.0
</span></span><span style=display:flex><span>   Default Gateway . . . . . . . . . : &lt;this should be blank&gt;
</span></span><span style=display:flex><span>   NetBIOS over Tcpip. . . . . . . . : Enabled
</span></span></code></pre></td></tr></table></div></div><h2 id=planning-your-ad-environment>Planning your AD environment</h2><p>For an environment this small, it&rsquo;s going to be pretty simple. You merely need to decide on the AD domain name and set the IP addressing of the controller. In a larger network and environment you&rsquo;d have to plan things like AD Sites & Services topology, scaling the number of controllers to the number of clients, redundancy, etc.</p><h3 id=ad-information><strong>AD Information</strong></h3><table><thead><tr><th>Item</th><th>Value</th></tr></thead><tbody><tr><td>AD Domain Name</td><td>ad</td></tr><tr><td>AD FQDN</td><td>ad.lab.test</td></tr><tr><td>ADC IPv4</td><td>10.248.100.4</td></tr><tr><td>ADC IPv6</td><td>fdda:f6d4:f5a2:f1e6::4/64</td></tr></tbody></table><p>Keep in mind that the AD domain name isn&rsquo;t changeable later without causing a large amount of headache for yourself. Keep it reasonably generic. You can certainly name it CONTOSOAD or whatever your company is named but keep in mind - company names change on occasion. Your company could rebrand, be acquired or acquire another company. This name will stick with you a long time, and is <strong>always visible to all staff</strong>, so don&rsquo;t try to be cute with it. You&rsquo;ll also probably find yourself typing it many times, so shorter is better.</p><p>It is also VERY important to make sure the fully qualified domain name is something your company OWNS. Even if you&rsquo;ve set up your internal services to properly resolve that domain name, your machines will sometimes leave your network and spray authentication traffic toward whatever servers that name resolves to on the Internet. Obviously we&rsquo;re not following this good practice here, but it&rsquo;s a lab. Do better for production.</p><h2 id=installing-your-first-ad-controller>Installing your first AD controller</h2><p>Create a VM with ~2048MB RAM and a minimum 60GB disk space. By now you&rsquo;re acquainted with how to install a VM and choose a core install. You should also have a functioning DHCP server now, so your AD controller will start out with a valid DHCP-Provided IPv4 address. Use <code>sconfig</code> to configure the basic details like the hostname, IPv4 static address, patching, etc.</p><p>Set the IP address:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-15>15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-16>16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-17>17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-18>18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-19>19</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-20>20</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-21>21</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-22>22</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-23>23</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-24>24</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-25>25</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-26>26</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-27>27</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-28>28</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-29>29</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-30>30</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#998;font-style:italic># Change these to match the config in your documentation</span>
</span></span><span style=display:flex><span><span style=color:teal>$IPv6Address</span>=<span style=color:#d14>&#39;fdda:f6d4:f5a2:f1e6::4&#39;</span>
</span></span><span style=display:flex><span><span style=color:teal>$IPv6PrefixLength</span>=<span style=color:#d14>&#39;64&#39;</span>
</span></span><span style=display:flex><span><span style=color:teal>$IPv6Gateway</span>=<span style=color:#d14>&#39;fdda:f6d4:f5a2:f1e6::1&#39;</span>
</span></span><span style=display:flex><span><span style=color:teal>$IPv6DNSServer</span>=<span style=color:#d14>&#39;fdda:f6d4:f5a2:f1e6::2&#39;</span>
</span></span><span style=display:flex><span><span style=color:teal>$IPv4Gateway</span>=<span style=color:#d14>&#39;10.248.100.1&#39;</span>
</span></span><span style=display:flex><span><span style=color:teal>$IPv4DNSServer</span>=<span style=color:#d14>&#39;10.248.100.2&#39;</span>
</span></span><span style=display:flex><span><span style=color:teal>$FQDN</span>=<span style=color:#d14>&#39;lab.test&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># Use our DNS server, then fall back to the gateway if the DNS server is offline</span>
</span></span><span style=display:flex><span><span style=color:teal>$DnsServerAddresses</span>=(<span style=color:teal>$IPv4DNSServer</span>,<span style=color:teal>$IPv4Gateway</span>,<span style=color:teal>$IPv6DNSServer</span>,<span style=color:teal>$IPv6Gateway</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># Get the adapter </span>
</span></span><span style=display:flex><span><span style=color:teal>$Adapter</span>=(<span style=color:#0086b3>Get-NetAdapter</span>)[0]
</span></span><span style=display:flex><span><span style=color:#0086b3>Set-DnsClient</span> -InterfaceIndex <span style=color:teal>$Adapter</span>.ifIndex -ConnectionSpecificSuffix <span style=color:teal>$FQDN</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># turn off DHCP</span>
</span></span><span style=display:flex><span><span style=color:#0086b3>Set-NetIPInterface</span> -Dhcp Disabled -InterfaceIndex <span style=color:teal>$Adapter</span>.ifIndex
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># configure DNS client</span>
</span></span><span style=display:flex><span><span style=color:#0086b3>Set-DnsClientServerAddress</span> -InterfaceIndex <span style=color:teal>$Adapter</span>.ifIndex -ServerAddresses <span style=color:teal>$DnsServerAddresses</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># Create the IPv6 config, create the address</span>
</span></span><span style=display:flex><span><span style=color:teal>$IPv6Arguments</span> =@{
</span></span><span style=display:flex><span>    InterfaceIndex = <span style=color:teal>$Adapter</span>.ifIndex
</span></span><span style=display:flex><span>    PrefixLength = <span style=color:teal>$IPv6PrefixLength</span>
</span></span><span style=display:flex><span>    IPAddress = <span style=color:teal>$IPv6Address</span>
</span></span><span style=display:flex><span>    DefaultGateway = <span style=color:teal>$IPv6Gateway</span>
</span></span><span style=display:flex><span>    AddressFamily = <span style=color:#d14>&#39;IPv6&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#0086b3>Type </span>= <span style=color:#d14>&#39;Unicast&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#0086b3>New-NetIPAddress</span> <span style=color:teal>@IPv6Arguments</span>
</span></span></code></pre></td></tr></table></div></div><p>Then you&rsquo;ll need to install the domain controller.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1>1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-2>2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-3>3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-4>4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-5>5</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:teal>$SafeModeAdminPassword</span>=<span style=color:#d14>&#39;P@ssw0rd2&#39;</span> <span style=color:#998;font-style:italic># Change this. </span>
</span></span><span style=display:flex><span><span style=color:teal>$DomainName</span> = <span style=color:#a61717;background-color:#e3d2d2>&#39;</span>ad.lab.test
</span></span><span style=display:flex><span><span style=color:#0086b3>Install-WindowsFeature</span> <span style=color:#0086b3>AD-Domain</span>-Services -IncludeManagementTools
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># Install the domain with a very bad password for the safe-mode administrator</span>
</span></span><span style=display:flex><span><span style=color:#0086b3>Install-ADDSForest</span> -DomainName <span style=color:teal>$DomainName</span> -SafeModeAdministratorPassword (<span style=color:teal>$SafeModeAdminPassword</span>|<span style=color:#0086b3>ConvertTo-SecureString</span> -AsPlainText -Force) -installDNS -Force
</span></span></code></pre></td></tr></table></div></div><p>For bonus points, spot the obvious error I&rsquo;ve left in this script to help you brush up on your powershell skills before you run it.</p><p>Obviously, you&rsquo;ll want to change the safe mode administrator password. Your AD controller will immediately reboot without asking when it&rsquo;s finished installing. You&rsquo;ll notice that this reboot takes a long time. This is expected behavior - there&rsquo;s a lot of work an AD controller does on first boot, and it&rsquo;ll pause at &ldquo;Applying computer settings&rdquo;. You now have a functioning domain, but there&rsquo;s a little bit more to do. All of your clients are configured to use your main stand-alone dns server now, and it doesn&rsquo;t know how to tell them how to find your new AD domain so they can join.</p><p>Since your <code>dns</code> server is <em>authoritative</em> for <code>lab.test</code>, you will create a &ldquo;delegation&rdquo; for the subdomain <code>ad.lab.test</code> to authorize your new AD controller to handle it&rsquo;s own dns records.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-11>11</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#998;font-style:italic>#######################################################################################################</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># Run this from your existing DNS server, not your AD controller, even though it too is a DNS server. #</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>#######################################################################################################</span>
</span></span><span style=display:flex><span><span style=color:teal>$ParentZone</span>=<span style=color:#d14>&#39;lab.test&#39;</span>
</span></span><span style=display:flex><span><span style=color:teal>$AdcShortname</span>=<span style=color:#d14>&#39;adc&#39;</span>
</span></span><span style=display:flex><span><span style=color:teal>$ChildZone</span>=<span style=color:#d14>&#39;ad&#39;</span>
</span></span><span style=display:flex><span><span style=color:teal>$IPv4Address</span> = <span style=color:#d14>&#39;10.248.100.4&#39;</span>
</span></span><span style=display:flex><span><span style=color:teal>$IPv6Address</span> = <span style=color:#d14>&#39;fdda:f6d4:f5a2:f1e6::4&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0086b3>Add-DnsServerZoneDelegation</span> -Name <span style=color:teal>$ParentZone</span> -ChildZoneName <span style=color:teal>$ChildZone</span> -IPAddress <span style=color:teal>$IPv4Address</span> -NameServer <span style=color:teal>$AdcShortname</span> -PassThru -Verbose
</span></span><span style=display:flex><span><span style=color:#0086b3>Add-DnsServerZoneDelegation</span> -Name <span style=color:teal>$ParentZone</span> -ChildZoneName <span style=color:teal>$ChildZone</span> -IPAddress <span style=color:teal>$IPv6Address</span> -NameServer <span style=color:teal>$AdcShortname</span> -PassThru -Verbose
</span></span></code></pre></td></tr></table></div></div><p>The delegation records now exist that will help your clients find your AD domain to join it. Now, using your <code>ad\administrator</code> credentials, you can join your new domain on each of your core installs through powershell:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#0086b3>Add-Computer</span> <span style=color:#a61717;background-color:#e3d2d2>–</span>DomainName <span style=color:#d14>&#39;ad.lab.test&#39;</span> -restart <span style=color:#a61717;background-color:#e3d2d2>–</span>force
</span></span></code></pre></td></tr></table></div></div><p>After joining, you will be able to use your <code>ad\administrator</code> credentials to sign into any of your machines. If you don&rsquo;t already have the RSAT tools installed on your windows 10 workstation, you&rsquo;ll want to get that done before proceeding.</p><h2 id=administrating-a-domain-joined-dhcp-server>Administrating a domain-joined DHCP server</h2><p>Now, log into your windows 10 workstation using the <code>ad\administrator</code> credentials. You&rsquo;ll be able to use the dns console to connect over to the DNS servers and look through your zones. Next, open the dhcp console and let&rsquo;s take a quick look at the state of the DHCP service.</p><p><div class=image><figure><a href=image-6.png target=_blank><img src=image-6.png alt="The DHCP console showing the IPv4 and IPv6 in a disabled state"></a><figcaption>Oh dear. That doesn't look happy.</figcaption></figure></div></p><p>Windows DHCP servers that are NOT in a domain operate normally. Windows DHCP servers that are or have become joined to a domain do not operate until they have been <strong>authorized</strong>. Right click on the server name and authorize the server to allow it to continue to provide DHCP service.</p><p><div class=image><figure><a href=image-7.png target=_blank><img src=image-7.png alt="Authorizing a DHCP server"></a><figcaption>Authorizing a DHCP server</figcaption></figure></div></p><p>After you have authorized the DHCP server to continue, refreshing will show that the DHCP server is now returned to service. If you expand the IPv4 and IPv6 nodes, you&rsquo;ll see the scopes we created earlier through powershell. given that everything in your lab so far should have a static address at the moment, you aren&rsquo;t likely to see any leases.</p><h2 id=user-management>User Management</h2><p>You can use the &ldquo;Active Directory Users and Computers&rdquo; or &ldquo;Active Directory Administrative Center&rdquo; to create users inside your domain. Once the accounts are created, you&rsquo;ll be able to use any account you create to sign into your workstation and try out what you can do with a regular domain account vs. your <code>ad\administrator</code> account.</p><p>There are a number of security experts around that can give you a better run down of basic Active Directory security, but generally speaking you&rsquo;ll want to do your day-to-day activity as an account with <strong>no special privileges</strong>, and have a separate account that has privileges on workstations, servers, and domain controllers. Some companies mandate that you have one workstation admin account, one server admin account, and one domain administrator account.</p><h2 id=summary>Summary</h2><p>Now you have a workstation with all of the admin tools installed, dns and dhcp services, and a central identity server. You can look around under the Windows Administrative Tools folder on the start menu to see what else is possible.</p><p>Thanks for reading, and I hope you find it useful.</p><img src=/authors/aaron/avatar.png alt="Photo of Aaron Glenn"><br><strong>Aaron Glenn</strong>
<em>Admin/Mentor</em><div><a href=https://www.linkedin.com/in/aaron-g-961b5359><img src=/img/social/linkedin.png></a></div><p>Aaron is a Sr. Systems Administrator from Tulsa, specializing in Microsoft technologies, with an emphasis on powershell.</p><hr></div><comments id=comments><script src=https://utteranc.es/client.js repo=SysManSquad/sysmansquadblog issue-term=title label="blog comment" theme=github-light crossorigin=anonymous async></script></comments></article></div></div></div><footer id=footer><div class=container><div id=footer-copyright><p class=copyright>&copy; 2022 WinAdmins - https://sysmansquad.com - Systems Management Squad</a></p></div></div></footer></div></body></html>