<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=keyword content="ConfigMgr Microsoft Intune Windows WinAdmins">
<meta name=viewport content="width=device-width">
<meta name=description content="A community blog and subsidiary of WinAdmins.io">
<link rel="shortcut icon" href=/img/favicon.ico>
<title>ARM (Azure Resource Manager) Templating for Windows Virtual Desktop-SysManSquad | Systems Management Squad</title>
<link rel=canonical href=/2020/05/26/arm-azure-resource-manager-templating-for-windows-virtual-desktop/>
<link rel=stylesheet href=/css/style.css>
<link rel=stylesheet href=https://www.sysmansquad.com/css/custom.css>
<script src=https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js></script>
<script src=https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js></script>
<script src=https://www.sysmansquad.com/js/jquery.slicknav.js></script>
<script src=https://www.sysmansquad.com/js/asd_SlickNav_Mobile.js></script>
<script src=https://www.sysmansquad.com/js/custom.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZR1RSQYX"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-XXZR1RSQYX',{anonymize_ip:!1})}</script>
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://www.sysmansquad.com/83">
<meta name=twitter:title content="ARM (Azure Resource Manager) Templating for Windows Virtual Desktop">
<meta name=twitter:description content="Why would I use ARM templating, isn&rsquo;t the default Image Gallery fine? Well first off, what is ARM Templating? According to Microsoft &ldquo;You can automate deployments and use the practice of infrastructure as code. In code, you define the infrastructure that needs to be deployed. The infrastructure code becomes part of your project. Just like application code, you store the infrastructure code in a source repository and version it&mldr; &rdquo;">
</head>
<body class="home blog">
<div id=asd-container>
<div id=top-bar>
<div class=container>
<div id=nav-wrapper>
<ul class=menu id=menu-top-menu>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/>Home</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/about/>
<span>About</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=https://github.com/SysManSquad>
<span>GitHub</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/jointhesquad/>
<span>Join the Squad</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/meetthesquad/>
<span>Meet the Squad</span>
</a>
</li>
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=#>
<span>MORE></span>
</a>
<ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home">
<a href=/contact/>Contact</a>
</li>
</ul>
</li>
</ul>
</div>
<div id=top-search>
<a href=# class=search><i class="fa fa-search"></i></a>
<div class=show-search>
<form role=search method=get action=https://www.google.com/search id=searchform>
<input type=search placeholder="Search and hit enter..." name=q id=q title="Search and hit enter...">
<input type=hidden name=sitesearch value=https://www.sysmansquad.com>
<button type=submit value=Search>
</form>
</div>
</div>
<div class=menu id=menu-mobile></div>
</div>
</div>
<header id=header class=noslider>
<div class=container>
<div id=logo>
<h1><a href=https://www.sysmansquad.com><img src=/img/SysManSquad-HorizontalColor-Logo.png alt="Systems Management Squad"></a></h1>
</div>
</div>
</header>
<div class=container>
<div id=content>
<div id=main class=fullwidth>
<article class="post type-post status-publish format-standard has-post-thumbnail hentry">
<div class=post-header>
<h1>ARM (Azure Resource Manager) Templating for Windows Virtual Desktop</h1>
<span class=post-date>May 26, 2020</span>
</div>
<div class=post-entry>
<h3 id=why-would-i-use-arm-templating-isnt-the-default-image-gallery-fine>Why would I use ARM templating, isn&rsquo;t the default Image Gallery fine?</h3>
<p>Well first off, what is ARM Templating? According to Microsoft &ldquo;<em>You can automate deployments and use the practice of infrastructure as code. In code, you define the infrastructure that needs to be deployed. The infrastructure code becomes part of your project. Just like application code, you store the infrastructure code in a source repository and version it&mldr;</em> &rdquo;</p>
<p>What does all that mean? You can go through the manual creation process of a resource, then at the end you have an option to create an ARM template based on all the settings you picked. You can then use this template to deploy the exact same resource in the future with the same settings. (Don&rsquo;t worry we can make it more dynamic and less rigid).</p>
<p>If you want zero customization aside from potential Group Policy, and all your applications will work with MSIX app attach, then the default Windows 10 multi-user image potentially is just fine for your needs!</p>
<h3 id=my-original-goal>My original goal</h3>
<p>I have an absolutely <strong>horrible</strong> java based application we have to support for a customer. The installation consists of downloading 5 files (10GB total) from an FTP site and running two installation files with very specific commands and the removal of a line in a properties file (HTTP port so that it can be used in multi-user mode). That all doesn&rsquo;t sound so horrible right? Well did I mention the update process involves uninstalling the program and doing it all over again, every two weeks none the less?</p>
<p>Well I don&rsquo;t know about you - but creating a new azure VM, downloading the data files, installing the app, setting my customization options, and generalizing the image would take about 2-3 hours of manual work. So I did what any sane person would do, and figured out how to automate it!</p>
<p>This automation process involves using an ARM Template that deploys a new VM, installs &ldquo;Horrible Java app&rdquo;, sets registry settings, and turns the VM into an image we can use for WVD deployments and then deletes the VM so all you&rsquo;re left with is a ready-to-go image that costs pennies to store!</p>
<h3 id=lets-get-cracking>Lets get cracking</h3>
<p>Before we start, I&rsquo;d like to suggest you do this in a lab and not production (like I did), and before you ask - this is, in essence, build and capture. Yes I know it&rsquo;s 2020 but sadly this is the reality we live in.</p>
<p>We are going to have to create a few <strong>resource groups</strong>, a <strong>key vault</strong>, and a <strong>storage account</strong> to store all our info. (I should mention this is going to be a good old step by step with explanations on things scattered throughout)</p>
<h3 id=creating-our-resource-groups-key-vault-and-storage-account>Creating our resource groups, key vault, and storage account</h3>
<p>We are going to open Powershell as an Admin and install the required module to connect to Azure. Then we&rsquo;ll create a few resource groups to store our images, our secure passwords in a keyvault, and a storage account for our powershell scripts and other items we may need. Feel free to change the names and location as you see fit (Remember to keep location the same throughout).</p>
<p>After the last line you should see some output, you&rsquo;ll want to copy the value called <em>keyVaultId</em> for later, it should look similar to this:</p>
<h3 id=adding-files-to-our-storage-account>Adding files to our storage account</h3>
<p>You might be wondering what we need a storage account for. We are going to be storing our powershell scripts in a secure fashion so they can be accessed during our deployment and we do that via a <strong>SAS token</strong>.</p>
<p>At this point you&rsquo;ll want to have your powershell scripts that you want to execute ready. You will need at least two, the first one is specifically for installing the modules you&rsquo;ll need. Why can&rsquo;t you just put it all into one script you might ask? During the process the machine will parse your entire script and verify it has all the resources and even though your first line has Install-Module &ldquo;somemodule&rdquo; it&rsquo;ll see farther down your script you have Something-somemodule &ldquo;Do something&rdquo; and say that it won&rsquo;t execute and fail.</p>
<p>Below is an example of the module install script I have.</p>
<p>./config.ps1</p>
<p>The next script is an example of my configuration script.</p>
<p>}
catch {
$ErrorMessage = $<em>.Exception.Message | Out-File -FilePath .\ErrorMessage.txt -NoClobber
$FailedItem = $</em>.Exception.ItemName | Out-File -FilePath .\FailedItem.txt -NoClobber
}
finally {
Write-Host &ldquo;Success?&rdquo;
}
#This will sysprep the machine, make sure it&rsquo;s the last step
Start-Process -FilePath C:\Windows\System32\Sysprep\Sysprep.exe -ArgumentList &lsquo;/generalize /oobe /quiet /quit&rsquo; -Wait
Stop-Computer -ComputerName localhost -Force</p>
<h3 id=using-the-storage-account>Using the storage account</h3>
<p>Now that our two scripts are ready lets upload them! Navigate to the resource group we created earlier in this case &ldquo;Contoso-Key-Storage&rdquo;</p>
<ol>
<li>Select the storage account</li>
<li>Select <strong>Containers</strong><br>
****</li>
<li>Select <strong>+ Container</strong></li>
<li>Give your Container a name</li>
<li>Leave Public access as Private</li>
<li>Select <strong>Create</strong></li>
<li>Go into your new container</li>
<li>Select <strong>Upload</strong></li>
<li>Select your two script files</li>
<li>Select <strong>Upload</strong></li>
<li>Select the first file you uploaded</li>
<li>Select <strong>Generate SAS</strong></li>
<li>For testing purposes I set an Expiry date a year from the current date</li>
<li>Select <strong>Generate SAS token and URL</strong></li>
<li><strong>Blob SAS URL</strong> will appear below, copy this for later</li>
<li>Repeat starting from Step 11 on the other file and any other files you might need such as FSLogix install exe</li>
</ol>
<h3 id=creating-our-arm-template>Creating our ARM Template</h3>
<ol>
<li>Login to <a href=https://portal.azure.com/>https://portal.azure.com/</a></li>
<li>Select a desired resource group or create a new one (Note nothing will actually get created in the group)</li>
<li>Select <strong>Add</strong></li>
<li>Type in &ldquo;<strong>Windows 10</strong>&rdquo; and select <strong>Microsoft Windows 10 + Office 365 ProPlus</strong></li>
<li>Select <strong>Create</strong></li>
<li>Add a <strong>Virtual Machine Name</strong></li>
<li>Change <strong>size</strong> to desired VM (I recommend <strong>Standard B2ms</strong>)</li>
<li>Add <strong>Username, Password, Confirm Password</strong></li>
<li>Change &ldquo;Already have a Windows 10 Enterprise E3/E5 license or Window Virtual Desktop license?&rdquo; to <strong>Yes</strong></li>
<li>Tick off the checkbox that appears</li>
<li>Select <strong>Next : Disks ></strong></li>
<li>Select <strong>Next : Networking ></strong></li>
<li>This section can be adjusted as you see fit. I apply a Network Security Group but it&rsquo;s not necessary</li>
<li>Select <strong>Next : Management ></strong></li>
<li>Change Boot Diagnostics to <strong>Off</strong></li>
<li>Select <strong>Review + Create</strong></li>
<li>Select <strong>Download a template for automation</strong></li>
<li>Select <strong>Download</strong> in the top left</li>
</ol>
<p>You should now have a template.zip with two files named parameters.json and tempalte.json you will want to extract these to a folder and open them both with a text editor. I recommend Visual Studio Code.</p>
<h3 id=editing-the-template-and-adding-powershell-functionality>Editing the template and adding PowerShell functionality</h3>
<p>Now we are going to add all the extras to this template that let us dynamically change values and run powershell scripts from our storage account as well as pull our password from keyvault.</p>
<ol>
<li>Open both parameters.json and template.json</li>
<li>In parameters.json change the &ldquo;adminPassword&rdquo; from<br>
&ldquo;adminPassword&rdquo;: {            &ldquo;value&rdquo;: null        }<br>
to<br>
&ldquo;adminPassword&rdquo;: {&lt;br>&ldquo;reference&rdquo;: {&lt;br>&ldquo;keyVault&rdquo;: {&lt;br>&ldquo;id&rdquo;: &ldquo;THE KEYVAULTID ID YOU COPIED EARLIER&rdquo;&lt;br>},&lt;br>&ldquo;secretName&rdquo;: &ldquo;vmAdminPassword&rdquo;&lt;br>}</li>
<li>Change the id to the KeyVaultID you copied earlier</li>
<li>The rest of parameters.json can be left as is, you can override these values later in our execution script if desired</li>
<li>Open template.json</li>
<li>Do a search for <strong>enableAutomaticUpdates</strong> change the value to <strong>false</strong><br>
<code>"enableAutomaticUpdates":&amp;nbsp;false,</code></li>
<li>A few lines down you will see <code>"licenseType":&amp;nbsp;"Windows_Client"&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;</code><br>
<code>}</code><br>
add the following after (Make sure it&rsquo;s after the bracket)</li>
</ol>
<p>You will notice under fileUris we have two URLTOCHANGELATER items on lines 17 and 18, we are going to change that to the two SAS token URLs you copied earlier. You can add more URLs with a comma for things like the FSLogix installation exe. On line 20 you will want to change the -File to match the name of your moduleinstall script.</p>
<p>So what exactly does adding those URLs do? Well they download the files from the respective URL. In this case we are downloading the moduleInstall.ps1 and config.ps1. After that we are executing a command to run moduleInstall.ps1.</p>
<h3 id=lets-recap>Lets recap</h3>
<p>I want you to take a deep breathe as you&rsquo;ve done a lot so far.</p>
<p>You created a few resource groups, a key vault, storage account, an ARM template file, and two powershell scripts and that&rsquo;s awesome!</p>
<h3 id=making-the-magic-happen>Making the magic happen</h3>
<p>Below I will be posting the script I use to make the magic happen. It will connect to azure, ask you for an image name, the destination resourcegroup which in this case is &ldquo;Contoso-MyImages&rdquo; if you&rsquo;ve copied word for word. The script creates a temporary resource group, creates our VM, converts it to an image, and cleans up the temporary resource group which includes our VM. The result is a new Image located in Contoso-MyImages. You can then use this image to create a WVD Host Pool.</p>
<p>This can be changed to meet your preferences. You&rsquo;ll notice on lines 16-18 I specified a virtualMachineName, networkInferfaceName, publicIpAddressName, all three of these items have a default, and can be found in our parameters.json - however by defining them in our script I&rsquo;m overwriting the default values to give us a bit more flexibility.</p>
<p>$vm = Get-AzVM -ResourceGroupName $resourceGroupName
Stop-AzVM -ResourceGroupName $resourceGroupName -Name $vm.name -Force
Set-AzVM -ResourceGroupName $resourceGroupName -Name $vm.name -Generalized
$image = New-AzImageConfig -Location $location -SourceVirtualMachineId $vm.Id
New-AzImage -Image $image -ImageName $imagename -ResourceGroupName $imageLocation</p>
<p>Get-AzResourceGroup -Name $resourceGroupName | Remove-AzResourceGroup -Force</p>
<p>Resources:<br>
<a href=https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/template-tutorial-use-key-vault>https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/template-tutorial-use-key-vault</a><br>
<a href="https://docs.microsoft.com/en-us/azure/storage/common/storage-account-create?tabs=azure-powershell">https://docs.microsoft.com/en-us/azure/storage/common/storage-account-create?tabs=azure-powershell</a><br>
<a href=https://docs.microsoft.com/en-us/fslogix/install-ht>https://docs.microsoft.com/en-us/fslogix/install-ht</a></p>
</div>
<comments id=comments>
<script src=https://utteranc.es/client.js repo=SysManSquad/sysmansquadblog issue-term=title label="blog comment" theme=github-light crossorigin=anonymous async></script>
</comments>
</article>
</div>
</div>
</div>
<footer id=footer>
<div class=container>
<div id=footer-copyright>
<p class=copyright>&copy; 2021 WinAdmins - https://www.sysmansquad.com - Systems Management Squad</a></p>
</div>
</div>
</footer>
</div>
</body>
</html>