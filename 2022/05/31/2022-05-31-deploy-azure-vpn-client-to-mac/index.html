<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=keyword content="ConfigMgr Microsoft Intune Windows WinAdmins"><meta name=viewport content="width=device-width"><meta name=description content="A community blog and subsidiary of WinAdmins.io"><link rel="shortcut icon" href=/img/favicon.ico><title>Deploy Azure VPN Client to Mac-SysManSquad | Systems Management Squad</title><link rel=canonical href=/2022/05/31/2022-05-31-deploy-azure-vpn-client-to-mac/><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://sysmansquad.com/css/custom.css><script src=https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js></script>
<script src=https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js></script>
<script src=https://sysmansquad.com/js/jquery.slicknav.js></script>
<script src=https://sysmansquad.com/js/asd_SlickNav_Mobile.js></script>
<script src=https://sysmansquad.com/js/custom.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZR1RSQYX"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XXZR1RSQYX",{anonymize_ip:!1})}</script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sysmansquad.com/83"><meta name=twitter:title content="Deploy Azure VPN Client to Mac"><meta name=twitter:description content="App deployment for any computer, Windows or Mac, can be challenging. Widely used apps like Google Chrome are well-developed with options to automate and configure using scripts, MDM config profiles, or even back one-liner terminal commands.
When you encounter an app that has little-to-no documented parameters or configurations, it can be frustrating. I choose to look at it as a challenge. Using any tools or ideas available, it’s easy for me to become engrossed in finding an automatable solution."></head><body class="home blog"><div id=asd-container><div id=top-bar><div class=container><div id=nav-wrapper><ul class=menu id=menu-top-menu><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/>Home</a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/about/><span>About</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=https://github.com/SysManSquad><span>GitHub</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/jointhesquad/><span>Join the Squad</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/meetthesquad/><span>Meet the Squad</span></a></li><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=#><span>MORE></span></a><ul class="sub-menu menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home"><a href=/contact/>Contact</a></li></ul></li></ul></div><div id=top-search><a href=# class=search><i class="fa fa-search"></i></a><div class=show-search><form role=search method=get action=https://www.google.com/search id=searchform><input type=search placeholder="Search and hit enter..." name=q id=q title="Search and hit enter...">
<input type=hidden name=sitesearch value=https://sysmansquad.com>
<button type=submit value=Search class=searchbutton></form></div></div><div class=menu id=menu-mobile></div></div></div><header id=header class=noslider><div class=container><div id=logo><h1><a href=https://sysmansquad.com><img src=/img/SysManSquad-HorizontalColor-Logo.png alt="Systems Management Squad"></a></h1></div></div></header><div class=container><div id=content><div id=main class=fullwidth><article class="post type-post status-publish format-standard has-post-thumbnail hentry"><div class=post-header><h1>Deploy Azure VPN Client to Mac</h1><p class=p-meta><span class=post-author><a href=/authors/nic>Nic Wendlowsky</a> /</span>
<span class=post-date>November 22, 2021</span>
<span class=post-categories>/ Endpoint Management</span>
<span class=post-categories>/ Scripting</span></p></div><div class=post-entry><p>App deployment for any computer, Windows or Mac, can be challenging. Widely used apps like Google Chrome are well-developed with options to automate and configure using scripts, MDM config profiles, or even back one-liner terminal commands.</p><p>When you encounter an app that has little-to-no documented parameters or configurations, it can be frustrating. I choose to look at it as a challenge. Using any tools or ideas available, it’s easy for me to become engrossed in finding an automatable solution.</p><p>Enter Azure VPN Client for macOS.</p><h2 id=azure-vpn-client-for-mac>Azure VPN Client for Mac</h2><p>We recently had a requirement to quickly switch our VPN client and the easiest option to setup was an Azure VPN Gateway for Point-to-Site (P2S) connections. Once the gateway was built and tested, it was my turn to automated it for deployment via our MDM, Mosyle. This process should be easily incorporated into any modern MDM (like Jamf, Kandji, Addigy, JumpCloud) that can deploy scripts or custom PKGs.</p><p>Diving in to Microsoft’s documentation, they make it pretty clear that when using the Azure VPN connection with Azure AD Authentication that only Windows devices enrolled in Intune can use the configuration without the Azure VPN Client app:</p><blockquote><p>Azure AD authentication is supported only for OpenVPN® protocol connections and requires the Azure VPN Client.</p><p><a href=https://docs.microsoft.com/en-us/azure/vpn-gateway/openvpn-azure-ad-client-mac>Configure an Azure VPN Client – Azure AD authentication – macOS</a></p></blockquote><p>Additionally, this little note was quite disconcerting:</p><p><div class=image><figure><a href=image-15-1024x336.png target=_blank><img src=image-15-1024x336.png alt=Screenshot></a></figure></div></p><p>Reading that, it’s clear that Microsoft did not develop a method for mass deployment of the VPN configuration to users, so I was in for a challenge.</p><h2 id=guess-and-check>Guess and Check</h2><p>I really hope I’m not the only one, but when I encounter situations like this with limited-to-no documentation or outright statements saying automation isn’t supported, I go straight for the guess-and-check model.</p><p>Given my relative inexperience with the more in-depth macOS concepts, I assumed the only way to configure the VPN settings would be an undocumented <code>.plist</code> (similar to a .config or .ini file with some Windows apps). I hunted around in the usual locations:</p><ul><li><code>/Library/Preferences</code></li><li><code>~/Library/Preferences (/Users/$userName/Library/Preferences)</code></li></ul><p>No such luck. There were no <code>.plist</code> files for anything Azure VPN related. But I was not out of options.</p><h2 id=possible-solution>Possible Solution</h2><p>My coworker, <a href=https://twitter.com/dustinmcn>Dustin</a>, found that Azure VPN Client modifies, but stores, the XML config file!</p><ul><li><code>~/Library/Containers/com.microsoft.AzureVpnMac/Data/Library/Application Support/com.microsoft.AzureVpnMac/</code></li></ul><p><div class=image><figure><a href=image-16-1024x440.png target=_blank><img src=image-16-1024x440.png alt=Screenshot></a></figure></div></p><p>By poking around with <code>grep -r</code> he found a log file for the client (<code>~/Library/Group Containers/UBF8T346G9.group.com.microsoft.AzureVpnMac.shared/LogFiles/AzureVpnClient.log</code>) which led to the folder where the XML is stored:</p><p><code>~/Library/Containers/com.microsoft.AzureVpnMac/Data/Library/Application Support/com.microsoft.AzureVpnMac/</code></p><h2 id=testing-it-out>Testing It Out</h2><p>Starting with a clean slate, I installed the <a href="https://apps.apple.com/us/app/azure-vpn-client/id1553936137?mt=12">Azure VPN Client</a> to a test machine using Mosyle MDM.</p><p>Before launching the app, I checked to see if the folder Dustin found was created upon install, but it wasn’t. Next, I launched the App and the folder was created. So I can either pre-create the folder at install or launch the app and allow it to create the folder.</p><p>Being a novice with Bash and POSIX-anything, I started with a simple <code>mkdir ~/Library/Containers/com.microsoft.AzureVpnMac/Data/Library/Application Support/com.microsoft.AzureVpnMac/</code>, copied the XML manually to that folder, then launched Azure VPN Client. No profile showed up. I assume it’s a permission issue, so again with Dustin’s help, checked folder permissions and found nothing unusual (<code>ls -l $folder</code>), but did discover special attributes (<code>xattr -l $folder</code>):</p><p><div class=image><figure><a href=image-17-1024x130.png target=_blank><img src=image-17-1024x130.png alt=Screenshot></a></figure></div></p><p>Unfortunately, pre-creating the folder with matching permissions and custom <code>xattr</code> still didn’t work.</p><p>Some quick Googling brought me to this <a href=https://scriptingosx.com/2020/08/running-a-command-as-another-user/>Scripting OSX article for executing commands as the logged-on user</a>. We can now use the <code>open</code> command in that function and briefly launch the app, hide it, and then kill it:</p><p><div class=image><figure><a href=image-18-1024x180.png target=_blank><img src=image-18-1024x180.png alt=Screenshot></a></figure></div></p><p>A few quick tests shows that this works!</p><p>The last step I wanted is for the script to be self-contained to avoid needing a separate file uploaded or packaged. To accomplish that, we use a combination of <code>cat</code> with a here-string to echo the contents of the VPN config .xml file into a variable so it can be written to the destination folder:</p><p><div class=image><figure><a href=image-19-1024x211.png target=_blank><img src=image-19-1024x211.png alt=Screenshot></a></figure></div></p><p>Now to put it all together.</p><h2 id=assembling-the-script>Assembling the Script</h2><p>Borrowing some nifty logging functions from Brock Walters (<a href=https://www.linkedin.com/in/brock-walters-247a2990>LinkedIn</a> or <a href=https://community.jamf.com/t5/user/viewprofilepage/user-id/46638>JamfNation</a>), I put together a script that does several things:</p><ol><li>Logs the script actions</li><li>Echos the log actions to the pipeline<ol><li>This is specific to my MDM, Mosyle, which captures the output to the console for easy remote troubleshooting.</li></ol></li><li>Holds .xml file contents in the script itself</li><li>Check that Azure VPN Client is installed</li><li>Check that the folder is created when launching the client</li><li>Remove any previous profiles in the folder</li><li>Write the file to the folder</li></ol><p><a href=https://github.com/hkystar35/MDM/blob/main/Apple/Scripts/Set-AzVpnConfig.sh>Azure VPN Client configuration script | @hykstar35</a></p><p>It’s entirely possible to package this up in a PKG, though I don’t know that I’d advise that since Microsoft only officially publishes the Mac app in the App Store, meaning installs and updates are handled there but require either an Apple ID signed into each Mac or the app pushed from your MDM via Apple Business Manager’s VPP token connection.</p><h2 id=conclusion>Conclusion</h2><p>We’ve all been asked to automate, script, or do things that initially seem impossible or impractical, but it’s important try. Not just because your boss asks you to, but to continue to hone and build your skills and further your career prospects. If you also remember to Under Promise and Over Deliver, you’re more likely to benefit when it comes to performance reviews, bonuses, or even new job opportunities.</p><img src=/authors/nic/avatar.png alt="Photo of Nic Wendlowsky"><br><strong>Nic Wendlowsky</strong>
<em>Contributor</em><div><a href=https://twitter.com/wendlowsky><img src=/img/social/twitter.png></a>
<a href=https://www.linkedin.com/in/nic-wendlowsky><img src=/img/social/linkedin.png></a></div><p>Nic is an IT professional of 12+ years, specializing in ConfigMgr over the last 5 with an MCTS for ConfigMgr 2012r2.</p><hr></div><comments id=comments><script src=https://utteranc.es/client.js repo=SysManSquad/sysmansquadblog issue-term=title label="blog comment" theme=github-light crossorigin=anonymous async></script></comments></article></div></div></div><footer id=footer><div class=container><div id=footer-copyright><p class=copyright>&copy; 2022 WinAdmins - https://sysmansquad.com - Systems Management Squad</a></p></div></div></footer></div></body></html>